<!DOCTYPE html>
<!-- saved from url=(0054)http://blog.shangsw.com/archives/concurrenthashmaphtml -->
<html lang="zh-CN" data-mode="light" class="" foxified=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>14、ConcurrentHashMap核心源码解析</title>







<meta name="renderer" content="webkit">
 <meta name="format-detection" content="email=no">
<meta name="format-detection" content="telephone=no">

<meta http-equiv="Cache-Control" content="no-siteapp">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, shrink-to-fit=no, viewport-fit=cover">
<meta name="keywords" content="ConcurrentHashMap,ConcurrentHashMap原理,ConcurrentHashMap源码分析,ConcurrentHashMap源码">
<meta name="description" content="">
<meta name="author" content="林雷">
<meta http-equiv="x-dns-prefetch-control" content="on">
<meta name="site" content="http://blog.shangsw.com">
<!-- OG -->
<meta property="og:image" content="/upload/2022/05/6.jpg">
<meta property="og:description" content="">
<meta property="og:type" content="website">
<meta property="og:locale" content="zh_CN">
<meta property="og:site_name" content="林雷笔记">
<meta property="og:url" content="http://blog.shangsw.com">
<meta property="og:title" content="14、ConcurrentHashMap核心源码解析 – 林雷笔记">
<meta property="twitter:partner" content="ogwp">
<!-- /OG -->  <link rel="shortcut icon" size="32x32" href="http://blog.shangsw.com/upload/2022/05/6.jpg">
  <link rel="canonical" href="http://blog.shangsw.com/">
  <link rel="apple-touch-icon" sizes="180x180" href="http://blog.shangsw.com/upload/2022/05/6.jpg">
<style type="text/css">
  @font-face {
    font-family: "Joe Font";
    font-weight: 400;
    font-style: normal;
    font-display: swap;
  }
  html body {
    --theme: #fb6c28;
    --scroll-bar: #c0c4cc;
    --loading-bar: var(--theme);
    --img-max-width: 100%;
    font-family: "Joe Font", "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, "sans-serif";
    --res-url: '/themes/joe2.0';
  }
  html[data-mode='dark'] body {
    --theme: #9999ff;
    --scroll-bar: #666;
    --loading-bar: var(--theme);
  }
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background: var(--scroll-bar);
  }
    html[data-mode="light"] body {
      background-image: none;
    }
    html[data-mode="dark"] body {
      background-image: none;
    }
</style>      <!-- 加载条 -->
      <link rel="stylesheet" href="./14、ConcurrentHashMap核心源码解析_files/nprogress.min.css">
      <style>
          #nprogress .bar {
            height: 3px;
            background: var(--loading-bar);
          }
          #nprogress .peg {
            display: none;
          }
      </style>
      <script src="./14、ConcurrentHashMap核心源码解析_files/nprogress.min.js.下载"></script>
  <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/css/min/normalize.min.css?v=1.0.10"> 
  <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/lib/font-awesome/css/font-awesome.min.css?v=1.0.10"> 
  <link rel="preload stylesheet" as="style" href="http://at.alicdn.com/t/font_2788564_crkap1ed9j5.css">
  <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/css/min/theme.min.css?v=1.0.10">
  <style>
    #Joe .joe_container {
      max-width: 1320px;
    }
  </style>
  <link rel="stylesheet" href="./14、ConcurrentHashMap核心源码解析_files/qmsg.css">
  <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/lib/animate/animate.min.css">
    <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/lib/prism/prism.min.css?v=1.0.10">
    <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/lib/prism/themes/prism-one-dark.css?v=1.0.10">
  <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/css/min/global.min.css?v=1.0.10">
    <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/css/min/post.min.css?v=1.0.10">
  <link rel="preload stylesheet" as="style" href="http://blog.shangsw.com/themes/joe2.0/source/css/min/responsive.min.css?v=1.0.10">
  <link rel="stylesheet" href="./14、ConcurrentHashMap核心源码解析_files/jquery.fancybox.min.css">
    <script src="./14、ConcurrentHashMap核心源码解析_files/jquery.min.js.下载"></script>
    <meta name="generator" content="Halo 1.5.2">
        <link rel="shortcut icon" type="images/x-icon" href="http://blog.shangsw.com/upload/2022/05/6.jpg">
    
        
  </head>
  <body>
    <div id="Joe">
<header class="joe_header">
  <div class="joe_header__above topInDown fixed">
    <div class="joe_container joe_header_container">
      <i class="joe-font joe-icon-caidan joe_header__above-slideicon"></i>
        <a title="林雷笔记" class="joe_header__above-logo" href="http://blog.shangsw.com/">
          <img style="border-radius:4px" src="./14、ConcurrentHashMap核心源码解析_files/7.jpg" onerror="Joe.errorImg(this)" alt="林雷笔记">
        </a>
      <nav class="joe_header__above-nav">
                <a class="item" href="http://blog.shangsw.com/" target="_self" title="首页"><i class="m-icon joe-font joe-icon-shouye"></i>首页</a>
                <div class="joe_dropdown" trigger="hover" placement="60px">
                  <div class="joe_dropdown__link">
                      <a class="item" style="cursor:default;" href="javascript:;" title="源码分析"><i class="m-icon joe-font joe-icon-huo"></i>源码分析</a>
                    <i class="joe-font joe-icon-arrow-down joe_dropdown__link-icon" style="color:var(--main)"></i>
                  </div>
                  <nav class="joe_dropdown__menu" style="top: 60px;">
                          <li>
                            <a class="item" href="http://blog.shangsw.com/categories/java-concurrent" target="_self" title="Java并发框架源码">Java并发框架源码</a>
                          </li>
                          <li>
                            <a class="item" href="http://blog.shangsw.com/categories/springboot-source" target="_self" title="SpringBoot源码">SpringBoot源码</a>
                          </li>
                          <li>
                            <a class="item" href="http://blog.shangsw.com/categories/spring-source" target="_self" title="Spring源码">Spring源码</a>
                          </li>
                          <li>
                            <a class="item" href="http://blog.shangsw.com/categories/mybatis-source" target="_self" title="MyBatis源码">MyBatis源码</a>
                          </li>
                  </nav>
                </div>
                <a class="item current" href="http://blog.shangsw.com/archives" target="_self" title="文章"><i class="m-icon joe-font joe-icon-shu"></i>文章</a>
                <a class="item" href="http://blog.shangsw.com/s/about" target="_self" title="留言板"><i class="m-icon joe-font joe-icon-reply"></i>留言板</a>
                <a class="item" href="http://blog.shangsw.com/links" target="_self" title="友链"><i class="m-icon joe-font joe-icon-faxian"></i>友链</a>
      </nav>
  <form class="joe_header__above-search" method="get" action="http://blog.shangsw.com/search">
    <input maxlength="16" autocomplete="off" placeholder="请输入关键字..." name="keyword" value="" class="input" type="text">
    <button type="submit" class="submit" aria-label="搜索按钮"><i class="joe-font joe-icon-search"></i></button>
    <span class="icon"></span>
      <nav class="result">
          <a href="http://blog.shangsw.com/archives/redblacktreehtml" title="1、红黑树的原理及实现(C++)" class="item">
            <span class="sort">1</span>
            <span class="text">1、红黑树的原理及实现(C++)</span>
          </a>
          <a href="http://blog.shangsw.com/archives/javareferencehtml" title="2、Java引用深入研究" class="item">
            <span class="sort">2</span>
            <span class="text">2、Java引用深入研究</span>
          </a>
          <a href="http://blog.shangsw.com/archives/iohtml" title="1、I/O模型" class="item">
            <span class="sort">3</span>
            <span class="text">1、I/O模型</span>
          </a>
          <a href="http://blog.shangsw.com/archives/concurrenthashmaphtml" title="14、ConcurrentHashMap核心源码解析" class="item">
            <span class="sort">4</span>
            <span class="text">14、ConcurrentHashMap核心源码解析</span>
          </a>
          <a href="http://blog.shangsw.com/archives/threadlocalhtml" title="13、ThreadLocal线程局部变量" class="item">
            <span class="sort">5</span>
            <span class="text">13、ThreadLocal线程局部变量</span>
          </a>
      </nav>
  </form>
        <i class="joe-font joe-icon-search joe_header__above-searchicon"></i>
    </div>
  </div>

  <div class="joe_header__slideout">
    <div class="joe_header__slideout-wrap">
      <img width="100%" height="150" class="joe_header__slideout-image" src="./14、ConcurrentHashMap核心源码解析_files/author_bg.jpg" onerror="Joe.errorImg(this)" alt="侧边栏壁纸">
      <div class="joe_header__slideout-author">
        <img width="50" height="50" class="avatar ls-is-cached lazyloaded" data-src="/upload/2022/05/4.jpg" src="./14、ConcurrentHashMap核心源码解析_files/4.jpg" onerror="Joe.errorImg(this)" alt="博主头像">
        <div class="info">
          <a class="link" href="http://blog.shangsw.com/" target="_blank" rel="noopener noreferrer nofollow">林雷<img class="level" src="./14、ConcurrentHashMap核心源码解析_files/level_4.svg" onerror="Joe.errorImg(this)" alt="博主等级"></a>
            <p class="motto joe_motto"> 斜月沉沉藏海雾，碣石潇湘无限路</p>
        </div>
      </div>
      <ul class="joe_header__slideout-count">
        <li class="item">
          <i class="joe-font joe-icon-riji"></i>
          <span>累计撰写 <strong>132</strong> 篇文章</span>
        </li>
        <li class="item">
          <i class="joe-font joe-icon-remen"></i>
          <span>累计创建 <strong>47</strong> 个标签</span>
        </li>
        <li class="item">
          <i class="joe-font joe-icon-message"></i>
          <span>累计收到 <strong>3</strong> 条评论</span>
        </li>
      </ul>
      <ul class="joe_header__slideout-menu panel-box">
        <li>
          <a class="link panel in" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#" rel="nofollow">
          <span>栏目</span>
          <i class="joe-font joe-icon-arrow-right"></i>
          </a>
          <ul class="slides panel-body panel-box panel-side-menu" style="display: block;">
                    <li>
                      <a class="link" href="http://blog.shangsw.com/" title="首页">首页</a>
                    </li>
                    <li>
                      <div class="link panel">
                        <a href="http://blog.shangsw.com/archives/concurrenthashmaphtml#" title="源码分析">源码分析</a>
                        <i class="joe-font joe-icon-arrow-right"></i>
                      </div>
                      <ul class="slides panel-body">
                                <li>
                                  <a class="link" href="http://blog.shangsw.com/categories/java-concurrent" title="Java并发框架源码">Java并发框架源码</a>
                                </li>
                                <li>
                                  <a class="link" href="http://blog.shangsw.com/categories/springboot-source" title="SpringBoot源码">SpringBoot源码</a>
                                </li>
                                <li>
                                  <a class="link" href="http://blog.shangsw.com/categories/spring-source" title="Spring源码">Spring源码</a>
                                </li>
                                <li>
                                  <a class="link" href="http://blog.shangsw.com/categories/mybatis-source" title="MyBatis源码">MyBatis源码</a>
                                </li>
                      </ul>
                    </li>
                    <li>
                      <a class="link current" href="http://blog.shangsw.com/archives" title="文章">文章</a>
                    </li>
                    <li>
                      <a class="link" href="http://blog.shangsw.com/s/about" title="留言板">留言板</a>
                    </li>
                    <li>
                      <a class="link" href="http://blog.shangsw.com/links" title="友链">友链</a>
                    </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>

    <div class="joe_header__searchout">
      <div class="joe_container">
        <div class="joe_header__searchout-inner">
          <form class="joe_header__above-search-mobile" method="get" action="http://blog.shangsw.com/search">
            <input maxlength="16" autocomplete="off" placeholder="请输入关键字..." name="keyword" value="" class="input" type="text">
            <button type="submit" class="submit">搜索</button>
          </form>
              <div class="title">
                <i class="joe-font joe-icon-cloud"></i>标签搜索
              </div>
              <ul class="cloud">
                  <li class="item">
                    <a style="background:#F072B6" href="http://blog.shangsw.com/tags/redblacktree" title="RedBlackTree">RedBlackTree</a>
                  </li>
                  <li class="item">
                    <a style="background:#F067B4" href="http://blog.shangsw.com/tags/%E7%BA%A2%E9%BB%91%E6%A0%91" title="红黑树">红黑树</a>
                  </li>
                  <li class="item">
                    <a style="background:#6fa3ef" href="http://blog.shangsw.com/tags/c" title="C++">C++</a>
                  </li>
                  <li class="item">
                    <a style="background:#5961F9" href="http://blog.shangsw.com/tags/epoll" title="Epoll">Epoll</a>
                  </li>
                  <li class="item">
                    <a style="background:#F55555" href="http://blog.shangsw.com/tags/poll" title="Poll">Poll</a>
                  </li>
                  <li class="item">
                    <a style="background:#32CCBC" href="http://blog.shangsw.com/tags/select" title="Select">Select</a>
                  </li>
                  <li class="item">
                    <a style="background:#EA5455" href="http://blog.shangsw.com/tags/nio" title="NIO">NIO</a>
                  </li>
                  <li class="item">
                    <a style="background:#FA742B" href="http://blog.shangsw.com/tags/%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97" title="阻塞队列">阻塞队列</a>
                  </li>
                  <li class="item">
                    <a style="background:#E96D71" href="http://blog.shangsw.com/tags/aqs" title="AQS">AQS</a>
                  </li>
                  <li class="item">
                    <a style="background:#49C628" href="http://blog.shangsw.com/tags/%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6" title="并发框架">并发框架</a>
                  </li>
                  <li class="item">
                    <a style="background:#D939CD" href="http://blog.shangsw.com/tags/%E7%A0%81%E6%B5%81" title="码流">码流</a>
                  </li>
                  <li class="item">
                    <a style="background:#28C76F" href="http://blog.shangsw.com/tags/%E5%9B%BE%E7%81%B5" title="图灵">图灵</a>
                  </li>
                  <li class="item">
                    <a style="background:#BB4E75" href="http://blog.shangsw.com/tags/mybatis%E6%BA%90%E7%A0%81" title="MyBatis源码">MyBatis源码</a>
                  </li>
                  <li class="item">
                    <a style="background:#4facfe" href="http://blog.shangsw.com/tags/mybatis" title="MyBatis">MyBatis</a>
                  </li>
                  <li class="item">
                    <a style="background:#46c47c" href="http://blog.shangsw.com/tags/springboot%E6%BA%90%E7%A0%81" title="SpringBoot源码">SpringBoot源码</a>
                  </li>
                  <li class="item">
                    <a style="background:#e8583d" href="http://blog.shangsw.com/tags/spring%E6%BA%90%E7%A0%81" title="Spring源码">Spring源码</a>
                  </li>
                  <li class="item">
                    <a style="background:#465EFB" href="http://blog.shangsw.com/tags/jdk%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90" title="JDK源码分析">JDK源码分析</a>
                  </li>
                  <li class="item">
                    <a style="background:#ff9a9e" href="http://blog.shangsw.com/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0" title="线程池">线程池</a>
                  </li>
                  <li class="item">
                    <a style="background:#F072B6" href="http://blog.shangsw.com/tags/xxl-job" title="XXL-JOB">XXL-JOB</a>
                  </li>
                  <li class="item">
                    <a style="background:#F067B4" href="http://blog.shangsw.com/tags/netty" title="Netty">Netty</a>
                  </li>
                  <li class="item">
                    <a style="background:#6fa3ef" href="http://blog.shangsw.com/tags/es" title="ES">ES</a>
                  </li>
                  <li class="item">
                    <a style="background:#5961F9" href="http://blog.shangsw.com/tags/elasticsearch" title="Elasticsearch">Elasticsearch</a>
                  </li>
                  <li class="item">
                    <a style="background:#F55555" href="http://blog.shangsw.com/tags/%E5%85%AC%E5%85%B1api" title="公共API">公共API</a>
                  </li>
                  <li class="item">
                    <a style="background:#32CCBC" href="http://blog.shangsw.com/tags/%E5%BC%80%E6%94%BEapi" title="开放API">开放API</a>
                  </li>
                  <li class="item">
                    <a style="background:#EA5455" href="http://blog.shangsw.com/tags/websocket" title="WebSocket">WebSocket</a>
                  </li>
                  <li class="item">
                    <a style="background:#FA742B" href="http://blog.shangsw.com/tags/stomp" title="STOMP">STOMP</a>
                  </li>
                  <li class="item">
                    <a style="background:#E96D71" href="http://blog.shangsw.com/tags/vpn" title="VPN">VPN</a>
                  </li>
                  <li class="item">
                    <a style="background:#49C628" href="http://blog.shangsw.com/tags/seata" title="Seata">Seata</a>
                  </li>
                  <li class="item">
                    <a style="background:#D939CD" href="http://blog.shangsw.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1" title="分布式事务">分布式事务</a>
                  </li>
                  <li class="item">
                    <a style="background:#28C76F" href="http://blog.shangsw.com/tags/haproxy" title="HAProxy">HAProxy</a>
                  </li>
                  <li class="item">
                    <a style="background:#BB4E75" href="http://blog.shangsw.com/tags/shardingsphere" title="ShardingSphere">ShardingSphere</a>
                  </li>
                  <li class="item">
                    <a style="background:#4facfe" href="http://blog.shangsw.com/tags/sharding-jdbc" title="Sharding-JDBC">Sharding-JDBC</a>
                  </li>
                  <li class="item">
                    <a style="background:#46c47c" href="http://blog.shangsw.com/tags/java8%E6%96%B0%E7%89%B9%E6%80%A7" title="Java8新特性">Java8新特性</a>
                  </li>
                  <li class="item">
                    <a style="background:#e8583d" href="http://blog.shangsw.com/tags/nginx" title="Nginx">Nginx</a>
                  </li>
                  <li class="item">
                    <a style="background:#465EFB" href="http://blog.shangsw.com/tags/kubernetes" title="Kubernetes">Kubernetes</a>
                  </li>
                  <li class="item">
                    <a style="background:#ff9a9e" href="http://blog.shangsw.com/tags/redis" title="Redis">Redis</a>
                  </li>
                  <li class="item">
                    <a style="background:#F072B6" href="http://blog.shangsw.com/tags/rocketmq" title="RocketMQ">RocketMQ</a>
                  </li>
                  <li class="item">
                    <a style="background:#F067B4" href="http://blog.shangsw.com/tags/oauth20" title="OAuth2.0">OAuth2.0</a>
                  </li>
                  <li class="item">
                    <a style="background:#6fa3ef" href="http://blog.shangsw.com/tags/shadowsocks" title="Shadowsocks">Shadowsocks</a>
                  </li>
                  <li class="item">
                    <a style="background:#5961F9" href="http://blog.shangsw.com/tags/springcloud" title="SpringCloud">SpringCloud</a>
                  </li>
                  <li class="item">
                    <a style="background:#F55555" href="http://blog.shangsw.com/tags/linux" title="Linux">Linux</a>
                  </li>
                  <li class="item">
                    <a style="background:#32CCBC" href="http://blog.shangsw.com/tags/git" title="Git">Git</a>
                  </li>
                  <li class="item">
                    <a style="background:#EA5455" href="http://blog.shangsw.com/tags/docker" title="docker">docker</a>
                  </li>
                  <li class="item">
                    <a style="background:#FA742B" href="http://blog.shangsw.com/tags/springsecurity" title="SpringSecurity">SpringSecurity</a>
                  </li>
                  <li class="item">
                    <a style="background:#E96D71" href="http://blog.shangsw.com/tags/spring" title="Spring">Spring</a>
                  </li>
                  <li class="item">
                    <a style="background:#49C628" href="http://blog.shangsw.com/tags/java" title="Java">Java</a>
                  </li>
                  <li class="item">
                    <a style="background:#D939CD" href="http://blog.shangsw.com/tags/%E6%8A%80%E6%9C%AF" title="技术">技术</a>
                  </li>
              </ul>
        </div>
      </div>
    </div>

  <div class="joe_header__toc">
    <div class="joe_header__toc-wrap">
      <div class="toc_top">
        <h3>目 录<span>CONTENT</span></h3>      
        <img width="100%" height="150" src="./14、ConcurrentHashMap核心源码解析_files/context_bg.png" onerror="Joe.errorImg(this)" alt="文章目录">
      </div>
      <div id="js-toc-mobile" class="toc"></div>
    </div>
  </div>

  <div class="joe_header__mask"></div>
</header><div class="joe_container joe_bread">
  <ul class="joe_bread__bread">
    <li class="item">
      <i class="joe-font joe-icon-shouye"></i>
      <a href="http://blog.shangsw.com/" class="link" title="首页">首页</a>
    </li>
        <li class="line">/</li>
        <li class="item">
          <a class="link" href="http://blog.shangsw.com/categories/java-concurrent" title="Java并发框架源码">Java并发框架源码</a>
        </li>
    <li class="line">/</li>
    <li class="item">正文</li>
  </ul>
</div>      <div class="joe_container joe_main_container page-post animated fadeIn">
        <div class="joe_main joe_post">
          <div class="joe_detail" data-status="PUBLISHED" data-cid="132" data-clikes="2" data-author="林雷">
              <div class="joe_detail__category">
                  <a href="http://blog.shangsw.com/categories/java-concurrent" class="item item-0" title="Java并发框架源码">Java并发框架源码</a>
              </div>
            <div class="joe_detail-wrapper">
              <h1 class="joe_detail__title txt-shadow">14、ConcurrentHashMap核心源码解析</h1>
                <div class="joe_detail__count">
                  <div class="joe_detail__count-information">
                    <img width="35" height="35" class="avatar lazyloaded" src="./14、ConcurrentHashMap核心源码解析_files/4.jpg" data-src="/upload/2022/05/4.jpg" onerror="Joe.errorImg(this)" alt="林雷">
                    <div class="meta">
                      <div class="author">
                        <a class="link" href="http://blog.shangsw.com/s/about" title="林雷">林雷</a>
                      </div>
                      <div class="item">
                        <span class="text">2023-08-01</span>
                        <span class="line">/</span>
                        <span class="text">0 评论</span>
                        <span class="line">/</span>
                        <span class="text">2 点赞</span>
                        <span class="line">/</span>
                        <span class="text">104 阅读</span>  
                        <span class="line">/</span>
                        <span class="text">30,833 字</span>
                      </div>
                    </div>
                  </div>
                  <time class="joe_detail__count-created" datetime="08/01">08/01</time>
                </div>
              <div class="joe_detail__overdue">
              </div>
              <article class="joe_detail__article animated fadeIn center-img">
                <div id="post-inner">
                    <p><span style="display: block;" data-fancybox="Joe" href="http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg"><img src="./14、ConcurrentHashMap核心源码解析_files/20190104.jpg" alt="20190104"></span></p>
<h1 id="%E4%B8%80-concurrenthashmap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" tabindex="-1">一 ConcurrentHashMap核心源码解析</h1>
<p>本文使用的是1.8版本作为源码分析的。<br>
ConcurrentHashMap是HashMap的线程安全版本的实现，与HashMap类似，ConcurrentHashMap使用了一个table来存储Node，ConcurrentHashMap同样使用记录的key的hashCode来表示index，而处理哈希冲突的方式与HashMap也是类似的。作为一个容器类，其核心的逻辑就是get和put，而数组移动（容器扩容时）也作为其安全的重要组成部分。这里我们主要介绍这三部分，而对于remove等可自行阅读。</p>
<h2 id="1.1-concurrenthashmap%E6%A6%82%E8%A7%88" tabindex="-1">1.1 ConcurrentHashMap概览</h2>
<p>ConcurrentHashMap的存储结构如下图所示：<br>
<span style="display: block;" data-fancybox="Joe" href="http://blog.shangsw.com/upload/2023/08/ConcurrentHashMap-1.1-1.png"><img src="./14、ConcurrentHashMap核心源码解析_files/ConcurrentHashMap-1.1-1.png" alt="ConcurrentHashMap-1.1-1"></span></p>
<p>ConcurrentHashMap使用数组存储Node。如果出现哈希冲突则使用链表或者红黑树方式继续存储，当链表的长度不超过8的时候则为链表，超过8则转换为红黑树，从而将查找的时间复杂度从O(N)降到了O(lgN)。而ConcurrentHashMap是怎么保证并发环境下的线程安全的，我们接下来详解。</p>
<h3 id="1.1.1-node%E5%AF%B9%E8%B1%A1" tabindex="-1">1.1.1 Node对象</h3>
<p>ConcurrentHashMap使用内部类Node存储数据的，在Node对象内部，保存了key和value，如果出现哈希冲突的话会形成链表，所以有指向自己的引用，全局变量如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">static class Node&lt;K, V&gt; implements Entry&lt;K, V&gt; {
    /** key的hash值 */
    final int hash;
    /** key */
    final K key;
    /** value, 在扩容时发生变化, 所以加上volatile保持可见性和禁止重排序 */
    volatile V val;
    /** 链表的下一个节点, 用volatile保持数组的可见性 */
    volatile Node&lt;K, V&gt; next;
}    
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>注意这里的hash变量，常态下是表示key的哈希值（哈希函数计算出的值），但是在数组移动（扩容）的时候，会存储为一个特殊的值，等后续数组移动部分介绍。<br>
Node表示存储的数据，在ConcurrentHashMap中Node有多个子类，分别在不同场景下的功能有所不同，常见的子类如下：<br>
<span style="display: block;" data-fancybox="Joe" href="http://blog.shangsw.com/upload/2023/08/ConcurrentHashMap-1.1.1-1.png"><img src="./14、ConcurrentHashMap核心源码解析_files/ConcurrentHashMap-1.1.1-1.png" alt="ConcurrentHashMap-1.1.1-1"></span></p>
<ul>
<li>Node：在没有发生哈希碰撞或者指定位置发生的哈希碰撞的元素个数少于阈值（默认为8）使用的对象存储到数组中。数据结构为链表</li>
<li>ForwardingNode：当发生数组移动时使用</li>
<li>TreeBin和TreeNode：当指定位置发生哈希碰撞的元素超过阈值（默认为8）时的对象存储到数组中。数据结构为红黑树</li>
</ul>
<p>在Node对象中有一个方法find(int, Object) ，这个方法是指定节点存在哈希碰撞时查找元素的方法，Object表示key，不同的数据结构有不同的实现。<br>
其中链表结构的<strong>Node.find(int, Object)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 遍历next查找
 * @param h key的hash值
 * @param k key
 * @return Node
 */
Node&lt;K, V&gt; find(int h, Object k) {
    Node&lt;K, V&gt; e = this;
    if (k != null) {
        do {
            K ek;
            if (e.hash == h &amp;&amp; ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek))))
                return e;
        } while ((e = e.next) != null);
    }
    return null;
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>红黑树的<strong>TreeNode.find(int, Object)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 查找节点
 * @param h key的hash值
 * @param k key
 * @return 节点
 */
Node&lt;K, V&gt; find(int h, Object k) {
    return findTreeNode(h, k, null);
}

/**
 * 查找节点。返回的是一个TreeNode(没有找到的话返回null)
 * @param h key的hash
 * @param k key
 * @param kc Class
 * @return ThreeNode
 */
final TreeNode&lt;K, V&gt; findTreeNode(int h, Object k, Class&lt;?&gt; kc) {
    if (k != null) {//key不为空才能进行查找
        TreeNode&lt;K, V&gt; p = this;//从当前开始
        do {
            int ph, dir;
            K pk;
            TreeNode&lt;K, V&gt; q;
            TreeNode&lt;K, V&gt; pl = p.left, pr = p.right;
            if ((ph = p.hash) &gt; h)//要查找的key的hash小于当前的key的hash值, 那么说明要查找的在树的左边
                p = pl;//左子树
            else if (ph &lt; h)//要查找的key的hash大于当前的key的hash值, 那么说明要查找的在树的右边
                p = pr;//右子树
            else if ((pk = p.key) == k || (pk != null &amp;&amp; k.equals(pk)))//如果key相等或者相equals的话, 则当前的节点就是要找的节点
                return p;//返回
            else if (pl == null)//左子树为null的话就遍历右子树
                p = pr;//右子树
            else if (pr == null)//右子树为空的话就遍历左子树
                p = pl;
            else if ((kc != null ||
                    (kc = comparableClassFor(k)) != null) &amp;&amp;
                    (dir = compareComparables(kc, k, pk)) != 0)
                p = (dir &lt; 0) ? pl : pr;
            else if ((q = pr.findTreeNode(h, k, kc)) != null)//递归查找, 如果找到直接返回
                return q;//直接return
            else
                p = pl;
        } while (p != null);//不为空则继续遍历, 直到遍历到树的尾节点
    }
    return null;//没有找到返回null
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>当数组移动时的ForwardingNode.find(int, Object) 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">Node&lt;K, V&gt; find(int h, Object k) {
    // loop to avoid arbitrarily deep recursion on forwarding nodes
    outer:
    for (Node&lt;K, V&gt;[] tab = nextTable; ; ) {
        Node&lt;K, V&gt; e;
        int n;
        if (k == null || tab == null || (n = tab.length) == 0 ||
                (e = tabAt(tab, (n - 1) &amp; h)) == null)
            return null;
        for (; ; ) {
            int eh;
            K ek;
            if ((eh = e.hash) == h &amp;&amp;
                    ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek))))
                return e;
            if (eh &lt; 0) {
                if (e instanceof ForwardingNode) {
                    tab = ((ForwardingNode&lt;K, V&gt;) e).nextTable;
                    continue outer;
                } else
                    return e.find(h, k);
            }
            if ((e = e.next) == null)
                return null;
        }
    }
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h3 id="1.1.2-cas%E5%92%8C%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0" tabindex="-1">1.1.2 CAS和哈希函数</h3>
<p>ConcurrentHashMap在存储元素的时候，使用CAS保证原子性，在获取元素的时候使用volatile语义来保证可见性。<br>
获取数组指定位置上元素<strong>tabAt(Node, int)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 这个方法是获取tab指定位置的元素。功能上类似: tab[i]的功能,
 * 但是这个使用了volatile, 表示可见性, 如果其他线程对tab操作了, 那么这里是可见的
 * @param tab tab数组
 * @param i 通常是(tab.length - 1) &amp; hashCode
 * @param &lt;K&gt; key
 * @param &lt;V&gt; value
 * @return Node
 */
static final &lt;K, V&gt; Node&lt;K, V&gt; tabAt(Node&lt;K, V&gt;[] tab, int i) {
    return (Node&lt;K, V&gt;) U.getObjectVolatile(tab, ((long) i &lt;&lt; ASHIFT) + ABASE);
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>这里使用<strong>Unsafe.getObjectVolatile()获取指定位置上的元素，利用的时volatile语义来保证可见性</strong>。<br>
存储元素使用<strong>casTabAt(Node, int, Node, Node)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 通过CAS算法添加tab数组中指定位置的数据
 * @param tab tab数组
 * @param i hash值
 * @param c 原始值
 * @param v value, 添加的Node数据
 * @param &lt;K&gt; key
 * @param &lt;V&gt; value
 * @return 是否添加成功
 */
static final &lt;K, V&gt; boolean casTabAt(Node&lt;K, V&gt;[] tab, int i, Node&lt;K, V&gt; c, Node&lt;K, V&gt; v) {
    return U.compareAndSwapObject(tab, ((long) i &lt;&lt; ASHIFT) + ABASE, c, v);
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>使用CAS保存元素，可以通过返回值判断是否挣用位置成功，即是否存储成功。</p>
<p>计算key的hash值<strong>spread(int)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 通过key的hashCode计算在数组中的位置
 * @param h key的hashCode
 * @return 位置
 */
static final int spread(int h) {
    return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;
}

/** 用于正常的Node.hash, 即最高位为0 对应的二进制为 01111111 11111111 11111111 11111111 */
static final int HASH_BITS = 0x7fffffff;
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h3 id="1.1.3-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0" tabindex="-1">1.1.3 构造函数</h3>
<p>ConcurrentHashMap的构造函数如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 构造器
 */
public ConcurrentHashMap() {
}

/**
 * 构造器
 * @param initialCapacity 初始化数组的大小。不能为负数
 */
public ConcurrentHashMap(int initialCapacity) {
    //校验不能为负数 Start
    if (initialCapacity &lt; 0)
        throw new IllegalArgumentException();
    //校验不能为负数 End

    int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ?
            MAXIMUM_CAPACITY :
            tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1));
    this.sizeCtl = cap;//设置值
}

/**
 * 通过已有的Map构造器一个新的Map
 * @param m 已有的map
 */
public ConcurrentHashMap(Map&lt;? extends K, ? extends V&gt; m) {
    this.sizeCtl = DEFAULT_CAPACITY;
    putAll(m);
}

/**
 * 构造器
 * @param initialCapacity 初始化大小
 * @param loadFactor 负载因子
 */
public ConcurrentHashMap(int initialCapacity, float loadFactor) {
    this(initialCapacity, loadFactor, 1);
}

/**
 * 构造器
 * @param initialCapacity 初始化大小
 * @param loadFactor 负载因子
 * @param concurrencyLevel 并发级别
 */
public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) {
    if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0)
        throw new IllegalArgumentException();
    if (initialCapacity &lt; concurrencyLevel)
        initialCapacity = concurrencyLevel;
    long size = (long) (1.0 + (long) initialCapacity / loadFactor);
    int cap = (size &gt;= (long) MAXIMUM_CAPACITY) ?
            MAXIMUM_CAPACITY : tableSizeFor((int) size);
    this.sizeCtl = cap;
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>ConcurrentHashMap的构造函数的形参可以为空，也可以传递initialCapacity、Map、loadFactory等。</p>
<ul>
<li>Map：表示将形参的Map数据都复制到当前的Map对象中，调用putAll(Map) 方法实现</li>
<li>initialCapacity：int类型的参数，表示初始的数组大小，注意，这里只是一个指示值，并不是真实的大小。在ConcurrentHashMap中数组的大小一定需要是2的幂（后续介绍原因），如果用户传递的参数非2的幂，但是会使用 tableSizeFor(int) 计算出一个值，表示2的幂。ConcurrentHashMap默认的数组大小为16。</li>
</ul>
<p>需要注意一下这里的<strong>sizeCtl值的计算，如果给定了initialCapacity大小，那么就会通过tableSizeFor(int) 方法计算出大于或等于initialCapacity值的最近的2的幂的值，并且由于存在负载因子，所以通常在tableSizeFor(init) 的基础上还会乘以2</strong>。例如现在initialCapacity的值为7，tableSizeFor(int) 计算出的结果是8，但是数组在达到指定的数值时就会扩容，这个数值设置为x，那么 x * 负载因子 = 8，x = 8 / 负载因子, 同时最终的结果需要是2的幂，所以为16。需要注意sizeCtl的初始值的问题，sizeCtl表示很多含义，后续再继续介绍。<br>
ConcurrentHashMap在构造的时候并没有初始化table数组，而是在第一次put元素的时候初始化table数组。</p>
<h2 id="1.2-get%2C-%E8%8E%B7%E5%8F%96%E5%85%83%E7%B4%A0" tabindex="-1">1.2 get, 获取元素</h2>
<p><strong>get(Object)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/** Node数组, 即hash表 */
transient volatile Node&lt;K, V&gt;[] table;

/**
 * get操作
 * @param key key
 * @return value
 */
public V get(Object key) {
    Node&lt;K, V&gt;[] tab;//table数组
    Node&lt;K, V&gt; e, p;
    int n, eh;
    K ek;
    int h = spread(key.hashCode());//计算在数组中的位置index

    if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) {//首先数组不能为空
        if ((eh = e.hash) == h) {//key的hashCode与当前要找的key的hashCode一样
            if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))//最后判断key是否相等或者相equals
                return e.val;//找到元素
        } else if (eh &lt; 0)//遍历next查找(数组正在移动)
            return (p = e.find(h, key)) != null ? p.val : null;
        while ((e = e.next) != null) {//如果当前存在next节点, 说明在put时发生了碰撞问题, 遍历链表查找
            if (e.hash == h &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))))//找到元素
                return e.val;//返回
        }
    }
    return null;//没有找到返回null
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>在获取元素时，首先通过哈希函数spread(int) 计算出key.hashCode对应的哈希值，接着通过tabAt(Node[], int) 方法得到table数组中指定位置的元素，该方法在上文中已经介绍，含有volatile语义，具有可见性；此时如果没有获取到元素，证明指定的key并没有存储，返回null；如果有元素，那么需要继续判断元素对应的哈希值，这里的哈希值有两种情况：</p>
<ul>
<li>哈希值与当前key.hashCode计算出的哈希值一样，最后判断key想等则返回对应的value</li>
<li>哈希值为负数，表示数组正在移动，通过Node.find(int, Object) 方法继续查找，而find(int, Object) 方法我们在上文中介绍过，这里表示调用的是ForwardingNode.find(int, Object)。稍后可通过存放元素的逻辑再来看此处</li>
</ul>
<p>如果条件与上述的两个分支不同，那么可能是发生了哈希碰撞，那么遍历链表查找元素。</p>
<p>从上述可以看出：</p>
<ul>
<li>获取元素时，使用tabAt(Node, int) 方法，该方法获取指定位置上的元素时具有可见性，保证了如果存在同时在该位置上存储元素时的可见性的线程安全</li>
<li>如果数组正在移动，也可以进行查找工作，会调用ForwardingNode.find(int, Object) 方法进行查找，在该方法中会遍历nextTable数组（新的数组）查找，查找的过程同样使用tabAt(Node, int) 方法，保证了安全性</li>
</ul>
<p>接下来我们可以带着几个问题阅读put(K, V) 源码：</p>
<ol>
<li>table数组是怎么初始化的，初始化过程中是怎么保证线程安全的？</li>
<li>怎么将元素存放到table数组中，存放元素的过程是怎么保证线程安全的？</li>
<li>数组移动时是怎么保证线程安全的？</li>
<li>如果出现哈希碰撞，ConcurrentHashMap是怎么解决的？</li>
</ol>
<p>带着上述的一些问题，我们详细阅读存放元素的代码。</p>
<h2 id="1.3-put%2C-%E5%AD%98%E6%94%BE%E5%85%83%E7%B4%A0" tabindex="-1">1.3 put, 存放元素</h2>
<p><strong>put(K, V)</strong> 代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * put操作
 * @param key key
 * @param value value
 * @return value
 */
public V put(K key, V value) {
    return putVal(key, value, false);
}

/**
 * put value操作
 * @param key key
 * @param value value
 * @param onlyIfAbsent 如果当前key已经存在, 是否覆盖
 * @return value
 */
final V putVal(K key, V value, boolean onlyIfAbsent) {
    //判断key和value不能为空 Start
    if (key == null || value == null) throw new NullPointerException();
    //判断key和value不能为空 End

    int hash = spread(key.hashCode());//计算key的hash值
    int binCount = 0;//用来计算在这个节点总共有多少个元素, 用来控制扩容或转移为树
    for (Node&lt;K, V&gt;[] tab = table; ; ) {//无限的for循环
        Node&lt;K, V&gt; f;
        int n, i, fh;
        if (tab == null || (n = tab.length) == 0)//Node数组为空, 初始化数组操作(第一次put操作)
            tab = initTable();//初始化数组
        else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) {//数组中没有找到, 那么直接添加即可
            if (casTabAt(tab, i, null, new Node&lt;K, V&gt;(hash, key, value, null)))//通过CAS添加, 添加成功则break; 添加失败继续循环
                break;//添加成功直接break退出循环
        } else if ((fh = f.hash) == MOVED)//如果数组正在移动中
            /*
             * 如果检测到某个节点的hash值是MOVED的话,则表示正在进行数组扩容的复制数据的阶段。
             * 则当前线程也会参与去复制, 通过允许多线程复制的功能, 增加复制的效率
             */
            tab = helpTransfer(tab, f);
        else {//如果数组中的指定位置存在值
            /*
             * 如果在这个位置有元素的话, 就采用synchronized加锁:
             * 1、如果是链表的话(hash &gt; 0), 就对这个链表的所有元素进行遍历:
             *  1.1 如果找到key和key.hash都是一样的话, 则替换
             *  1.2 如果没找到的话则添加到最后
             * 2、否则, 是树的话, 则调用putTreeVal方法添加到树中
             * 在添加完成之后, 会对该节点的数目进行判断:如果在8个以上的话, 则会调用treeifyBin方法尝试转换为树, 或者是扩容
             */
            V oldVal = null;
            //锁住节点 Start
            synchronized (f) {//锁住链表头
                if (tabAt(tab, i) == f) {
                    if (fh &gt;= 0) {//大于0表示未发生数组移动
                        binCount = 1;
                        for (Node&lt;K, V&gt; e = f; ; ++binCount) {
                            K ek;
                            //链表头与待插入的元素是一样的 Start
                            if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) {
                                oldVal = e.val;
                                if (!onlyIfAbsent)
                                    e.val = value;
                                break;
                            }
                            //链表头与待插入的元素是一样的 End

                            //链表头与待插入的元素不一样, 则发生了hash碰撞, 则放next元素放值 Start
                            Node&lt;K, V&gt; pred = e;
                            if ((e = e.next) == null) {
                                pred.next = new Node&lt;K, V&gt;(hash, key, value, null);
                                break;
                            }
                            //链表头与待插入的元素不一样, 则发生了hash碰撞, 则放next元素放值 End
                        }
                    } else if (f instanceof TreeBin) {//已经变成了红黑树, 则调用树的方法添加元素
                        Node&lt;K, V&gt; p;
                        binCount = 2;
                        if ((p = ((TreeBin&lt;K, V&gt;) f).putTreeVal(hash, key, value)) != null) {
                            oldVal = p.val;
                            if (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }
            //锁住节点 End

            //转换为红黑树 Start
            if (binCount != 0) {
                if (binCount &gt;= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                if (oldVal != null)
                    return oldVal;
                break;
            }
            //转换为红黑树 End
        }
    }
    addCount(1L, binCount);//增加计数(可能数组移动)
    return null;
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>我们一步一步看putVal(K, V, boolean) 方法的内容：</p>
<ol>
<li>通过上述的构造函数我们知道在构造函数中哈希表table并没有初始化，所以首先肯定需要确定哈希表（字段为table）是否初始化，即<em><strong>if(tab == null || (n = tab.length) == 0)</strong></em> 代码块，如果未初始化则调用 <strong>initTable()</strong> 方法初始化哈希表，然后在循环体中继续循环</li>
<li>如果没有进入步骤1，那么一定证明哈希表已经初始化了，就需要判断指定位置上（使用tabAt(Node, int) 方法，具有可见性）是否没有元素，即 <em><strong>else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null)</strong></em> 代码块；如果没有元素，那么就通过CAS将创建的Node对象存放到数组的指定位置上，CAS成功则退出循环，否则继续自旋</li>
<li>如果没有进入上述的步骤1和步骤2，证明当前数组已经初始化并且指定的位置上一定有元素，但是这个元素可能是ForwardingNode，表示数组正在移动，而如果是ForwardingNode对象，通过后续代码我们知道ForwardingNode对象中的hash是为MOVED（-1），所以会进入 <em><strong>else if ((fh = f.hash) == MOVED)</strong></em> 代码块中，也就是出现了数组移动（容器扩容）的情况，接下来就进入<strong>helpTransfer(Node[], Node)</strong>  方法，表示辅助移动数组的逻辑。</li>
<li>如果没有进入上述的三个步骤，那么就出现了数组已经初始化，并且指定位置上有元素，同时这个元素对象并不是ForwardingNode的对象，即数组没有在移动，说明出现了哈希碰撞，即 <em><strong>else {}</strong></em> 代码块。</li>
<li>最后调用<strong>addCount(long, int)</strong> 方法，表示统计容器计数以及是否需要扩容操作等</li>
</ol>
<p>接下来我们对各种情况进行具体分析。</p>
<h3 id="1.3.1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84" tabindex="-1">1.3.1 初始化数组</h3>
<p>初始化数组在方法<strong>initTable()</strong> 中：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 当第一次进行put的时候, Node数组(table)还没有初始化, 所以进行初始化操作。由于涉及到线程安全问题, 这里
 * 初始化会保证初始化过程中的线程安全问题
 * @return 初始化后的数组
 */
private final Node&lt;K, V&gt;[] initTable() {
    Node&lt;K, V&gt;[] tab;//需要初始化的数组
    int sc;
    while ((tab = table) == null || tab.length == 0) {//数组为空则一直循环, 直到数组不为空
        if ((sc = sizeCtl) &lt; 0)//如果为负数则表示有线程在初始化操作, 当前线程不做操作, 让出CPU空间
            Thread.yield(); //让出CPU时间
        else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {//不为负数, 则通过CAS将sizeCtl的值改为-1(此时sizeCtl的值为负数)
            try {
                if ((tab = table) == null || tab.length == 0) {//再判断一次数组是否为空, 为空才进行初始化
                    int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY;//数组的大小。默认大小为16
                    @SuppressWarnings("unchecked")
                    Node&lt;K, V&gt;[] nt = (Node&lt;K, V&gt;[]) new Node&lt;?, ?&gt;[n];//初始化数组
                    table = tab = nt;//赋值操作
                    sc = n - (n &gt;&gt;&gt; 2);//计算下次扩容的大小
                }
            } finally {
                sizeCtl = sc;
            }
            break;
        }
    }
    return tab;
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>结合下面流程图，我们进行详细介绍：<br>
<span style="display: block;" data-fancybox="Joe" href="http://blog.shangsw.com/upload/2023/08/ConcurrentHashMap-1.3.1-1.png"><img src="./14、ConcurrentHashMap核心源码解析_files/ConcurrentHashMap-1.3.1-1.png" alt="ConcurrentHashMap-1.3.1-1"></span></p>
<p>我们以这种情况为例进行说明，以便更好理解：现在有线程1和线程2同时调用put方法存放数据，两个线程同时进入了这个逻辑</p>
<ul>
<li>线程1和线程2都进入了循环体，因为都是第一次调用put方法，此时table数组还没有初始化，所以为空</li>
<li>线程1和线程2也都不会进入 <em><strong>if ((sc = sizeCtl) &lt; 0)</strong></em> 代码块，因为在ConcurrentHashMap构造函数中对sizeCtl指定了值（具体看上文），如果是空构造则sizeCtl为0，所以不会进入这个if代码块</li>
<li>接下来线程1和线程2同时CAS对sizeCtl的值更新为-1，那么一定只有一个线程能成功，假如我们这里线程2对sizeCtl的值更新为-1成功，而线程1更新失败。
<ul>
<li>线程2进入了 <em><strong>else if (U.compareAndSwapInt(this, SIZECTL, sc, -1))</strong></em> 代码块，在该代码块中创建table数组，并重新计算下一次sizeCtl的值，计算规则简化表示为： sizeCtl - (sizeCtl / 4)，可以理解为sizeCtl = sizeCtl * 0.75</li>
<li>线程1在循环体中循环，此时sizeCtl为-1， 所以线程1进入了 <em><strong>if ((sc = sizeCtl) &lt; 0)</strong></em> 代码块，也就是线程1让出CPU时间片，而线程1即使下一次就绪后依然是在循环体中循环进入 <em><strong>if ((sc = sizeCtl) &lt; 0)</strong></em> 代码块中，相当于线程1无法抢占锁而被阻塞了，直到while循环的条件不满足，证明table数组不为空了（线程2将其初始化成功）才退出方法。</li>
</ul>
</li>
</ul>
<p>由上述的分析，可以得知初始化的过程是线程安全的，而保证线程安全的机制是通过CAS抢占锁，但是不会进入阻塞态。</p>
<h3 id="1.3.2-%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE" tabindex="-1">1.3.2 存放数据</h3>
<p>存放数据是在 <em><strong>else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null)</strong></em> 代码块中，然后使用CAS对指定位置由null变更为Node对象，成功则退出循环，否则自旋。存放数据的逻辑通过volatile语义保证了可见性，同时使用CAS对指定位置存放数据以保证线程安全。</p>
<h3 id="1.3.3-%E5%93%88%E5%B8%8C%E7%A2%B0%E6%92%9E%E7%9A%84%E8%A7%A3%E5%86%B3%E4%B9%8B%E9%81%93" tabindex="-1">1.3.3 哈希碰撞的解决之道</h3>
<p>设计的再完美的哈希函数，都存在碰撞的可能，哈希碰撞表示两个不同的key，通过哈希函数计算出来的地址是一样的，即 key1 != key2，但是 hash(key1) = hash(key2)。哈希碰撞有多种解决方式，如开放地址法、再哈希法、链地址法等。<br>
在ConcurrentHashMap中使用链地址法，即出现了哈希碰撞后的元素使用链表继续存储。<br>
在putVal(K, V, boolean) 函数中，解决哈希碰撞的部分是在 <em><strong>else {}</strong></em> 代码块中，如下所示：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">else {//如果数组中的指定位置存在值
	/*
	 * 如果在这个位置有元素的话, 就采用synchronized加锁:
	 * 1、如果是链表的话(hash &gt; 0), 就对这个链表的所有元素进行遍历:
	 *  1.1 如果找到key和key.hash都是一样的话, 则替换
	 *  1.2 如果没找到的话则添加到最后
	 * 2、否则, 是树的话, 则调用putTreeVal方法添加到树中
	 * 在添加完成之后, 会对该节点的数目进行判断:如果在8个以上的话, 则会调用treeifyBin方法尝试转换为树, 或者是扩容
	 */
	V oldVal = null;
	//锁住节点 Start
	synchronized (f) {//锁住链表头
		if (tabAt(tab, i) == f) {
			if (fh &gt;= 0) {//大于0表示未发生数组移动
				binCount = 1;
				for (Node&lt;K, V&gt; e = f; ; ++binCount) {
					K ek;
					//链表头与待插入的元素是一样的 Start
					if (e.hash == hash &amp;&amp; ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))) {
						oldVal = e.val;
						if (!onlyIfAbsent)
							e.val = value;
						break;
					}
					//链表头与待插入的元素是一样的 End

					//链表头与待插入的元素不一样, 则发生了hash碰撞, 则放next元素放值 Start
					Node&lt;K, V&gt; pred = e;
					if ((e = e.next) == null) {
						pred.next = new Node&lt;K, V&gt;(hash, key, value, null);
						break;
					}
					//链表头与待插入的元素不一样, 则发生了hash碰撞, 则放next元素放值 End
				}
			} else if (f instanceof TreeBin) {//已经变成了红黑树, 则调用树的方法添加元素
				Node&lt;K, V&gt; p;
				binCount = 2;
				if ((p = ((TreeBin&lt;K, V&gt;) f).putTreeVal(hash, key, value)) != null) {
					oldVal = p.val;
					if (!onlyIfAbsent)
						p.val = value;
				}
			}
		}
	}
	//锁住节点 End

	//转换为红黑树 Start
	if (binCount != 0) {
		if (binCount &gt;= TREEIFY_THRESHOLD)
			treeifyBin(tab, i);
		if (oldVal != null)
			return oldVal;
		break;
	}
	//转换为红黑树 End
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>这里我们先不看 <em><strong>else if ((fh = f.hash) == MOVED)</strong></em> 代码块，先看 <em><strong>else {}</strong></em> 代码块。能进入 <em><strong>else {}</strong></em> 代码块中，说明在数组的指定位置上一定存在元素，此时使用 <em><strong>synchronized (f) {}</strong></em> 锁住链表头部或红黑树的根节点，接下来就是在链表中添加元素或者在红黑树中添加元素了，所以在链表中添加元素或者在红黑树中添加元素一定是线程安全的，这也是细颗粒的锁。<br>
这里我们需要注意一点，就是 <strong>binCount变量，如果当前是链表，那么binCount表示链表的长度；如果当前是红黑树，则该变量固定值为2</strong>。</p>
<h4 id="1.3.3.1-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E7%BA%A2%E9%BB%91%E6%A0%91" tabindex="-1">1.3.3.1 转换为红黑树</h4>
<p>在 <em><strong>else {}</strong></em> 代码块中，有这样一段代码：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">//转换为红黑树 Start
if (binCount != 0) {
	if (binCount &gt;= TREEIFY_THRESHOLD)
		treeifyBin(tab, i);
	if (oldVal != null)
		return oldVal;
	break;
}
//转换为红黑树 End

/** 链表转红黑树的阈值, 默认为8, 超过该阈值则链表转为红黑树 */
static final int TREEIFY_THRESHOLD = 8;
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>在这段代码中，当binCount 超过了 8 时，则调用<strong>treeifyBin(Node[], int)</strong> 方法将链表转换为红黑树，代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 将指定的数组指定的位置对应的链表转换为红黑树的结构
 * @param tab 数组
 * @param index 位置
 */
private final void treeifyBin(Node&lt;K, V&gt;[] tab, int index) {
    Node&lt;K, V&gt; b;
    int n, sc;
    if (tab != null) {
        if ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)
            tryPresize(n &lt;&lt; 1);
        else if ((b = tabAt(tab, index)) != null &amp;&amp; b.hash &gt;= 0) {//指定位置的元素存在并没有没法发生数组移动
            synchronized (b) {//锁住对应位置的头结点
                if (tabAt(tab, index) == b) {//锁住之后再次判断对应位置的元素未发生改变
                    TreeNode&lt;K, V&gt; hd = null, tl = null;
                    for (Node&lt;K, V&gt; e = b; e != null; e = e.next) {
                        TreeNode&lt;K, V&gt; p = new TreeNode&lt;K, V&gt;(e.hash, e.key, e.val, null, null);
                        if ((p.prev = tl) == null)
                            hd = p;
                        else
                            tl.next = p;
                        tl = p;
                    }
                    setTabAt(tab, index, new TreeBin&lt;K, V&gt;(hd));
                }
            }
        }
    }
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>在这段代码中，其实是将链表结构（Node对象）转换为红黑树（TreeNode对象）结构。</p>
<h3 id="1.3.4-%E6%95%B0%E7%BB%84%E7%A7%BB%E5%8A%A8" tabindex="-1">1.3.4 数组移动</h3>
<p>在putVal(K, V, boolean) 方法中，存在一个if分支：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">else if ((fh = f.hash) == MOVED)//如果数组正在移动中
    /*
     * 如果检测到某个节点的hash值是MOVED的话,则表示正在进行数组扩容的复制数据的阶段。
     * 则当前线程也会参与去复制, 通过允许多线程复制的功能, 增加复制的效率
     */
    tab = helpTransfer(tab, f);
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>其中helpTransfer(Node[], Node) 方法表示帮助数组移动，在其内部调用了 <strong>transfer(Node[], Node)</strong> 方法；并且在 putVal(K, V, boolean) 方法的最后调用了 addCount(long, int) 方法表示容器计数的逻辑操作，在其内部也调用了 <strong>transfer(Node[], Node)</strong> 方法，在阅读 helpTransfer(Node[], Node) 和 addCount(long, int) 方法之前我们先看transfer(Node[], Node) 方法，这样有助于更好理解helpTransfer(Node[], Node) 和 addCount(long, int) 中的内容。<br>
<strong>transfer(Node[], Node)</strong> 方法表示数组移动，因为扩容操作需要将旧数组的数据移动到新的数组中，其代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 扩容操作。逻辑相当复杂, 下面我进行以实例进行说明。我们都知道, 当数组增长到负载因子*length的时候就会触发扩容操作, 比如我现在有数组为
 * [Node,Node,Node,Node,Node,Node,null,null], 当我们插入第7个元素的时候就会触发扩容操作。以这种场景为例, 线程A和线程B同时需要插入第7个元素,
 * 并且线程A先达到当前的transfer方法为场景, 以可用CPU数为 1 颗计算。
 * 那么nextTab新创建时为如下状态:
 * [null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null], nextTab.length = 16
 * 首先我们要计算 i(原数组index位置)位置, 总体的计算过程就是从数组的末尾往前推。
 * 比如i = 7时, 得到的val是null, 那么此时就会通过CAS将i=7的位置填入ForwardingNode对象, 如果CAS失败那么一定是其他线程(如线程B)已经成功在i=7的位置
 * 存放了元素, 那么此时i不变, 再一次遍历, 发现i = 7的位置有元素并且不是ForwardingNode对象, 那么就通过{@code synchronized}将其上锁后移动到新的数组
 * nextTab中, 并且将原数组中对应的位置(i=7)设置为ForwardingNode。同时位置保持不变, 为7; 如果CAS成功, 那么就是在i=7的位置成功放入了ForwardingNode对象(其hash为{@link #MOVED}, 即-1), 就会再次继续循环
 * 并且更新i为6。
 * 依次类推, 当i为5时, 发现有元素, 同上, 通过{@code synchronized}将其上锁后移动到新的数组nextTab中, 并且将原数组中对应的位置(i=5)设置为ForwardingNode。
 * 那么当i一直递减到0时, --i就是-1, 就会进入 if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) {}这个代码块, 此时将finishing置为true, 同时将i置为原数组的长度(8),
 * 到这时, 可以理解为数组完成了第一轮循环, 此时原数组为如下:
 * [ForwardingNode,ForwardingNode,ForwardingNode,ForwardingNode,ForwardingNode,ForwardingNode,ForwardingNode,ForwardingNode]
 * 新数组为如下:
 * [null,null,null,null,null,null,null,null,Node,Node,Node,Node,Node,Node,null,null]
 * 线程A进入新一轮循环, 进入新一轮循环的目的是为了检查原数组是否有新的线程添加了未知的元素。即i=8, 但是会一直进入 else if ((fh = f.hash) == MOVED){}代码块, 即最终i会被置为
 * -1, 此时会进入if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) {}代码块,
 * 但是此时finishing为true, 所以就return出方法了。
 * 综上所述, 线程A与线程B可以同时进行, 有以下几种情况:
 * 1、线程A与线程B同时进行put, 又同时触发了扩容操作, A线程先进入当前方法, B线程会辅助扩容(前置判断请看{@link #helpTransfer(Node[], Node)}),
 * 两个线程可以同时操作数组, 因为移动会通过{@code synchronized}加锁操作, 数组位置为null的操作会通过CAS将其置为ForwardingNode, 不改变i进行下一次循环
 * 这就保证了线程A和线程B(线程C...)同时操作数组
 * 2、线程A移动数组, 线程B从数组中获取元素, 当线程A通过CAS存放元素时(如位置i=7), 线程B计算出key刚好在i=7的位置时, 那么就是hash为{@link #MOVED}的,
 * 就会进入{@link ForwardingNode#find(int, Object)}去寻找, 也就是新的数组nextTab中寻找
 * 所以说ConcurrentHashMap在数组扩容时是安全的
 * @param tab 原Node数组
 * @param nextTab 新的Node数组
 */
private final void transfer(Node&lt;K, V&gt;[] tab, Node&lt;K, V&gt;[] nextTab) {
    int n = tab.length, stride;
    if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)
        stride = MIN_TRANSFER_STRIDE;

    //如果新的数组为空的话, 则创建一个原来2倍的数组 Start
    if (nextTab == null) {
        try {
            @SuppressWarnings("unchecked")
            Node&lt;K, V&gt;[] nt = (Node&lt;K, V&gt;[]) new Node&lt;?, ?&gt;[n &lt;&lt; 1];
            nextTab = nt;
        } catch (Throwable ex) {
            sizeCtl = Integer.MAX_VALUE;
            return;
        }
        nextTable = nextTab;
        transferIndex = n;
    }
    //如果新的数组为空的话, 则创建一个原来2倍的数组 End

    int nextn = nextTab.length;//新的数组长度(为原数组的2倍)
    ForwardingNode&lt;K, V&gt; fwd = new ForwardingNode&lt;K, V&gt;(nextTab);//创建ForwardingNode节点
    boolean advance = true;
    boolean finishing = false;//是否已经迁移完成
    for (int i = 0, bound = 0; ; ) {//无限循环
        Node&lt;K, V&gt; f;
        int fh;
        /*
         * 整个while循环就是在计算i的值, 过程很复杂。i的值会从 n - 1递减, 其中n是旧的数组的长度
         */
        while (advance) {
            int nextIndex, nextBound;
            if (--i &gt;= bound || finishing)
                advance = false;
            else if ((nextIndex = transferIndex) &lt;= 0) {
                i = -1;
                advance = false;
            } else if (U.compareAndSwapInt(this, TRANSFERINDEX, nextIndex, nextBound = (nextIndex &gt; stride ? nextIndex - stride : 0))) {
                bound = nextBound;
                i = nextIndex - 1;
                advance = false;
            }
        }

        if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) {
            int sc;
            //如果遍历完成, 也就是整个map所有的捅中的元素都迁移完成了 Start
            if (finishing) {
                nextTable = null;
                table = nextTab;
                sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1);//下一次扩容的大小
                return;
            }
            //如果遍历完成, 也就是整个map所有的捅中的元素都迁移完成了 End

            if (U.compareAndSwapInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {//使用CAS对sizeCtl-1操作
                if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)//当前线程扩容完成, 把扩容线程数-1
                    return;
                finishing = advance = true;//扩容完成
                i = n;//i重新赋值为n, 这样会再重新遍历一遍数组, 看看是不是都迁移完成。
            }
        } else if ((f = tabAt(tab, i)) == null)//如果指定位置没有元素, 则直接放入ForwardingNode标记该桶已迁移
            advance = casTabAt(tab, i, null, fwd);//存放数据
        else if ((fh = f.hash) == MOVED)//如果桶中第一个元素的hash值是MOVED的话, 说明它是ForwardingNode节点, 意味着该节点已经处理过了
            advance = true;
        else {//迁移元素
            synchronized (f) {//节点加锁
                //节点复制工作
                if (tabAt(tab, i) == f) {
                    Node&lt;K, V&gt; ln, hn;
                    if (fh &gt;= 0) {
                        int runBit = fh &amp; n;
                        Node&lt;K, V&gt; lastRun = f;
                        for (Node&lt;K, V&gt; p = f.next; p != null; p = p.next) {
                            int b = p.hash &amp; n;
                            if (b != runBit) {
                                runBit = b;
                                lastRun = p;
                            }
                        }
                        if (runBit == 0) {
                            ln = lastRun;
                            hn = null;
                        } else {
                            hn = lastRun;
                            ln = null;
                        }
                        for (Node&lt;K, V&gt; p = f; p != lastRun; p = p.next) {
                            int ph = p.hash;
                            K pk = p.key;
                            V pv = p.val;
                            if ((ph &amp; n) == 0)
                                ln = new Node&lt;K, V&gt;(ph, pk, pv, ln);
                            else
                                hn = new Node&lt;K, V&gt;(ph, pk, pv, hn);
                        }
                        setTabAt(nextTab, i, ln);
                        setTabAt(nextTab, i + n, hn);
                        setTabAt(tab, i, fwd);
                        advance = true;
                    } else if (f instanceof TreeBin) {
                        TreeBin&lt;K, V&gt; t = (TreeBin&lt;K, V&gt;) f;
                        TreeNode&lt;K, V&gt; lo = null, loTail = null;
                        TreeNode&lt;K, V&gt; hi = null, hiTail = null;
                        int lc = 0, hc = 0;
                        for (Node&lt;K, V&gt; e = t.first; e != null; e = e.next) {
                            int h = e.hash;
                            TreeNode&lt;K, V&gt; p = new TreeNode&lt;K, V&gt;
                                    (h, e.key, e.val, null, null);
                            if ((h &amp; n) == 0) {
                                if ((p.prev = loTail) == null)
                                    lo = p;
                                else
                                    loTail.next = p;
                                loTail = p;
                                ++lc;
                            } else {
                                if ((p.prev = hiTail) == null)
                                    hi = p;
                                else
                                    hiTail.next = p;
                                hiTail = p;
                                ++hc;
                            }
                        }
                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :
                                (hc != 0) ? new TreeBin&lt;K, V&gt;(lo) : t;
                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :
                                (lc != 0) ? new TreeBin&lt;K, V&gt;(hi) : t;
                        setTabAt(nextTab, i, ln);
                        setTabAt(nextTab, i + n, hn);
                        setTabAt(tab, i, fwd);
                        advance = true;
                    }
                }
            }
        }
    }
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>数组移动的算法内容相对较多，结合方法备注，仔细理解这个方法的含义。<br>
<strong>数组移动，通常需要两轮大循环，第一轮大循环是将原数组的所有节点都置为ForwardingNode对象，并将原数组的Node对象移动到新的数组中对应的位置上；第二轮大循环主要是检查原数组中是否有其他线程操作过数组，避免有其他线程在数组移动的过程中出现remove和put操作，这样当前移动数组的线程可以再来一次检查，第二轮循环之后就绝不会再有新的元素put到原数组中了，因为原数组的所有元素都是ForwardingNode对象，而ForwardingNode对象的hash是MOVED（-1），其他线程再次put时候就会进入 putVal(K, V, boolean) 方法的 <em>else if ((fh = f.hash) == MOVED)</em> 代码块中了</strong>。<br>
从算法来看，ConcurrentHashMap的数组移动过程是一个耗时的操作，其时间复杂度为O(2n)，当ConcurrentHashMap存储数据到一定程度再扩容，其相对是比较耗时的，所以对于那种大数据量的存储，在能提前知道数据量的情况下尽量指定其initialCapacity，这样在一定程度上不至于触发扩容操作。</p>
<p>介绍完数组移动之后，我们再去看容器计数和多线程辅助数组移动功能。</p>
<h3 id="1.3.5-%E5%AE%B9%E5%99%A8%E8%AE%A1%E6%95%B0" tabindex="-1">1.3.5 容器计数</h3>
<p>在 putVal(K, V, boolean) 存放数据的最后调用了 <strong>addCount(long, int)</strong> 方法，在这个方法中会对容器计数以及检查是否需要数组扩容，其代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 增加计数, 可能会触发数组移动
 * @param x 待增加的计数值
 * @param check 如果 &lt; 0, 表示不检查resize
 */
private final void addCount(long x, int check) {
    CounterCell[] as;
    long b, s;//b表示baseCount, s表示当前容器元素数量
    /*
     * counterCells != null 表示已经出现过线程争用情况了, 所以需要维护counterCells内容
     * 或者这里CAS修改baseCount值失败, 说明出现了线程争用的情况
     */
    if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) {
        CounterCell a;
        long v;
        int m;
        boolean uncontended = true;
        if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null ||
                !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {
            fullAddCount(x, uncontended);//填充值
            return;
        }
        if (check &lt;= 1)
            return;
        s = sumCount();//重新赋值
    }
    if (check &gt;= 0) {//需要检查resize
        Node&lt;K, V&gt;[] tab, nt;
        int n, sc;
        //s &gt;= sizeCtl 表示需要扩容了, 因为sizeCtl为下一次扩容大小
        while (s &gt;= (long) (sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) {
            int rs = resizeStamp(n);//当次的哈希表长度标识
            if (sc &lt; 0) {
                if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0)
                    break;
                if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))
                    transfer(tab, nt);
            } else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))
                transfer(tab, null);
            s = sumCount();
        }
    }
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>这段代码有两个功能：</p>
<ul>
<li>统计计数：ConcurrentHashMap不是普通的数组或者链表的结构，所以无法通过Node[].length 计算容器的元素数量，需要单独维护容器中的元素数量</li>
<li>检查扩容：当数组大小增长到一定程度时，需要对数组检查扩容</li>
</ul>
<h4 id="1.3.5.1-%E7%BB%9F%E8%AE%A1%E8%AE%A1%E6%95%B0" tabindex="-1">1.3.5.1 统计计数</h4>
<p>统计计数在addCount(long, int) 方法中是第一段if 代码块，如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">CounterCell[] as;
long b, s;//b表示baseCount, s表示当前容器元素数量
/*
 * counterCells != null 表示已经出现过线程争用情况了, 所以需要维护counterCells内容
 * 或者这里CAS修改baseCount值失败, 说明出现了线程争用的情况
 */
if ((as = counterCells) != null || !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) {
    CounterCell a;
    long v;
    int m;
    boolean uncontended = true;
    if (as == null || (m = as.length - 1) &lt; 0 || (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null ||
            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) {
        fullAddCount(x, uncontended);//填充值
        return;
    }
    if (check &lt;= 1)
        return;
    s = sumCount();//重新赋值
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>在ConcurrentHashMap中有一个volatile修饰的字段baseCount和CounterCell数组，如下</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/** 基础的计数值, 如果在没有线程争用的情况下, 可以直接表示容器的元素数量; 但是当出现了线程的争用情况, 需要加上{@link  #counterCells}中的数值表示容器的元素数量 */
private transient volatile long baseCount;

/** 哈希表的计数单元。当不为空的时候, 其size大小是2的幂 */
private transient volatile CounterCell[] counterCells;
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>这两个字段都是用于容器中数量计数方式，通过上述 addCount(long, int) 方法中的 if ((as = counterCells) != null || !(U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x))) 代码块可知，当已经有counterCells时或者当前线程对baseCount增加计数失败时（可以理解为抢占锁失败）进入该代码块。在该代码块中，会再次检查counterCells 是否为空，如果为空或者探测到counterCells数组中有空的元素或者对指定CounterCell对象的value值增加失败，证明可能出现了以下情况：</p>
<ul>
<li>counterCells未初始化，并且出现了线程争用，当前线程修改baseCount值失败</li>
<li>当前的counterCells不为空，但是数组的元素未填充满</li>
<li>counterCells已经初始化，进入 if ((as = counterCells) != null || !(U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x))) 代码块后再次出现了线程争用，导致CAS更新CounterCell中的value值失败</li>
</ul>
<p>出现上述几种情况，就会进入<strong>fullAndCount(long, boolean)</strong> 方法：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 填充{@link  #counterCells}
 * @param x 待填充的值
 * @param wasUncontended
 */
private final void fullAddCount(long x, boolean wasUncontended) {
    //随机数 Start
    int h;
    if ((h = ThreadLocalRandom.getProbe()) == 0) {//获取未成功
        ThreadLocalRandom.localInit();//强制初始化
        h = ThreadLocalRandom.getProbe();//再次探测
        wasUncontended = true;
    }
    //随机数 End

    boolean collide = false;
    //主体自旋逻辑 Start
    for (; ; ) {
        CounterCell[] as;
        CounterCell a;
        int n;
        long v;
        if ((as = counterCells) != null &amp;&amp; (n = as.length) &gt; 0) {//counterCells已经初始化并且数组中有元素
            if ((a = as[(n - 1) &amp; h]) == null) {
                if (cellsBusy == 0) {//未被其他线程占用锁
                    CounterCell r = new CounterCell(x);//创建
                    if (cellsBusy == 0 &amp;&amp; U.compareAndSwapInt(this, CELLSBUSY, 0, 1)) {//加锁
                        boolean created = false;
                        try {
                            CounterCell[] rs;
                            int m, j;
                            if ((rs = counterCells) != null &amp;&amp; (m = rs.length) &gt; 0 &amp;&amp; rs[j = (m - 1) &amp; h] == null) {//再次检查锁
                                rs[j] = r;
                                created = true;
                            }
                        } finally {
                            cellsBusy = 0;
                        }
                        if (created)
                            break;
                        continue;           // Slot is now non-empty
                    }
                }
                collide = false;
            } else if (!wasUncontended)//CAS失败
                wasUncontended = true;      //continue
            else if (U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))//数组指定位置有值则直接增加
                break;
            else if (counterCells != as || n &gt;= NCPU)
                collide = false;            // At max size or stale
            else if (!collide)
                collide = true;
            else if (cellsBusy == 0 &amp;&amp; U.compareAndSwapInt(this, CELLSBUSY, 0, 1)) {
                try {
                    if (counterCells == as) {// Expand table unless stale
                        CounterCell[] rs = new CounterCell[n &lt;&lt; 1];
                        for (int i = 0; i &lt; n; ++i)
                            rs[i] = as[i];
                        counterCells = rs;
                    }
                } finally {
                    cellsBusy = 0;
                }
                collide = false;
                continue;                   // Retry with expanded table
            }
            h = ThreadLocalRandom.advanceProbe(h);
        } else if (cellsBusy == 0 &amp;&amp; counterCells == as &amp;&amp; U.compareAndSwapInt(this, CELLSBUSY, 0, 1)) {//CAS变更cellsBusy加锁(counterCells未初始化)
            boolean init = false;//是否成功初始化
            try {
                if (counterCells == as) {//表示没有线程对counterCells进行变更(再次检查锁)
                    CounterCell[] rs = new CounterCell[2];//默认初始化数组大小为2
                    rs[h &amp; 1] = new CounterCell(x);//添加元素
                    counterCells = rs;
                    init = true;//初始化成功
                }
            } finally {
                cellsBusy = 0;
            }
            if (init)
                break;
        } else if (U.compareAndSwapLong(this, BASECOUNT, v = baseCount, v + x))//直接使用baseCount
            break;
    }
    //主体自旋逻辑 End
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>在这里，如果counterCells为空则对其进行初始化，然后增加计数。而这里相对于addCount(long, int) 方法会多一个自旋的逻辑，保证计数一定增加成功。</p>
<p>CounterCell对象很简单，主要用于记录计数的，如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 用于分配计数用的单元, 改编自 LongAdder 和 Striped64
 */
@sun.misc.Contended
static final class CounterCell {
    volatile long value;

    CounterCell(long x) {
        value = x;
    }
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h4 id="1.3.5.2-%E6%89%A9%E5%AE%B9" tabindex="-1">1.3.5.2 扩容</h4>
<p>在addCount(long, int) 中第二个if 代码块如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">if (check &gt;= 0) {//需要检查resize
    Node&lt;K, V&gt;[] tab, nt;
    int n, sc;
    //s &gt;= sizeCtl 表示需要扩容了, 因为sizeCtl为下一次扩容大小
    while (s &gt;= (long) (sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp; (n = tab.length) &lt; MAXIMUM_CAPACITY) {
        int rs = resizeStamp(n);//当次的哈希表长度标识
        if (sc &lt; 0) {
            if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 || sc == rs + MAX_RESIZERS || (nt = nextTable) == null || transferIndex &lt;= 0)
                break;
            if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))
                transfer(tab, nt);
        } else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))
            transfer(tab, null);
        s = sumCount();
    }
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>在 <strong>transfer(Node[], Node[])</strong> 方法中，我们得知 sizeCtl这个变量，正数的时候表示下一次扩容大小，所以判断当前容器中元素的数量超过了sizeCtl的时候，就需要进行扩容了。但是ConcurrentHashMap由于使用的是CAS无锁计数（细颗粒锁），是支持多线程扩容的。存在多线程，就需要知道几个问题：</p>
<ul>
<li>当前线程如何确认数组已经移动完成？</li>
<li>多个线程如何同时移动数组扩容？</li>
</ul>
<p><strong>1. 在上述的这段数组扩容代码中，首先使用resizeStamp(int) 计算出一个标识，传递的形参是当前数组的长度</strong>，其代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 重新计算标识。计算方式为
 * 先使用{@link Integer#numberOfLeadingZeros(int)}对n计算出前面有多少个0(n的二进制),
 * 然后按位或一个 1 &lt;&lt; 15 (二进制为 00000000 00000000 10000000 00000000), 即第16位一定是1。
 * 比如n为16,
 * 00000000 00000000 00000000 00010000    //十进制是16
 * 得知前面有27个0, 即27对应的二进制为
 * 00000000 00000000 00000000 00011011    //十进制为27
 * |
 * 00000000 00000000 10000000 00000000    //十进制为32768
 * =
 * 00000000 00000000 10000000 00011011
 * 即不管怎么算, 最终的结果都是第16位一定为1
 * @param n 数
 * @return int
 */
static final int resizeStamp(int n) {
    return Integer.numberOfLeadingZeros(n) | (1 &lt;&lt; (RESIZE_STAMP_BITS - 1));
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>这个方法很重要，<strong>主要是计算数组长度的标识，并且将第16未置为1</strong>。<br>
在ConcurrentHashMap容器中，其保存元素的数组table的长度一定是2的幂，所以在二进制上也一定只有一位是1<br>
1. 如果形参n两次是一样的，那么通过<strong>Integer.numberOfLeadingZeros(int)</strong> 方法计算的结果一定也是一样的，如果两次传递的n是不一样的，如n为8（第4位为1）和n为16（第5位为1）计算的结果分别是28和27，所以一定是不一样的。<br>
通过此方法，如果两次传递的形参是一样的，证明数组没有变更过（传递的形参即数组的长度）；如果不一样证明数组长度变更过。所以计算出的结果可以标识为同一个数组。</p>
<p><strong>2. 第一次我们知道sizeCtl是大于0的，所以不会进入 <em>if (sc &lt; 0)</em> 代码块，而是进入了 <em>else if (U.compareAndSwapInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))</em> 代码块中。注意，这里是将sizeCtl更新为 (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2的值，RESIZE_STAMP_SHIFT值固定为16， rs是通过resizeStamp(int) 方法计算的标识，因为rs的第16位是1，所以最终的结果是sizeCtl一定为负数（最高位为1，具体请看 <a href="http://blog.shangsw.com/archives/yuanmafanmabumahtml" target="_blank" rel="noopener noreferrer nofollow">1、原码、反码和补码</a> 文章了解）。如果CAS更新sizeCtl成功则进入transfer(Node[], Node[]) 方法，这个方法我们在上述详细介绍过。</strong></p>
<p><strong>3. 如果多线程同时进入了这个逻辑，如线程A和线程B，线程A更新sizeCtl成功，那么线程B就会在while循环中继续循环，线程B会进入 <em>if (sc &lt; 0)</em> 的代码块中，那么线程B此时需要判断线程A是否已经移动数组完成，即通过 <em>if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc = rs + 1 || sc == rs + MAX_RESIZE || (nt = nextTable) == null || transferIndex &lt;= 0)</em> 代码块判断，通过 transfer(Node[], Node[]) 代码我们知道，当数组移动完成后，会将nextTable字段置为空，并且transferIndex一定是小于等于0的，更新sizeCtl的值。所以后面三个条件好理解。我们看前两个条件：</strong></p>
<ul>
<li><strong>第一个条件 <em>sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT != rs</em> ，将sizeCtl右移16位与当前的rs不等则表示数组移动完成，通过上述我们知道线程A会将sizeCtl变更为 rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2 ，所以在数组大小未变的情况下，证明还有线程在移动数组。有人不是说sizeCtl更新的值后面还有+2吗？右移操作是直接将低16位舍去了，所以不需要 -2。</strong></li>
<li><strong>第二个条件 <em>sc == rs + 1</em> ，通过后面代码 <em>if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))</em> 我们知道如果线程B发现线程A还没有将数组移动完成，那么线程B也会进入transfer(Node[]. Node[]) 方法和线程A一起移动数组，而将sizeCtl更新+1，表示线程数+1，所以这里判断如果是 <em>sc == rs + 1</em> 证明当前线程已经完成了transfer(Node[], Node[]) 方法，所以需要退出。</strong></li>
</ul>
<p>所以从这里我们可以看出，如果多个线程同时需要扩容的话，是可以同时操作同一个数组，以便更快的完成扩容操作。</p>
<h4 id="1.3.5.3-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%BE%85%E5%8A%A9%E6%95%B0%E7%BB%84%E7%A7%BB%E5%8A%A8" tabindex="-1">1.3.5.3 多线程辅助数组移动</h4>
<p>在putVal(K, V, boolean) 方法中，有一段这样的代码：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">else if ((fh = f.hash) == MOVED)//如果数组正在移动中
    /*
     * 如果检测到某个节点的hash值是MOVED的话,则表示正在进行数组扩容的复制数据的阶段。
     * 则当前线程也会参与去复制, 通过允许多线程复制的功能, 增加复制的效率
     */
    tab = helpTransfer(tab, f);
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>表示如果当前线程检测到有数组移动，那么调用 <strong>helpTransfer(Node[], Node)</strong> 方法辅助扩容，代码如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * 如果取出来的节点(f)的hash值是MOVED(值为-1)的话, 则表示当前正在对数组进行扩容
 * 这个方法是帮助从旧的table数组将数据复制到新的数组中
 * @param tab 当前的tab数组
 * @param f 从数组中取出的元素
 * @return 新的数组
 */
final Node&lt;K, V&gt;[] helpTransfer(Node&lt;K, V&gt;[] tab, Node&lt;K, V&gt; f) {
    Node&lt;K, V&gt;[] nextTab;
    int sc;
    //新的table nextTable已经存在的前提下才能帮助扩容
    if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp; (nextTab = ((ForwardingNode&lt;K, V&gt;) f).nextTable) != null) {
        int rs = resizeStamp(tab.length);//根据length得到一个标识符
        /*
         * nextTab == this.nextTable表示当前数组正在扩容, this.nextTable只有在扩容的时候才会存在, 否则为空
         * this.table == tab 表示此线程操作的数组就是要扩容的数组
         * (sc = this.sizeCtl) &lt; 0表示当前数组正在移动
         */
        while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; 0) {
            /*
             * 如果sizeCtl右移16位不等于rs(sc高16位不等于标识符, 则标识符变化了)
             * 或者sizeCtl == rs + 1(扩容结束了)
             * 或者sizeCtl == rs + 65535(如果达到最大帮助线程, 即65535)
             * 或者下标正在调整(扩容结束)
             * 循环结束, 返回table
             */
            if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||
                    sc == rs + MAX_RESIZERS || transferIndex &lt;= 0)
                break;
            if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1)) {//对sizeCtl通过CAS进行+1操作
                transfer(tab, nextTab);//调用扩容方法
                break;
            }
        }
        return nextTab;
    }
    return table;
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<p>这段代码与上述的 addCount(long, int) 辅助扩容一样，具体请看上文。</p>
<h2 id="1.4-size%2C-%E8%8E%B7%E5%8F%96%E5%85%83%E7%B4%A0%E6%95%B0%E9%87%8F" tabindex="-1">1.4 size, 获取元素数量</h2>
<p>通过上述的分析，其实我们也知道<strong>ConcurrentHashMap.size()</strong> 的大致逻辑了，其实就是将baseCount和counterCells加起来即可，如下：</p>
<div class="code-toolbar"><pre class="c_title c_hr c_macdot c_hover_tools c_copy language-none" tabindex="0"><code class="language- language-none">/**
 * Map容器的大小。
 * @return 容器大小
 */
public int size() {
    long n = sumCount();
    return ((n &lt; 0L) ? 0 : (n &gt; (long) Integer.MAX_VALUE) ? Integer.MAX_VALUE : (int) n);
}

/**
 * 计算当前容器的数量
 * @return
 */
final long sumCount() {
    CounterCell[] as = counterCells;//计数单元
    CounterCell a;
    long sum = baseCount;//基础值
    if (as != null) {
        for (int i = 0; i &lt; as.length; ++i) {
            if ((a = as[i]) != null)
                sum += a.value;
        }
    }
    return sum;
}
</code><span class="copy-button"><i class="joe-font joe-icon-copy" title="复制代码"></i></span></pre><div class="toolbar"><div class="toolbar-item"><span data-rel="Plain text"></span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy" data-rel="复制"></button></div></div></div>
<h2 id="1.5-%E5%B0%8F%E7%BB%93" tabindex="-1">1.5 小结</h2>
<p>经过上述核心源码的分析，我们做一次总结：</p>
<ul>
<li>ConcurrentHashMap是一个线程安全的关联式容器，内部使用Node数组存储元素，如果出现哈希碰撞则使用链表结构继续保存元素，当链表的长度超过了 8 时则变更为红黑树的结构
<ul>
<li>小提示：在很多面试过程中会问到为什么链表长度超过8则变更为红黑树？其实这是一个初中数学问题，链表查询的时间复杂度是O(n)，红黑树查询的时间复杂度是O(lgn)，如果此时n为10，log10则为1，当前CPU处理效率来看，循环10次与循环1次效率上差值可以忽略不计，选择8则为一个中值，并没有太多的更为复杂的含义</li>
</ul>
</li>
<li>在get(Object) 获取元素时：
<ul>
<li>计算出位置后使用volatile语义获取数组的元素，保证了线程可见性的安全</li>
<li>当数组正在移动时，也可以获取元素，使用ForwardingNode.find(int, Object) 获取，其实是从nextTable（新的数组）上获取元素</li>
</ul>
</li>
<li>在put(K, V, boolean) 存放元素时：
<ul>
<li>如果数组未初始化（ConcurrentHashMap构造过程不会初始化数组），则调用initTable() 初始化数组。初始化数组是安全的，安全的机制是CAS对sizeCtl更新为-1，如果其他线程检测到sizeCtl为负数，则Thread.yield() 让出CPU时间，直到数组不为空所有线程退出 initTable() 初始化方法。所以初始化过程是线程安全的</li>
<li>哈希函数计算当前Key在数组的位置后，使用具有volatile语义获取对应位置上是否有元素，没有元素则使用CAS由null值设置为指定值，设置成功则退出方法，否则继续循环。所以存放元素到数组时是线程安全的</li>
<li>如果检测到数组正在移动，则调用helpTransfer(Node[], Node) 方法帮助一起移动数组，而移动数组通过CAS和细颗粒的synchronized保证了线程安全</li>
<li>如果出现了哈希碰撞，则通过synchronized锁住链表头或者树根保证线程安全</li>
</ul>
</li>
<li>sizeCtl是一个volatile 修饰的int类型的值，sizeCtl有多层含义：
<ul>
<li>为正数时表示下一次扩容的大小</li>
<li>负数：-1表示正在初始化；其他负值表示数组正在移动</li>
</ul>
</li>
<li>ConcurrentHashMap使用volatile修饰的int类型的baseCount和volatile修饰的CounterCell数组来统计当前容器的元素数量，在统计的过程中baseCount作为基础值，同时也作为类似锁的逻辑，CAS更新成功则不使用CounterCell数组，更新失败证明有线程争用，为了不让失败的线程阻塞使用CounterCell统计保证线程不间断的运行，提升算力</li>
</ul>
<p>对于ConcurrentHashMap的数据结构（链表和红黑树）可自行研究。同时仔细理解上述数组移动算法和多线程一起移动数组的逻辑。</p>

                </div>
              </article>
    <div class="joe_detail__agree" style="display: none;">
      <div class="agree">
        <div class="icon">
          <i class="joe-font joe-icon-like icon-like active"></i>
          <i class="joe-font joe-icon-like-fill icon-unlike"></i>
        </div>
        <span class="nums">2</span>
      </div>
    </div>
            </div>
<div class="joe_detail__operate">
  <div class="joe_detail__operate-tags">
            <a href="http://blog.shangsw.com/tags/%E6%8A%80%E6%9C%AF">技术</a>
        <a href="http://blog.shangsw.com/tags/jdk%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">JDK源码分析</a>
        <a href="http://blog.shangsw.com/tags/%E5%B9%B6%E5%8F%91%E6%A1%86%E6%9E%B6">并发框架</a>
  </div>
    <div class="joe_detail__operate-share" style="display: none;">
      <i class="joe-font joe-icon-share"></i>
      <div class="share-icon-list">
          <a class="icon-share-link" href="javascript:;" rel="noopener noreferrer" title="复制文章链接">
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3509" width="30" height="30"><path d="M515.2 64c-246.4 0-448 198.4-448 444.8S268.8 953.6 512 953.6c246.4 0 444.8-201.6 444.8-444.8S758.4 64 515.2 64z m-118.4 441.6c-9.6 9.6-28.8 9.6-41.6 0l-22.4-25.6-12.8-9.6c-19.2-22.4-32-48-35.2-76.8 0-28.8 9.6-57.6 28.8-76.8 22.4-19.2 48-28.8 76.8-28.8 28.8 0 60.8 12.8 83.2 35.2l86.4 86.4c22.4 22.4 35.2 51.2 35.2 80 0 25.6-9.6 51.2-28.8 70.4-9.6 9.6-28.8 9.6-41.6 0-9.6-9.6-9.6-28.8 0-38.4 19.2-19.2 16-51.2-3.2-73.6l-86.4-86.4c-12.8-12.8-25.6-19.2-41.6-19.2-9.6 0-22.4 3.2-32 12.8-12.8 12.8-12.8 25.6-12.8 35.2 0 12.8 6.4 28.8 19.2 38.4l12.8 12.8 22.4 22.4c3.2 12.8 3.2 28.8-6.4 41.6z m307.2 201.6c-19.2 19.2-44.8 28.8-73.6 28.8-28.8 0-60.8-12.8-83.2-35.2l-86.4-86.4c-22.4-22.4-35.2-51.2-35.2-80 0-25.6 9.6-51.2 28.8-70.4 9.6-9.6 28.8-9.6 41.6 0 9.6 9.6 9.6 28.8 0 38.4-19.2 19.2-16 51.2 3.2 73.6l86.4 86.4c12.8 12.8 25.6 19.2 41.6 19.2 9.6 0 22.4-3.2 32-12.8 12.8-12.8 12.8-25.6 12.8-35.2 0-12.8-6.4-28.8-19.2-38.4l-25.6-25.6-9.6-9.6c-9.6-9.6-9.6-28.8 0-38.4 9.6-9.6 28.8-9.6 41.6 0l12.8 12.8 19.2 19.2c22.4 19.2 35.2 48 35.2 73.6 9.6 32-3.2 57.6-22.4 80z" fill="#989b9e"></path></svg>
          </a>
          <a href="http://service.weibo.com/share/share.php?sharesource=weibo&amp;title=%E5%88%86%E4%BA%AB%EF%BC%9A14%E3%80%81ConcurrentHashMap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%8C%E5%8E%9F%E6%96%87%E9%93%BE%E6%8E%A5%EF%BC%9Ahttp://blog.shangsw.com/archives/concurrenthashmaphtml&amp;pic=http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg" target="_blank" rel="noopener noreferrer" title="分享到新浪微博">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="30" height="30">
              <path d="M480.8 457.76a271.04 271.04 0 0 0-37.28 2.72c-96 13.44-166.72 75.04-157.92 137.44s93.6 101.92 189.6 88.48 166.72-75.04 157.92-137.44c-7.68-54.08-73.12-91.04-152.32-91.2zm-23.36 211.52a122.08 122.08 0 0 1-24 2.4c-48 0-88-27.52-96-68.32-9.28-48 29.44-95.2 86.56-106.24s110.88 18.4 120 66.08-29.44 95.04-86.56 106.08z" fill="#F56467"></path>
              <path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28zm-43.84 666.88c-150.24 0-272-78.56-272-176S378.56 314.72 448 314.72c29.28 0 86.56 21.76 46.4 90.88a246.24 246.24 0 0 0 34.08-10.08c32-9.12 76.96-18.24 107.68 0 51.04 29.6 0 77.12 0 82.4s102.4 5.28 102.4 87.2c.32 96.48-120.16 175.04-270.4 175.04zm213.76-358.88a56 56 0 0 0-47.2-16 16.96 16.96 0 0 1-17.28-14.4 12.16 12.16 0 0 0 0 2.4v-4.8a12.16 12.16 0 0 0 0 2.4 20.48 20.48 0 0 1 17.28-17.28 77.28 77.28 0 0 1 68.32 18.56c32 28.48 18.72 75.68 18.72 75.68a21.28 21.28 0 0 1-20.48 17.28h-1.76a12.48 12.48 0 0 1-12.8-16.8 49.44 49.44 0 0 0-4.8-47.04zm120.16 60.64A29.6 29.6 0 0 1 776 467.84a22.08 22.08 0 0 1-19.68-25.92A139.2 139.2 0 0 0 736 336c-34.88-50.08-109.92-41.28-109.92-41.28A26.24 26.24 0 0 1 599.84 272v2.88-5.6V272a26.56 26.56 0 0 1 26.24-23.52 188.32 188.32 0 0 1 136.16 47.04c58.08 55.04 39.84 146.4 39.84 146.4z" fill="#F56467"></path>
              <path d="M459.36 547.04a17.6 17.6 0 1 0 17.6 17.6 17.6 17.6 0 0 0-17.6-17.6zm-44.32 23.2a43.52 43.52 0 0 0-18.4 4.32A32 32 0 0 0 376 613.12a32 32 0 0 0 42.88 9.12 32 32 0 0 0 20.64-38.72 25.76 25.76 0 0 0-24.48-13.28z" fill="#F56467"></path>
            </svg>
          </a>
          <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://blog.shangsw.com/archives/concurrenthashmaphtml&amp;sharesource=qzone&amp;title=14%E3%80%81ConcurrentHashMap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90&amp;pics=http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg" target="_blank" rel="noopener noreferrer" title="分享到QQ空间">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="30" height="30">
              <path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28zM829.92 432c5.6 16-150.24 146.4-150.24 146.4s2.08 12.64 4.16 22.08c0 0-72.64 2.24-132.32 0-32-1.28-69.12-7.04-69.12-7.04L656 470.24a1005.44 1005.44 0 0 0-125.76-13.6A908 908 0 0 0 380 463.36c-6.4 1.76 44.8 1.6 103.04 6.88 40.8 3.68 94.56 13.44 94.56 13.44l-172.8 128s73.92 4.48 140.32 4.16c74.72 0 142.24-9.92 142.72-8 12.96 56.16 36.96 167.52 28 176-12.16 12.32-185.6-97.6-185.6-97.6S368 785.6 345.92 785.6a3.68 3.68 0 0 1-2.08 0c-10.72-8.8 35.52-206.72 35.52-206.72S222.72 448 229.12 432s208-30.24 208-30.24 74.88-188 92.48-188 92.8 188 92.8 188S824.32 416 829.92 432z" fill="#F5BE3F"></path>
            </svg>
          </a>
          <a href="https://connect.qq.com/widget/shareqq/index.html?url=http://blog.shangsw.com/archives/concurrenthashmaphtml&amp;title=14%E3%80%81ConcurrentHashMap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90&amp;pics=http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg" target="_blank" rel="noopener noreferrer" title="分享到QQ">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="30" height="30">
              <path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28zM759.84 646.4c-9.6 8.16-20.8-6.08-29.76-20.32s-14.88-26.72-16-21.76a158.4 158.4 0 0 1-37.44 70.72c-1.28 1.6 28.8 12.48 37.44 35.68s24 57.6-80 68.8a145.76 145.76 0 0 1-80-16c-16.96-8.32-27.52-16-29.6-16a73.6 73.6 0 0 1-13.28 0 108 108 0 0 1-14.4 0c-1.76 0-22.24 32-113.12 32-70.4 0-88.64-44.32-74.4-68.8s37.76-32 34.4-35.36a192 192 0 0 1-34.4-57.6 98.56 98.56 0 0 1-4.16-13.44c-1.28-4.64-6.56 8.64-13.92 21.76s-14.4 22.72-22.88 22.72a11.52 11.52 0 0 1-6.56-2.4c-20.96-16-19.2-55.2-5.44-93.12s48-75.04 48-83.2c1.28-30.24-3.04-35.2 0-43.2 6.56-17.76 14.72-10.88 14.72-20.16 0-116.32 86.4-210.56 192.96-210.56s192.96 94.24 192.96 210.56c0 4.48 11.68 0 17.12 20.16a196.96 196.96 0 0 1 0 43.2c0 11.04 29.44 24.48 44.8 83.2S768 640 759.84 646.4z" fill="#68A5E1"></path>
            </svg>
          </a>
          <a id="share_to_weixin" href="javascript:;" title="分享到微信">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
              <path d="M334.848 334.336a33.792 33.792 0 0 0-36.352 30.72 33.792 33.792 0 0 0 36.352 30.72 28.672 28.672 0 0 0 30.208-30.72 28.672 28.672 0 0 0-30.208-30.72zM581.12 512a24.576 24.576 0 0 0 0 51.2 27.648 27.648 0 0 0 30.208-24.576 27.648 27.648 0 0 0-30.208-26.624zM502.784 395.776a28.672 28.672 0 0 0 30.208-30.72 28.672 28.672 0 0 0-30.208-30.72 33.792 33.792 0 0 0-35.84 30.72 33.792 33.792 0 0 0 35.84 30.72zM713.216 512a24.576 24.576 0 0 0 0 51.2 27.648 27.648 0 0 0 30.208-24.576 27.648 27.648 0 0 0-30.208-26.624z" fill="#3db214"></path>
              <path d="M512 0a512 512 0 1 0 512 512A512 512 0 0 0 512 0zM412.672 646.656a403.456 403.456 0 0 1-83.968-12.288l-83.968 43.008 24.064-73.728a201.216 201.216 0 0 1-96.256-165.376c0-116.224 108.032-207.872 240.128-207.872a240.128 240.128 0 0 1 242.688 172.032h-23.04a198.144 198.144 0 0 0-204.8 193.536 185.344 185.344 0 0 0 7.168 51.2zM768 732.672l17.92 60.928-66.048-36.864a296.96 296.96 0 0 1-72.192 12.288 191.488 191.488 0 0 1-204.8-177.664 191.488 191.488 0 0 1 204.8-177.664c108.032 0 204.8 79.872 204.8 177.664A185.856 185.856 0 0 1 768 732.672z" fill="#3db214"></path>
            </svg>
            <div class="qrcode_wrapper animated bounceIn">
              <div class="qrcode_wx"><canvas width="140" height="140"></canvas></div>
              <p>微信扫一扫</p>
            </div>
          </a>
      </div>
    </div>
  <div class="joe_donate" style="display: none;">
    <i class="joe-font joe-icon-shang"></i>
      <ol class="joe_donate_list two">
        <li><img src="./14、ConcurrentHashMap核心源码解析_files/支付宝收款.jpg" onerror="Joe.errorImg(this)" alt="qrcode alipay"></li>
        <li><img src="./14、ConcurrentHashMap核心源码解析_files/微信收款.jpg" onerror="Joe.errorImg(this)" alt="qrcode weixin"></li>
      </ol>
  </div>
</div>  <div class="joe_detail__copyright">
    <div class="content">
      <div class="item">
        <svg class="icon" width="20" height="20" viewBox="0 0 1024 1024">
          <path d="M614.72 554.538c-49.086-6.399-100.27-2.1-149.256-2.1-119.465 0-209.04 95.972-206.84 215.437 0 17.095 8.498 31.99 23.493 40.488 14.896 10.697 34.09 14.896 53.285 17.095 61.882 6.398 123.664 6.398 198.342 6.398 40.488 0 93.872-2.1 142.858-4.298 27.692 0 53.284-4.3 78.877-14.896 19.194-8.498 29.89-19.194 31.99-40.488 8.498-104.57-72.478-204.84-172.75-217.636zM680.8 375.39c0-87.474-74.678-162.053-164.251-162.053-89.574 0-162.053 74.679-162.053 162.053-2.1 87.474 74.678 164.252 162.053 164.252 89.673 0 164.252-74.678 164.252-164.252z" fill="#FFF"></path>
          <path d="M512.35 0C228.733 0 .5 228.233.5 511.85s228.233 511.85 511.85 511.85 511.85-228.233 511.85-511.85S795.967 0 512.35 0zm275.12 772.074c-2.1 21.294-12.797 31.99-31.991 40.488-25.593 10.697-51.185 14.896-78.877 14.896-49.086 2.099-102.37 4.298-142.858 4.298-74.678 0-136.46 0-198.342-6.398-19.195-2.1-38.389-6.398-53.285-17.095-14.895-8.497-23.493-23.493-23.493-40.488-2.1-119.465 87.475-215.437 206.84-215.437 49.085 0 100.27-4.299 149.256 2.1 100.27 12.896 181.247 113.166 172.75 217.636zM354.495 375.39c0-87.474 72.479-162.053 162.053-162.053S680.8 288.016 680.8 375.39c0 89.574-74.679 164.252-164.252 164.252-87.375 0-164.152-76.778-162.053-164.252z" fill="#249FF8"></path>
        </svg>
        <span>版权归属：</span>
        <span class="text">林雷</span>
      </div>
      <div class="item">
        <svg class="icon" width="20" height="20" viewBox="0 0 1024 1024">
          <path d="M511.854 0A511.854 511.854 0 1 0 1024 511.854 511.854 511.854 0 0 0 511.854 0z" fill="#39B54A"></path>
          <path d="M576.491 630.355L460.028 746.818a129.565 129.565 0 0 1-182.555 0l-2.038-2.038a128.983 128.983 0 0 1 0-182.264l81.233-81.233a179.644 179.644 0 0 0 13.102 70.46l-52.7 52.408a69.878 69.878 0 0 0 0 98.703l2.038 2.038a70.169 70.169 0 0 0 98.703 0l116.463-116.463a69.878 69.878 0 0 0 0-98.703l-2.039-2.038a69.587 69.587 0 0 0-13.975-10.772l42.509-42.51a128.11 128.11 0 0 1 13.102 11.356l2.038 2.038a129.274 129.274 0 0 1 0 182.264z" fill="#FFF"></path>
          <path d="M746.236 460.902l-81.233 81.233a179.353 179.353 0 0 0-13.102-70.46l52.7-52.409a69.878 69.878 0 0 0 0-98.702l-2.039-2.038a69.878 69.878 0 0 0-98.702 0L487.397 434.989a69.878 69.878 0 0 0 0 98.702l2.038 2.038a68.422 68.422 0 0 0 13.976 10.773l-42.51 42.51a136.553 136.553 0 0 1-13.101-11.356l-2.038-2.038a128.983 128.983 0 0 1 0-182.265l116.463-116.462a129.565 129.565 0 0 1 182.555 0l2.038 2.038a128.983 128.983 0 0 1 0 182.264z" fill="#FFF"></path>
        </svg>
        <span>本文链接：</span>
        <span class="text">
          <a class="link" href="http://blog.shangsw.com/archives/concurrenthashmaphtml" target="_blank" rel="noopener noreferrer nofollow">http://blog.shangsw.com/archives/concurrenthashmaphtml</a>
        </span>
      </div>
      <div class="item">
        <svg class="icon" width="20" height="20" viewBox="0 0 1024 1024">
          <path d="M0 512a512 512 0 1 0 1024 0A512 512 0 1 0 0 512z" fill="#F3B243"></path>
          <path d="M540.672 323.584a90.112 90.112 0 1 0 180.224 0 90.112 90.112 0 1 0-180.224 0zM540.672 688.128a90.112 90.112 0 1 0 180.224 0 90.112 90.112 0 1 0-180.224 0zM229.376 512a90.112 90.112 0 1 0 180.224 0 90.112 90.112 0 1 0-180.224 0z" fill="#FFF"></path>
          <path d="M341.037 480.37l257.344-175.718 27.713 40.592-257.34 175.718z" fill="#FFF"></path>
          <path d="M349.053 488.452L601.907 670.56l-28.725 39.887L320.307 528.34z" fill="#FFF"></path>
        </svg>
        <span>许可协议：</span>
        <span class="text">
        本文使用《<a class="link" href="http://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener noreferrer nofollow">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a>》协议授权
        </span>
      </div>
    </div>
  </div>
          </div>
<ul class="aside_operations" style="display: block;">
      <li class="post-operate-like">
      <i class="joe-font joe-icon-dianzan icon-like active"></i>
      <i class="joe-font joe-icon-dianzan-fill icon-unlike"></i>
      <span class="nums visible" df="">2</span>
    </li>
    <li class="post-operate-comment"><i class="joe-font joe-icon-message"></i></li>
    <li class="post-operate-share">
      <i class="joe-font joe-icon-huifu"></i>
      <div class="share-icon-list">
          <a id="share_to_weixin" href="javascript:;" title="分享到微信">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
              <path d="M334.848 334.336a33.792 33.792 0 0 0-36.352 30.72 33.792 33.792 0 0 0 36.352 30.72 28.672 28.672 0 0 0 30.208-30.72 28.672 28.672 0 0 0-30.208-30.72zM581.12 512a24.576 24.576 0 0 0 0 51.2 27.648 27.648 0 0 0 30.208-24.576 27.648 27.648 0 0 0-30.208-26.624zM502.784 395.776a28.672 28.672 0 0 0 30.208-30.72 28.672 28.672 0 0 0-30.208-30.72 33.792 33.792 0 0 0-35.84 30.72 33.792 33.792 0 0 0 35.84 30.72zM713.216 512a24.576 24.576 0 0 0 0 51.2 27.648 27.648 0 0 0 30.208-24.576 27.648 27.648 0 0 0-30.208-26.624z" fill="#3db214"></path>
              <path d="M512 0a512 512 0 1 0 512 512A512 512 0 0 0 512 0zM412.672 646.656a403.456 403.456 0 0 1-83.968-12.288l-83.968 43.008 24.064-73.728a201.216 201.216 0 0 1-96.256-165.376c0-116.224 108.032-207.872 240.128-207.872a240.128 240.128 0 0 1 242.688 172.032h-23.04a198.144 198.144 0 0 0-204.8 193.536 185.344 185.344 0 0 0 7.168 51.2zM768 732.672l17.92 60.928-66.048-36.864a296.96 296.96 0 0 1-72.192 12.288 191.488 191.488 0 0 1-204.8-177.664 191.488 191.488 0 0 1 204.8-177.664c108.032 0 204.8 79.872 204.8 177.664A185.856 185.856 0 0 1 768 732.672z" fill="#3db214"></path>
            </svg>
            <div class="qrcode_wrapper animated bounceIn">
              <div class="qrcode_wx"><canvas width="140" height="140"></canvas></div>
              <p>微信扫一扫</p>
            </div>
          </a>
          <a href="http://service.weibo.com/share/share.php?sharesource=weibo&amp;title=%E5%88%86%E4%BA%AB%EF%BC%9A14%E3%80%81ConcurrentHashMap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%EF%BC%8C%E5%8E%9F%E6%96%87%E9%93%BE%E6%8E%A5%EF%BC%9Ahttp://blog.shangsw.com/archives/concurrenthashmaphtml&amp;pic=http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg" target="_blank" rel="noopener noreferrer" title="分享到新浪微博">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="30" height="30">
              <path d="M480.8 457.76a271.04 271.04 0 0 0-37.28 2.72c-96 13.44-166.72 75.04-157.92 137.44s93.6 101.92 189.6 88.48 166.72-75.04 157.92-137.44c-7.68-54.08-73.12-91.04-152.32-91.2zm-23.36 211.52a122.08 122.08 0 0 1-24 2.4c-48 0-88-27.52-96-68.32-9.28-48 29.44-95.2 86.56-106.24s110.88 18.4 120 66.08-29.44 95.04-86.56 106.08z" fill="#F56467"></path>
              <path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28zm-43.84 666.88c-150.24 0-272-78.56-272-176S378.56 314.72 448 314.72c29.28 0 86.56 21.76 46.4 90.88a246.24 246.24 0 0 0 34.08-10.08c32-9.12 76.96-18.24 107.68 0 51.04 29.6 0 77.12 0 82.4s102.4 5.28 102.4 87.2c.32 96.48-120.16 175.04-270.4 175.04zm213.76-358.88a56 56 0 0 0-47.2-16 16.96 16.96 0 0 1-17.28-14.4 12.16 12.16 0 0 0 0 2.4v-4.8a12.16 12.16 0 0 0 0 2.4 20.48 20.48 0 0 1 17.28-17.28 77.28 77.28 0 0 1 68.32 18.56c32 28.48 18.72 75.68 18.72 75.68a21.28 21.28 0 0 1-20.48 17.28h-1.76a12.48 12.48 0 0 1-12.8-16.8 49.44 49.44 0 0 0-4.8-47.04zm120.16 60.64A29.6 29.6 0 0 1 776 467.84a22.08 22.08 0 0 1-19.68-25.92A139.2 139.2 0 0 0 736 336c-34.88-50.08-109.92-41.28-109.92-41.28A26.24 26.24 0 0 1 599.84 272v2.88-5.6V272a26.56 26.56 0 0 1 26.24-23.52 188.32 188.32 0 0 1 136.16 47.04c58.08 55.04 39.84 146.4 39.84 146.4z" fill="#F56467"></path>
              <path d="M459.36 547.04a17.6 17.6 0 1 0 17.6 17.6 17.6 17.6 0 0 0-17.6-17.6zm-44.32 23.2a43.52 43.52 0 0 0-18.4 4.32A32 32 0 0 0 376 613.12a32 32 0 0 0 42.88 9.12 32 32 0 0 0 20.64-38.72 25.76 25.76 0 0 0-24.48-13.28z" fill="#F56467"></path>
            </svg>
          </a>
          <a href="https://connect.qq.com/widget/shareqq/index.html?url=http://blog.shangsw.com/archives/concurrenthashmaphtml&amp;title=14%E3%80%81ConcurrentHashMap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90&amp;pics=http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg" target="_blank" rel="noopener noreferrer" title="分享到QQ">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="30" height="30">
              <path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28zM759.84 646.4c-9.6 8.16-20.8-6.08-29.76-20.32s-14.88-26.72-16-21.76a158.4 158.4 0 0 1-37.44 70.72c-1.28 1.6 28.8 12.48 37.44 35.68s24 57.6-80 68.8a145.76 145.76 0 0 1-80-16c-16.96-8.32-27.52-16-29.6-16a73.6 73.6 0 0 1-13.28 0 108 108 0 0 1-14.4 0c-1.76 0-22.24 32-113.12 32-70.4 0-88.64-44.32-74.4-68.8s37.76-32 34.4-35.36a192 192 0 0 1-34.4-57.6 98.56 98.56 0 0 1-4.16-13.44c-1.28-4.64-6.56 8.64-13.92 21.76s-14.4 22.72-22.88 22.72a11.52 11.52 0 0 1-6.56-2.4c-20.96-16-19.2-55.2-5.44-93.12s48-75.04 48-83.2c1.28-30.24-3.04-35.2 0-43.2 6.56-17.76 14.72-10.88 14.72-20.16 0-116.32 86.4-210.56 192.96-210.56s192.96 94.24 192.96 210.56c0 4.48 11.68 0 17.12 20.16a196.96 196.96 0 0 1 0 43.2c0 11.04 29.44 24.48 44.8 83.2S768 640 759.84 646.4z" fill="#68A5E1"></path>
            </svg>
          </a>
          <a href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://blog.shangsw.com/archives/concurrenthashmaphtml&amp;sharesource=qzone&amp;title=14%E3%80%81ConcurrentHashMap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90&amp;pics=http://gateway.shangsw.com/open-api/static/images/18/20190104.jpg" target="_blank" rel="noopener noreferrer" title="分享到QQ空间">
            <svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="30" height="30">
              <path d="M512 73.28A438.72 438.72 0 1 0 950.72 512 438.72 438.72 0 0 0 512 73.28zM829.92 432c5.6 16-150.24 146.4-150.24 146.4s2.08 12.64 4.16 22.08c0 0-72.64 2.24-132.32 0-32-1.28-69.12-7.04-69.12-7.04L656 470.24a1005.44 1005.44 0 0 0-125.76-13.6A908 908 0 0 0 380 463.36c-6.4 1.76 44.8 1.6 103.04 6.88 40.8 3.68 94.56 13.44 94.56 13.44l-172.8 128s73.92 4.48 140.32 4.16c74.72 0 142.24-9.92 142.72-8 12.96 56.16 36.96 167.52 28 176-12.16 12.32-185.6-97.6-185.6-97.6S368 785.6 345.92 785.6a3.68 3.68 0 0 1-2.08 0c-10.72-8.8 35.52-206.72 35.52-206.72S222.72 448 229.12 432s208-30.24 208-30.24 74.88-188 92.48-188 92.8 188 92.8 188S824.32 416 829.92 432z" fill="#F5BE3F"></path>
            </svg>
          </a>
          <a class="icon-share-link" href="javascript:;" rel="noopener noreferrer" title="复制文章链接">
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3509" width="30" height="30"><path d="M515.2 64c-246.4 0-448 198.4-448 444.8S268.8 953.6 512 953.6c246.4 0 444.8-201.6 444.8-444.8S758.4 64 515.2 64z m-118.4 441.6c-9.6 9.6-28.8 9.6-41.6 0l-22.4-25.6-12.8-9.6c-19.2-22.4-32-48-35.2-76.8 0-28.8 9.6-57.6 28.8-76.8 22.4-19.2 48-28.8 76.8-28.8 28.8 0 60.8 12.8 83.2 35.2l86.4 86.4c22.4 22.4 35.2 51.2 35.2 80 0 25.6-9.6 51.2-28.8 70.4-9.6 9.6-28.8 9.6-41.6 0-9.6-9.6-9.6-28.8 0-38.4 19.2-19.2 16-51.2-3.2-73.6l-86.4-86.4c-12.8-12.8-25.6-19.2-41.6-19.2-9.6 0-22.4 3.2-32 12.8-12.8 12.8-12.8 25.6-12.8 35.2 0 12.8 6.4 28.8 19.2 38.4l12.8 12.8 22.4 22.4c3.2 12.8 3.2 28.8-6.4 41.6z m307.2 201.6c-19.2 19.2-44.8 28.8-73.6 28.8-28.8 0-60.8-12.8-83.2-35.2l-86.4-86.4c-22.4-22.4-35.2-51.2-35.2-80 0-25.6 9.6-51.2 28.8-70.4 9.6-9.6 28.8-9.6 41.6 0 9.6 9.6 9.6 28.8 0 38.4-19.2 19.2-16 51.2 3.2 73.6l86.4 86.4c12.8 12.8 25.6 19.2 41.6 19.2 9.6 0 22.4-3.2 32-12.8 12.8-12.8 12.8-25.6 12.8-35.2 0-12.8-6.4-28.8-19.2-38.4l-25.6-25.6-9.6-9.6c-9.6-9.6-9.6-28.8 0-38.4 9.6-9.6 28.8-9.6 41.6 0l12.8 12.8 19.2 19.2c22.4 19.2 35.2 48 35.2 73.6 9.6 32-3.2 57.6-22.4 80z" fill="#989b9e"></path></svg>
          </a>
      </div>
    </li>
    <li class="post-operate-donate">
      <i class="joe-font joe-icon-shang"></i>
  <div class="joe_donate">
    
      <ol class="joe_donate_list two">
        <li><img src="./14、ConcurrentHashMap核心源码解析_files/支付宝收款.jpg" onerror="Joe.errorImg(this)" alt="qrcode alipay"></li>
        <li><img src="./14、ConcurrentHashMap核心源码解析_files/微信收款.jpg" onerror="Joe.errorImg(this)" alt="qrcode weixin"></li>
      </ol>
  </div>
    </li>
</ul>          <ul class="joe_post__pagination">
              <li class="joe_post__pagination-item prev"><a href="http://blog.shangsw.com/archives/iohtml" title="1、I/O模型">上一篇</a></li>
              <li class="joe_post__pagination-item next"><a href="http://blog.shangsw.com/archives/threadlocalhtml" title="13、ThreadLocal线程局部变量">下一篇</a></li>
          </ul>
            <div class="joe_comment">
  <div class="joe_comment_box">
    <h2>评论区</h2>
    <halo-comment id="132" type="post" configs="{&quot;autoLoad&quot;: &quot;true&quot;, &quot;showUserAgent&quot;: &quot;false&quot;, &quot;gravatarSource&quot;: &quot;https://sdn.geekzu.org/avatar&quot;, &quot;loadingStyle&quot;: &quot;default&quot;, &quot;authorPopup&quot;: &quot;你的昵称是啥呢？&quot;, &quot;emailPopup&quot;: &quot;你将收到回复通知&quot;, &quot;aWord&quot;: &quot;你是我一生只会遇见一次的惊喜 ...&quot;, &quot;avatarLoading&quot;: &quot;/themes/joe2.0/source/svg/spinner-preloader.svg&quot;, &quot;avatarError&quot;: &quot;/themes/joe2.0/source/img/error_avatar.jpg&quot;, &quot;notComment&quot;: &quot;暂无评论&quot;}" options="{&quot;blog_logo&quot;: &quot;/upload/2022/05/7.jpg&quot;, &quot;gravatar_source&quot;: &quot;//gravatar.com/avatar/&quot;, &quot;comment_gravatar_default&quot;: &quot;&quot;}"><template shadowrootmode="open"><style type="text/css">@charset "UTF-8";
.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #24292e;
  line-height: 1.5;
  font-size: 14px;
  word-wrap: break-word;
}
.markdown-body * {
    -webkit-box-sizing: border-box;
            box-sizing: border-box;
}
.markdown-body h1,
  .markdown-body h2,
  .markdown-body h3,
  .markdown-body h4,
  .markdown-body h5,
  .markdown-body h6 {
    margin-bottom: 10px;
    margin-top: 10px;
    font-weight: 600;
    color: var(--classF);
}
.markdown-body h1 {
    font-size: 2em;
    margin: .67em 0;
    font-size: 32px;
    font-size: 2em;
}
.markdown-body h2 {
    font-size: 24px;
    font-size: 1.5em;
}
.markdown-body h3 {
    font-size: 20px;
    font-size: 1.25em;
}
.markdown-body h4 {
    font-size: 16px;
    font-size: 1em;
}
.markdown-body h5 {
    font-size: 14px;
}
.markdown-body h6 {
    font-size: 14px;
    color: #6a737d;
    font-size: .85em;
}
.markdown-body h1,
  .markdown-body h2 {
    font-weight: 600;
    padding-bottom: .3em;
    line-height: 1.25;
    border-bottom: 1px solid var(--classE);
}
.markdown-body h4,
  .markdown-body h5,
  .markdown-body h6 {
    line-height: 1.2;
}
.markdown-body p {
    margin-bottom: 10px;
    margin-top: 0;
    line-height: 1.5;
    font-size: 14px;
}
.markdown-body p:last-child {
      margin-bottom: 0;
}
.markdown-body .octicon {
    display: inline-block;
    fill: currentColor;
    vertical-align: text-bottom;
}
.markdown-body .anchor {
    float: left;
    line-height: 1;
    margin-left: -20px;
    padding-right: 4px;
}
.markdown-body .anchor:focus {
      outline: none;
}
.markdown-body details {
    display: block;
}
.markdown-body details summary {
      cursor: pointer;
}
.markdown-body summary {
    display: list-item;
}
.markdown-body a {
    background-color: transparent;
    text-decoration: none;
}
.markdown-body a:hover {
      text-decoration: underline;
}
.markdown-body a:not([href]) {
      color: inherit;
      text-decoration: none;
}
.markdown-body strong {
    font-weight: inherit;
    font-weight: bolder;
    font-weight: 600;
}
.markdown-body img {
    border-style: none;
    -webkit-box-sizing: content-box;
            box-sizing: content-box;
    max-width: 100%;
}
.markdown-body hr {
    -webkit-box-sizing: content-box;
            box-sizing: content-box;
    height: 0;
    overflow: visible;
    background: transparent;
    border: 0;
    border-bottom: 1px solid #dfe2e5;
    height: 0;
    margin: 15px 0;
    overflow: hidden;
    background-color: #e1e4e8;
    border: 0;
    height: .25em;
    margin: 24px 0;
    padding: 0;
    border-bottom-color: #eee;
}
.markdown-body hr:before {
      content: "";
      display: table;
}
.markdown-body hr:after {
      clear: both;
      content: "";
      display: table;
}
.markdown-body input {
    font: inherit;
    margin: 0;
    overflow: visible;
    font-family: inherit;
    font-size: inherit;
    line-height: inherit;
}
.markdown-body [type=checkbox] {
    -webkit-box-sizing: border-box;
            box-sizing: border-box;
    padding: 0;
}
.markdown-body table {
    border-collapse: collapse;
    border-spacing: 0;
    display: table;
    overflow: auto;
}
.markdown-body table th {
      font-weight: 600;
}
.markdown-body table tr {
      background-color: #fff;
      border-top: 1px solid #c6cbd1;
}
.markdown-body table tr:nth-child(2n) {
        background-color: #f6f8fa;
}
.markdown-body blockquote {
    margin: 0;
    color: #6a737d;
    padding: 0 1em;
    border-left: .25em solid #dfe2e5;
}
.markdown-body blockquote > :first-child {
      margin-top: 0;
}
.markdown-body blockquote > :last-child {
      margin-bottom: 0;
}
.markdown-body dd {
    margin-left: 0;
}
.markdown-body .markdown-content pre {
    margin-top: 0;
    word-wrap: normal;
    white-space: pre;
    word-break: break-word;
}
.markdown-body .markdown-content pre > code {
      border: 0;
      font-size: 100%;
      margin: 0;
      padding: 0;
      white-space: inherit;
      word-break: break-word;
}
.markdown-body .markdown-content pre code {
      display: inline;
      line-height: inherit;
      margin: 0;
      overflow: visible;
      padding: 0;
      border: 0;
      color: var(--classF);
      word-wrap: normal;
      white-space: inherit;
      word-break: break-word;
      background-color: transparent;
}
.markdown-body li {
    word-wrap: break-all;
}
.markdown-body li > p {
      margin-top: 12px;
}
.markdown-body li + li {
      margin-top: .25em;
}
.markdown-body dl {
    padding: 0;
}
.markdown-body dl dt {
      font-size: 1em;
      font-style: italic;
      font-weight: 600;
      margin-top: 16px;
      padding: 0;
}
.markdown-body dl dd {
      margin-bottom: 16px;
      padding: 0 16px;
}
.markdown-body img[align=right] {
    padding-left: 20px;
}
.markdown-body img[align=left] {
    padding-right: 20px;
}
.markdown-body code {
    margin: 0;
    padding: .2em .4em;
    font-size: 85%;
    color: #666;
    color: var(--routine);
    background-color: #ebebeb;
    background-color: var(--classA);
    border-radius: 3px;
}
.markdown-body .highlight {
    margin-bottom: 16px;
}
.markdown-body .highlight pre {
      margin-bottom: 0;
      word-break: normal;
}
.markdown-body ol,
  .markdown-body ul {
    margin-bottom: 0;
    margin-top: 0;
    padding-left: 0;
    padding-left: 2em;
    list-style: auto;
    color: var(--routine);
}
.markdown-body .markdown-body td,
  .markdown-body .markdown-body th {
    padding: 0;
}
.markdown-body ol ol,
  .markdown-body ul ol {
    list-style-type: lower-roman;
}
.markdown-body ol ol ol,
  .markdown-body ol ul ol,
  .markdown-body ul ol ol,
  .markdown-body ul ul ol {
    list-style-type: lower-alpha;
}
.markdown-body input::-webkit-inner-spin-button,
  .markdown-body input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    appearance: none;
    margin: 0;
}
.markdown-body blockquote,
  .markdown-body dl,
  .markdown-body ol,
  .markdown-body p,
  .markdown-body pre,
  .markdown-body table,
  .markdown-body ul {
    margin-bottom: 10px;
    margin-top: 0;
}
.markdown-body ul {
    list-style: disc;
}
.markdown-body ol ol,
  .markdown-body ol ul,
  .markdown-body ul ol,
  .markdown-body ul ul {
    margin-bottom: 0;
    margin-top: 0;
}
.markdown-body table td,
  .markdown-body table th {
    border: 1px solid #dfe2e5;
    padding: 6px 12px;
}
.markdown-body pre,
.markdown-body code,
.markdown-content pre,
.markdown-content code {
  font-size: 12px;
}
.markdown-body .highlight pre,
.markdown-body pre,
.markdown-content .highlight pre,
.markdown-content pre {
  font-size: 85%;
  line-height: 1.45;
  overflow: auto;
  padding: 12px;
  background-color: #ebebeb;
  background-color: var(--classA);
  border-radius: 3px;
}

/*--------------------------------------------------------------
  # Normalize
--------------------------------------------------------------*/
html.disable-scroll {
  height: 100vh;
  overflow: hidden;
}
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
  background-color: #eee;
}
::-webkit-scrollbar-track {
  background-color: #eee;
}
::-webkit-scrollbar-thumb {
  background-color: var(--theme);
}
div {
  -webkit-transition: top 0.8s ease;
  transition: top 0.8s ease;
}
.no-select {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
.halo-comment {
  font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
}
.halo-comment a {
    text-decoration: none;
    color: var(--theme);
}
.halo-comment input::-webkit-input-placeholder,
  .halo-comment textarea::-webkit-input-placeholder {
    color: #cccccc;
}
.halo-comment button,
  .halo-comment input,
  .halo-comment textarea {
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    -webkit-appearance: none;
    outline: none;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}
.halo-comment button:focus,
  .halo-comment input:focus,
  .halo-comment textarea:focus {
    outline: none;
}
.halo-comment ol,
  .halo-comment ul {
    list-style: none;
}

/*--------------------------------------------------------------
  # Comment
--------------------------------------------------------------*/
.halo-comment {
  position: relative;
  -webkit-box-sizing: border-box;
          box-sizing: border-box;
  text-align: left;
  font-size: 14px;
  font-weight: normal;
  line-height: 1.5;
  color: #313131;
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-animation: main 0.6s;
          animation: main 0.6s;
  /*--------------------------------------------------------------
    # Loading
  --------------------------------------------------------------*/
  /*--------------------------------------------------------------
    # CommmentLoader
  --------------------------------------------------------------*/
  /*--------------------------------------------------------------
    # CommmentNode
  --------------------------------------------------------------*/
  /*--------------------------------------------------------------
    # Commment Editor
  --------------------------------------------------------------*/
  /*--------------------------------------------------------------
    # Commment Empty
    --------------------------------------------------------------*/
  /*--------------------------------------------------------------
    # Commment Pagination
    --------------------------------------------------------------*/
}
.halo-comment input[type="text"],
  .halo-comment input[type="email"],
  .halo-comment input[type="url"],
  .halo-comment input[type="password"],
  .halo-comment input[type="search"],
  .halo-comment input[type="number"],
  .halo-comment input[type="tel"],
  .halo-comment input[type="range"],
  .halo-comment input[type="date"],
  .halo-comment input[type="month"],
  .halo-comment input[type="week"],
  .halo-comment input[type="time"],
  .halo-comment input[type="datetime"],
  .halo-comment input[type="datetime-local"],
  .halo-comment input[type="color"],
  .halo-comment textarea {
    color: #666;
    border: 1px solid #ccc;
    border-radius: 5px;
}
.halo-comment .avatar {
    background-color: #f5f5f5;
}
.halo-comment .comment-load-button {
    margin: 30px 0;
    text-align: center;
}
.halo-comment .comment-loader-container {
    -webkit-animation: top20 500ms;
            animation: top20 500ms;
    position: relative;
    text-align: center;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-pack: center;
        -ms-flex-pack: center;
            justify-content: center;
    margin: 30px 0;
}
.halo-comment .comment-loader-container .comment-loader-default {
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
          -ms-flex-flow: row nowrap;
              flex-flow: row nowrap;
      -webkit-box-align: center;
          -ms-flex-align: center;
              align-items: center;
      -webkit-box-pack: justify;
          -ms-flex-pack: justify;
              justify-content: space-between;
      width: 30px;
}
.halo-comment .comment-loader-container .comment-loader-default span {
        width: 4px;
        height: 15px;
        background-color: #898c7b;
}
.halo-comment .comment-loader-container .comment-loader-default span:nth-of-type(1) {
          -webkit-animation: grow 1s -0.45s ease-in-out infinite;
                  animation: grow 1s -0.45s ease-in-out infinite;
}
.halo-comment .comment-loader-container .comment-loader-default span:nth-of-type(2) {
          -webkit-animation: grow 1s -0.3s ease-in-out infinite;
                  animation: grow 1s -0.3s ease-in-out infinite;
}
.halo-comment .comment-loader-container .comment-loader-default span:nth-of-type(3) {
          -webkit-animation: grow 1s -0.15s ease-in-out infinite;
                  animation: grow 1s -0.15s ease-in-out infinite;
}
.halo-comment .comment-loader-container .comment-loader-default span:nth-of-type(4) {
          -webkit-animation: grow 1s ease-in-out infinite;
                  animation: grow 1s ease-in-out infinite;
}
@-webkit-keyframes grow {
0%,
  100% {
    -webkit-transform: scaleY(1);
            transform: scaleY(1);
}
50% {
    -webkit-transform: scaleY(2);
            transform: scaleY(2);
}
}
@keyframes grow {
0%,
  100% {
    -webkit-transform: scaleY(1);
            transform: scaleY(1);
}
50% {
    -webkit-transform: scaleY(2);
            transform: scaleY(2);
}
}
.halo-comment .comment-loader-container .comment-loader-circle {
      border: 3px solid #898c7b;
      border-top-color: #fff;
      border-radius: 50%;
      width: 2.5em;
      height: 2.5em;
      -webkit-animation: spin 0.7s linear infinite;
              animation: spin 0.7s linear infinite;
}
@-webkit-keyframes spin {
to {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
}
}
@keyframes spin {
to {
    -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
}
}
.halo-comment .comment-loader-container .comment-loader-balls {
      width: 3.5em;
      display: -webkit-box;
      display: -ms-flexbox;
      display: flex;
      -webkit-box-orient: horizontal;
      -webkit-box-direction: normal;
          -ms-flex-flow: row nowrap;
              flex-flow: row nowrap;
      -webkit-box-align: center;
          -ms-flex-align: center;
              align-items: center;
      -webkit-box-pack: justify;
          -ms-flex-pack: justify;
              justify-content: space-between;
}
.halo-comment .comment-loader-container .comment-loader-balls div {
        width: 0.7em;
        height: 0.7em;
        border-radius: 50%;
        background-color: #898c7b;
        -webkit-transform: translateY(-100%);
                transform: translateY(-100%);
        -webkit-animation: wave 0.7s ease-in-out alternate infinite;
                animation: wave 0.7s ease-in-out alternate infinite;
}
.halo-comment .comment-loader-container .comment-loader-balls div:nth-of-type(1) {
          -webkit-animation-delay: -0.4s;
                  animation-delay: -0.4s;
}
.halo-comment .comment-loader-container .comment-loader-balls div:nth-of-type(2) {
          -webkit-animation-delay: -0.2s;
                  animation-delay: -0.2s;
}
.halo-comment .commentwrap {
    width: 100%;
    margin: 0 auto 10px;
    padding: 0;
    /*--------------------------------------------------------------
        # Commment Children #5 修复层次过多的BUG
        --------------------------------------------------------------*/
}
.halo-comment .commentwrap .comment-wrp {
      padding: 10px 0 16px 0;
      border-bottom: 1px solid #ddd;
}
.halo-comment .commentwrap .comment-wrp li {
        clear: both;
}
.halo-comment .commentwrap .comment-wrp:first-child {
        padding-top: 0;
}
.halo-comment .commentwrap .comment-wrp:last-child {
        padding-bottom: 0;
        border: none;
}
.halo-comment .commentwrap .children {
      padding-left: 40px;
      margin: 0;
      clear: both;
}
.halo-comment .commentwrap .children .comment-wrp:last-child {
        border: none;
}
.halo-comment .commentwrap .children main {
        width: 100%;
}
.halo-comment .commentwrap .children .profile {
        float: left;
        margin-top: 4px;
}
.halo-comment .commentwrap .children .profile img {
          height: 40px;
          width: 40px;
}
.halo-comment .commentwrap .children .children .children .children .children .children {
        margin: 0;
        padding: 0;
}
@media screen and (max-width: 500px) {
.halo-comment .commentwrap .children {
        padding-left: 20px;
}
}
.halo-comment .comment {
    margin: 0;
    padding: 0;
    overflow: hidden;
    list-style: none;
    /*--------------------------------------------------------------
        # CommmentAvatar
        --------------------------------------------------------------*/
    /*--------------------------------------------------------------
        # CommmentUserInfo
        --------------------------------------------------------------*/
    /*--------------------------------------------------------------
        # CommmentReply
        --------------------------------------------------------------*/
    /*--------------------------------------------------------------
        # Commment Body
        --------------------------------------------------------------*/
}
.halo-comment .comment .contents {
      width: 100%;
      padding-top: 10px;
      float: left;
}
.halo-comment .comment .contents:hover .comment-reply-link {
        opacity: 0.9;
}
.halo-comment .comment .main {
      float: right;
      width: 100%;
      padding: 0;
}
.halo-comment .comment .main.shadow img.avatar {
        -webkit-transition: all ease 1s;
        transition: all ease 1s;
        -webkit-box-shadow: 0 1px 10px -6px rgba(0, 0, 0, 0.5);
                box-shadow: 0 1px 10px -6px rgba(0, 0, 0, 0.5);
}
.halo-comment .comment .main.shadow .profile:hover img.avatar {
        -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
}
.halo-comment .comment .profile {
      float: left;
      margin-right: 10px;
      margin-top: 6px;
}
.halo-comment .comment .profile a.disabled {
        pointer-events: none;
}
.halo-comment .comment .profile img {
        width: 100%;
        max-width: 40px;
        height: 40px;
        border-radius: 100%;
        -webkit-transition: opacity 0.15s ease-out;
        transition: opacity 0.15s ease-out;
}
.halo-comment .comment .profile img:hover {
          opacity: 0.8;
}
@media (max-width: 880px) {
.halo-comment .comment .profile {
          display: none;
}
}
.halo-comment .comment .commeta {
      font-size: 16px;
      margin-bottom: 5px;
      text-transform: uppercase;
      color: #9499a8;
      margin-left: 50px;
}
.halo-comment .comment .commeta .bb-comment {
        position: relative;
        top: -1px;
        display: inline-block;
        min-width: 30px;
        text-align: center;
        font-size: 12px;
        color: #fb7299;
        font-weight: 400;
        -webkit-transform: scale(0.9);
                transform: scale(0.9);
        border: 1px solid #fb7299;
        border-radius: 4px;
}
.halo-comment .comment .commeta .comment-time {
        display: inline-block;
        margin-top: 6px;
        font-size: 12px;
        color: #657786;
}
.halo-comment .comment .commeta .info {
        margin-top: 2px;
        font-size: 12px;
        letter-spacing: 0px;
        text-transform: none;
        color: rgba(0, 0, 0, 0.35);
}
.halo-comment .comment .commeta .info .useragent-info img {
          vertical-align: sub;
          width: 14px;
          height: 14px;
          border: 0;
}
@media (max-width: 480px) {
.halo-comment .comment .commeta .info .useragent-info {
            display: none;
}
}
.halo-comment .comment .commeta .info .useragent-info-m {
          margin-top: 2px;
          font-size: 12px;
          letter-spacing: 0px;
          text-transform: none;
          color: rgba(0, 0, 0, 0.35);
          display: none;
}
.halo-comment .comment .commeta .info .useragent-info-m img {
            vertical-align: sub;
            width: 14px;
            height: 14px;
            border: 0;
}
@media (max-width: 480px) {
.halo-comment .comment .commeta .info .useragent-info-m {
              display: inline;
}
}
@media (max-width: 880px) {
.halo-comment .comment .commeta {
          margin-left: 0;
}
}
.halo-comment .comment .author {
      font-size: 24px;
      font-weight: 400;
      margin: 0;
      letter-spacing: 0px;
      text-transform: none;
      line-height: 20px;
}
.halo-comment .comment .author a {
        color: var(--theme);
        font-size: 14px;
        font-weight: 600;
}
.halo-comment .comment .author a.disabled {
          pointer-events: none;
}
.halo-comment .comment .author a:hover {
          color: var(--theme);
}
.halo-comment .comment .author img {
        display: none;
        border-radius: 3px;
        margin-right: 5px;
        vertical-align: -4px;
}
@media (max-width: 880px) {
.halo-comment .comment .author img {
            display: inline-block;
}
}
.halo-comment .comment .comment-reply-link {
      font-size: 12px;
      display: block;
      margin-left: 10px;
      float: right;
      text-transform: uppercase;
      color: #fff;
      background-color: var(--theme);
      line-height: 20px;
      padding: 0 6px;
      border-radius: 3px;
      opacity: 0;
}
.halo-comment .comment .comment-reply-link:hover {
        opacity: 1;
}
@media (max-width: 880px) {
.halo-comment .comment .comment-reply-link {
        opacity: 1;
}
}
.halo-comment .comment .body {
      color: #63686d;
      position: relative;
}
.halo-comment .comment .body > *:last-child {
        margin-bottom: 0;
}
.halo-comment .comment .body p {
        font-size: 14px;
        line-height: 1.5;
        color: #63686d;
}
.halo-comment .comment .body p a {
          position: relative;
          color: var(--theme);
}
.halo-comment .comment .body p a:after {
            content: "";
            position: absolute;
            width: 100%;
            -webkit-transform: scaleX(0);
                    transform: scaleX(0);
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: var(--theme);
            -webkit-transform-origin: bottom right;
                    transform-origin: bottom right;
            -webkit-transition: -webkit-transform 0.25s ease-out;
            transition: -webkit-transform 0.25s ease-out;
            transition: transform 0.25s ease-out;
            transition: transform 0.25s ease-out, -webkit-transform 0.25s ease-out;
}
.halo-comment .comment .body p a:hover:after {
            -webkit-transform: scaleX(1);
                    transform: scaleX(1);
            -webkit-transform-origin: bottom left;
                    transform-origin: bottom left;
}
.halo-comment .comment .body p p {
          display: inline;
}
@media (max-width: 580px) {
.halo-comment .comment .body p {
            margin: 0;
            font-size: 13px;
            line-height: 1.7;
}
}
.halo-comment .comment .body .comment-at {
        color: #99ce00;
        text-decoration: none;
}
.halo-comment .comment .body .comment-at:after {
          bottom: -2px;
          background-color: #99ce00;
}
.halo-comment .markdown-body {
    margin-bottom: 15px;
    line-height: 1;
    white-space: pre-line;
    word-break: break-all;
    font-size: 14px !important;
}
.halo-comment .markdown-body .markdown-content {
      padding: 10px;
      white-space: pre-line;
      word-break: break-all;
      background: var(--sub-background);
      border-radius: 0 8px 8px;
}
.halo-comment .markdown-body .markdown-content.blink {
        -webkit-animation: blink 0.3s linear infinite alternate;
                animation: blink 0.3s linear infinite alternate;
}
@-webkit-keyframes blink {
from {
    -webkit-filter: brightness(1);
            filter: brightness(1);
}
from {
    -webkit-filter: brightness(0.5);
            filter: brightness(0.5);
}
}
@keyframes blink {
from {
    -webkit-filter: brightness(1);
            filter: brightness(1);
}
from {
    -webkit-filter: brightness(0.5);
            filter: brightness(0.5);
}
}
.halo-comment .markdown-body img {
      max-width: 100%;
}
.halo-comment .markdown-body .emoji-item {
      display: inline-block;
      padding: 0;
      overflow: hidden;
      color: #333;
      background-color: transparent;
}
@media (max-width: 860px) {
.halo-comment .markdown-body .emoji-item {
          -webkit-transform: scale(0.8);
                  transform: scale(0.8);
}
}
.halo-comment .markdown-body .emoji-item img {
        position: relative;
        top: -3px;
        display: block;
        max-width: 100%;
        width: auto;
        height: 26px;
        margin: 2px auto 0;
        border: 0;
}
.halo-comment .markdown-body .emoji-item.text {
        width: auto;
        height: auto;
        padding: 2px 6px;
        font-size: 14px;
}
.halo-comment .markdown-body .emoji-animate {
      position: relative;
      top: 10px;
      width: 32px;
      height: 32px;
}
.halo-comment .markdown-body .emoji-animate .img {
        width: 32px;
        height: 864px;
        max-width: 32px;
        background: top/32px no-repeat;
        background-image: none;
        -webkit-animation: im-emotion-step 1.08s steps(27) infinite;
                animation: im-emotion-step 1.08s steps(27) infinite;
}
.halo-comment .markdown-body .emoji-img {
      position: relative;
      top: 4px;
      height: 1.4em;
      max-height: 1.4em;
}
.halo-comment .markdown-body .comment_inline_img {
      cursor: pointer;
      display: inline-block;
      max-height: 150px;
      margin-right: 3px;
      padding: 3px;
      background-color: #fff;
      border: 1px solid var(--classC);
      border-radius: 4px;
}
@media screen and (max-width: 880px) {
.halo-comment .markdown-body {
        padding-left: 0;
}
}
.halo-comment .comment-editor {
    -webkit-box-sizing: border-box;
            box-sizing: border-box;
    margin: 0 auto;
    -webkit-animation: top20 500ms;
            animation: top20 500ms;
    /*--------------------------------------------------------------
      # Commment Reply Form 
    --------------------------------------------------------------*/
}
.halo-comment .comment-editor input:focus, .halo-comment .comment-editor input:active,
    .halo-comment .comment-editor textarea:focus,
    .halo-comment .comment-editor textarea:active {
      outline: 0;
}
.halo-comment .comment-editor input::-webkit-input-placeholder,
    .halo-comment .comment-editor textarea::-webkit-input-placeholder {
      color: #999;
}
.halo-comment .comment-editor input::-moz-placeholder,
    .halo-comment .comment-editor textarea::-moz-placeholder {
      opacity: 1;
      color: #999;
}
.halo-comment .comment-editor input::-ms-input-placeholder,
    .halo-comment .comment-editor textarea::-ms-input-placeholder {
      color: #999;
}
.halo-comment .comment-editor .comment-form {
      outline: none;
      /*--------------------------------------------------------------
        # Commment Reply Form - Text
      --------------------------------------------------------------*/
      /*--------------------------------------------------------------
       # Commment Reply Form - Body
      --------------------------------------------------------------*/
      /*--------------------------------------------------------------
       # Commment Reply Form - AuthorInfo
      --------------------------------------------------------------*/
      /*--------------------------------------------------------------
       # Commment Reply Form - SubmitButtom
      --------------------------------------------------------------*/
}
.halo-comment .comment-editor .comment-form input,
      .halo-comment .comment-editor .comment-form textarea {
        font-size: 14px;
        width: 31.3%;
        margin: 0;
        padding: 10px;
        color: #535a63;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
}
.halo-comment .comment-editor .comment-form textarea {
        resize: vertical;
        display: block;
        float: none;
        width: 100%;
        height: 180px;
        min-height: 100px;
        margin-bottom: 10px;
        color: #535a63;
}
.halo-comment .comment-editor .comment-form textarea:focus {
          border-color: var(--theme);
}
.halo-comment .comment-editor .comment-form input {
        width: 100%;
}
.halo-comment .comment-editor .comment-form input:last-of-type {
          margin-right: 0;
}
.halo-comment .comment-editor .comment-form input:focus {
          border-color: #cccccc;
}
.halo-comment .comment-editor .comment-form .comment-textarea {
        position: relative;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:focus {
          border-color: var(--theme);
          -webkit-transition: border-color 0.25s;
          transition: border-color 0.25s;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:placeholder-shown::-webkit-input-placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:placeholder-shown::-moz-placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:placeholder-shown:-ms-input-placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:placeholder-shown::-ms-input-placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:-moz-placeholder-shown::placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:-ms-input-placeholder::placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:placeholder-shown::placeholder {
          color: transparent;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:not(:-moz-placeholder-shown) ~ .input-label {
          color: #fff;
          background-color: var(--theme);
          transform: scale(0.75) translate(-2px, -37px);
          border-radius: 5px;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:not(:-ms-input-placeholder) ~ .input-label {
          color: #fff;
          background-color: var(--theme);
          transform: scale(0.75) translate(-2px, -37px);
          border-radius: 5px;
}
.halo-comment .comment-editor .comment-form .comment-textarea .commentbody:not(:placeholder-shown) ~ .input-label,
        .halo-comment .comment-editor .comment-form .comment-textarea .commentbody:focus ~ .input-label {
          color: #fff;
          background-color: var(--theme);
          -webkit-transform: scale(0.75) translate(-2px, -37px);
                  transform: scale(0.75) translate(-2px, -37px);
          border-radius: 5px;
}
.halo-comment .comment-editor .comment-form .comment-textarea .input-label {
          position: absolute;
          left: 10px;
          top: 10px;
          color: #666;
          padding: 0 6px;
          -webkit-transform-origin: 0 0;
                  transform-origin: 0 0;
          pointer-events: none;
          -webkit-transition: all 0.25s;
          transition: all 0.25s;
}
.halo-comment .comment-editor .comment-form .comment-preview {
        position: relative;
        -webkit-box-sizing: border-box;
                box-sizing: border-box;
        display: block;
        float: none;
        width: 100%;
        height: 180px;
        margin: 0 0 10px;
        padding: 10px;
        white-space: pre-line;
        word-break: break-word;
        font-size: 14px !important;
        line-height: 1.5;
        overflow-y: auto;
        -webkit-box-shadow: none;
                box-shadow: none;
        color: #535a63;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 3px;
}
.halo-comment .comment-editor .comment-form .comment-preview img {
          max-width: 100%;
}
.halo-comment .comment-editor .comment-form .author-info {
        /*--------------------------------------------------------------
         # Commment Reply Form - Popup
        --------------------------------------------------------------*/
}
.halo-comment .comment-editor .comment-form .author-info .commentator {
          position: absolute;
          display: inline-block;
          width: 38px;
          height: 38px;
          pointer-events: none;
          margin-top: 10px;
}
.halo-comment .comment-editor .comment-form .author-info .commentator img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
}
.halo-comment .comment-editor .comment-form .author-info .commentator .socila-check {
            display: none;
            width: 1.5em;
            height: 1.5em;
            font-size: 1em;
            line-height: 1.5em;
            text-align: center;
            color: #fff;
            border-radius: 50%;
            position: absolute;
            margin: -28px 0 0 42px;
}
.halo-comment .comment-editor .comment-form .author-info .commentator .gravatar-check {
            background-color: #1e8cbe;
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
}
.halo-comment .comment-editor .comment-form .author-info .commentator .qq-check {
            background-color: #99ce00;
}
@media (max-width: 625px) {
.halo-comment .comment-editor .comment-form .author-info .commentator {
              display: none;
}
.halo-comment .comment-editor .comment-form .author-info .commentator .socila-check {
                width: 1.5em;
                height: 1.5em;
                font-size: 0.5em;
                line-height: 1.5em;
                margin: -40% 0 0 77%;
}
}
.halo-comment .comment-editor .comment-form .author-info .cmt-popup {
          margin: 0 0 10px 1%;
          -webkit-box-flex: 1;
              -ms-flex: 1;
                  flex: 1;
          --widthB: calc(var(--widthA) - 71px);
          --widthC: calc(var(--widthB) / 3);
          width: var(--widthC);
          margin-top: 10px;
}
.halo-comment .comment-editor .comment-form .author-info .cmt-popup.cmt-author {
            margin-left: 54px;
}
@media (max-width: 625px) {
.halo-comment .comment-editor .comment-form .author-info .cmt-popup {
              margin: 0;
              width: 100%;
              margin-top: 15px;
}
.halo-comment .comment-editor .comment-form .author-info .cmt-popup.cmt-author {
                margin-right: 8px;
                margin-left: 0;
}
}
@media (min-width: 625px) {
.halo-comment .comment-editor .comment-form .author-info {
            width: 100%;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-box-direction: normal;
                -ms-flex-flow: row nowrap;
                    flex-flow: row nowrap;
            -webkit-box-pack: justify;
                -ms-flex-pack: justify;
                    justify-content: space-between;
            -webkit-box-align: stretch;
                -ms-flex-align: stretch;
                    align-items: stretch;
}
}
.halo-comment .comment-editor .comment-form .comment-buttons {
        font-size: 14px;
        text-align: right;
        margin-top: 10px;
}
.halo-comment .comment-editor .comment-form .comment-buttons .middle {
          display: inline-block;
          vertical-align: middle;
}
.halo-comment .comment-editor .comment-form .comment-buttons .button-submit,
        .halo-comment .comment-editor .comment-form .comment-buttons .button-preview-edit {
          opacity: 0.9;
          display: inline-block;
          margin-left: 5px;
          color: #fff;
          font-weight: 500;
          padding: 4px 12px;
          text-transform: uppercase;
          background: var(--theme);
          border: 1px solid var(--theme);
          border-radius: 4px;
          -webkit-animation: bottom20 500ms;
                  animation: bottom20 500ms;
          -webkit-transition: all 0.3s ease 0s;
          transition: all 0.3s ease 0s;
}
.halo-comment .comment-editor .comment-form .comment-buttons .button-submit:hover,
          .halo-comment .comment-editor .comment-form .comment-buttons .button-preview-edit:hover {
            opacity: 1;
            font-weight: 700;
            letter-spacing: 3px;
            -webkit-box-shadow: 0px 5px 40px -10px rgba(0, 0, 0, 0.57);
                    box-shadow: 0px 5px 40px -10px rgba(0, 0, 0, 0.57);
            -webkit-transition: all 0.3s ease 0s;
            transition: all 0.3s ease 0s;
}
.halo-comment .comment-editor .comment-form .comment-buttons .button-cancel-reply {
          opacity: .9;
          display: inline-block;
          color: var(--minor);
          font-weight: 500;
          padding: 4px 12px;
          text-transform: uppercase;
          background: transparent;
          border: 1px solid var(--minor);
          border-radius: 4px;
          -webkit-animation: bottom20 .5s;
                  animation: bottom20 .5s;
          -webkit-transition: all .3s ease 0s;
          transition: all .3s ease 0s;
}
.halo-comment .comment-editor .comment-form .comment-buttons .button-cancel-reply:hover {
            opacity: 1;
            font-weight: 700;
            letter-spacing: 3px;
            -webkit-box-shadow: 0px 5px 40px -10px rgba(0, 0, 0, 0.57);
                    box-shadow: 0px 5px 40px -10px rgba(0, 0, 0, 0.57);
            -webkit-transition: all 0.3s ease 0s;
            transition: all 0.3s ease 0s;
}
@media (max-width: 1080px) {
.halo-comment .comment-editor input {
        width: 100%;
        margin-bottom: 14px;
}
}
.halo-comment .comment-empty {
    margin: 30px 0;
    text-align: center;
    color: #999;
}
.halo-comment .comment-page {
    padding-top: 20px;
    text-align: center;
    border-top: 3px solid var(--classD);
}
.halo-comment .comment-page .page {
      display: inline-block;
      padding: 10px 0;
      margin: 0;
}
.halo-comment .comment-page .page li {
        display: inline;
        margin: 0 3px;
        color: var(--main);
}
.halo-comment .comment-page .page button {
        position: relative;
        font-size: inherit;
        font-family: inherit;
        height: 32px;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: normal;
        color: var(--main);
        background-color: var(--sub-background);
        border: 1px solid var(--classE);
}
.halo-comment .comment-page .page button svg {
          display: none;
          fill: var(--main);
}
.halo-comment .comment-page .page button:hover {
          color: var(--theme);
          border-color: var(--theme);
}
.halo-comment .comment-page .page button:hover svg {
            fill: var(--theme);
}
.halo-comment .comment-page .page button.prev-button:before {
          display: block;
          content: "上一页";
}
.halo-comment .comment-page .page button.next-button:before {
          display: block;
          content: "下一页";
}
.halo-comment .comment-page .page .active {
        color: var(--theme);
        border-color: var(--theme);
}
@media (max-width: 500px) {
.halo-comment .comment-page .page button {
        height: 32px;
        padding: 4px 8px;
}
.halo-comment .comment-page .page button.prev-button {
          position: relative;
          top: 4px;
}
.halo-comment .comment-page .page button.prev-button:before {
            display: none;
}
.halo-comment .comment-page .page button.prev-button svg {
            display: block;
}
.halo-comment .comment-page .page button.next-button {
          position: relative;
          top: 4px;
}
.halo-comment .comment-page .page button.next-button:before {
            display: none;
}
.halo-comment .comment-page .page button.next-button svg {
            display: block;
}
}
.halo-comment.halo-comment__small .comment-wrp {
    padding: 10px 0;
}
.halo-comment.dark .avatar {
    background-color: #3e3e3e;
}
.halo-comment.dark input::-webkit-input-placeholder,
  .halo-comment.dark textarea::-webkit-input-placeholder {
    color: #777;
}
.halo-comment.dark input::-moz-placeholder,
  .halo-comment.dark textarea::-moz-placeholder {
    color: #777;
}
.halo-comment.dark input::-ms-input-placeholder,
  .halo-comment.dark textarea::-ms-input-placeholder {
    color: #777;
}
.halo-comment.dark .comment-editor .comment-textarea textarea {
    color: #b3b3b3;
    background: #2e2e2e;
    border-color: #555;
}
.halo-comment.dark .comment-editor #emotion-toggle {
    color: #ccc;
}
.halo-comment.dark .comment-editor .author-info input {
    color: #b3b3b3;
    background: #2e2e2e;
    border-color: #555;
}
.halo-comment.dark .comment-wrp {
    border-color: #4e4e4e;
}
.halo-comment.dark .comment-wrp .commeta .info {
      color: #848484;
}
.halo-comment.dark .comment-wrp .commeta .comment-time {
      color: #848484;
}
.halo-comment.dark .comment-editor .comment-form .comment-preview {
    color: #b3b3b3;
    background: #2e2e2e;
    border-color: #555;
}
.halo-comment.dark .comment-empty {
    color: #666;
}
.halo-comment.dark .comment .body p {
    color: #999;
}

/*--------------------------------------------------------------
# Commment Reply Form - Emoji
--------------------------------------------------------------*/
#emotion-toggle {
  cursor: pointer;
  text-align: center;
  margin-bottom: 5px;
}
#container-emoji {
  background: var(--sub-background);
}
.emoji-fade-enter-active,
.emoji-fade-leave-active {
  -webkit-transition: all 0.8s ease;
  transition: all 0.8s ease;
}
.emoji-fade-enter,
.emoji-fade-leave-to {
  opacity: 0;
  -webkit-transform: translateY(-10px);
          transform: translateY(-10px);
}
.emotion-box {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: horizontal;
  -webkit-box-direction: normal;
  -ms-flex-direction: row;
  flex-direction: row;
  -ms-flex-wrap: wrap;
  flex-wrap: wrap;
  /*--------------------------------------------------------------
    # Emoji Category
    --------------------------------------------------------------*/
  /*--------------------------------------------------------------
    # Emoji List
    --------------------------------------------------------------*/
}
.emotion-box .category-enter,
  .emotion-box .category-leave-to {
    opacity: 0;
}
.emotion-box .category-enter-active,
  .emotion-box .category-leave-active {
    -webkit-transition: all 0.2s ease;
    transition: all 0.2s ease;
}
.emotion-box .category-enter {
    -webkit-transform: translateX(10px);
            transform: translateX(10px);
}
.emotion-box .category-leave-to {
    -webkit-transform: translateX(-10px);
            transform: translateX(-10px);
}
.emotion-box .motion-switcher-table {
    border-collapse: collapse;
    width: 100%;
    margin: 0;
    table-layout: fixed;
}
.emotion-box .motion-switcher-table tr {
      color: #e2e2e2;
      color: var(--classF);
}
.emotion-box .motion-switcher-table th,
    .emotion-box .motion-switcher-table td {
      cursor: pointer;
      padding: 8px;
      text-align: center;
      border-radius: 5px 5px 0 0;
}
.emotion-box .motion-switcher-table th:hover {
      color: var(--theme);
}
.emotion-box .motion-switcher-table .on-hover {
      color: var(--theme);
      background-color: rgba(245, 245, 245, 0.5);
      background-color: var(--sub-background);
}
.emotion-box .motion-container {
    height: 110px;
    overflow: auto;
    margin-bottom: 5px;
    padding: 6px 6px 0 16px;
    border-radius: 0 0 5px 5px;
}
.emotion-box .motion-container .emoji-item {
      cursor: pointer;
      display: inline-block;
      width: 30px;
      height: 30px;
      padding: 3px;
      margin: 3px;
      overflow: hidden;
      color: #333;
      color: var(--main);
      border-radius: 4px;
}
@media (max-width: 860px) {
.emotion-box .motion-container .emoji-item {
          -webkit-transform: scale(0.8);
                  transform: scale(0.8);
          margin-bottom: -10px;
}
}
.emotion-box .motion-container .emoji-item img {
        display: block;
        max-width: 100%;
        width: auto;
        height: 26px;
        margin: 3px auto 0;
        border: 0;
}
.emotion-box .motion-container .emoji-item:hover {
        background-color: #e9e9e9;
        background-color: var(--classB);
}
.emotion-box .motion-container .emoji-item.text {
        width: auto;
        height: auto;
        padding: 2px 6px;
        font-size: 14px;
}
.emotion-box .motion-container .emotion-secter,
    .emotion-box .motion-container .emoji-animate {
      width: 32px;
      height: 32px;
}
.emotion-box .motion-container .emotion-secter .img,
      .emotion-box .motion-container .emoji-animate .img {
        width: 32px;
        height: 864px;
        max-width: 32px;
        background: top/32px no-repeat;
        background-image: none;
        -webkit-animation: im-emotion-step 1.08s steps(27) infinite;
                animation: im-emotion-step 1.08s steps(27) infinite;
}
@media (max-width: 860px) {
.emotion-box .motion-container .emotion-secter,
        .emotion-box .motion-container .emoji-animate {
          -webkit-transform: scale(0.8);
                  transform: scale(0.8);
          margin-bottom: -10px;
}
}
@media (max-width: 860px) {
.emotion-box .motion-container.bilibili-container, .emotion-box .motion-container.tieba-container, .emotion-box .motion-container.haha-container {
        padding-left: 0;
}
}
.emotion-box .motion-container.haha-container img {
      height: 24px;
}
.emotion-box .motion-container a {
      background-color: transparent;
      text-decoration: none;
}
.emotion-box .motion-container a {
      color: #e67474;
      outline: none;
      -webkit-transition: color 0.2s ease-out, border 0.2s ease-out, opacity 0.2s ease-out;
      transition: color 0.2s ease-out, border 0.2s ease-out, opacity 0.2s ease-out;
}
.emotion-box .motion-container .emotion-select-parent {
      overflow: hidden;
      padding: 1px 2px;
      background-size: 32px auto;
      background-repeat: no-repeat;
      background-position: center;
}
.emotion-box .motion-container .emotion-select-parent:hover {
        background-image: none !important;
}
.emotion-box .motion-container .emotion-select-parent:hover .emotion-select-child {
          display: block;
}
.emotion-box .motion-container .emotion-select-child {
      display: none;
}
.emotion-box .motion-container .emotion-secter {
      margin: 12px 12px 0 0;
}
@media (max-width: 860px) {
.emotion-box .motion-container .emotion-secter {
          margin: 0;
}
.emotion-box .motion-container .emotion-secter .emotion-select-parent:hover {
            background-image: none !important;
            -webkit-transform: scale(0.6, 0.6);
            transform: scale(0.6, 0.6);
}
}

/*--------------------------------------------------------------
# Popup
--------------------------------------------------------------*/
.popup {
  position: relative;
  display: inline-block;
  cursor: pointer;
}
.popup .popuptext {
    width: auto;
    padding: 8px 10px;
    background-color: #555;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    position: absolute;
    z-index: 1;
    bottom: 110%;
    left: 50%;
    margin-left: -80px;
}
.popup .popuptext:after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: #555 transparent transparent;
}
.popup .fade-enter-active,
  .popup .fade-enter-to {
    -webkit-transition: opacity 1s;
    transition: opacity 1s;
}
.popup .fade-enter,
  .popup .fade-leave-to {
    opacity: 0;
}

/*--------------------------------------------------------------
# Default Tips
--------------------------------------------------------------*/
.butterBar {
  position: absolute;
  text-align: center;
  top: 10px;
  right: 0px;
  z-index: 1000;
}
.butterBar.butterBar-center {
    margin: auto;
}
.butterBar .butterBar-message {
    display: inline-block;
    margin: 0;
    padding: 8px 20px;
    font-size: 14px;
    color: #fff;
    background: #fe9600;
    border-radius: 18px 0 0 18px;
    -webkit-box-shadow: -2px 4px 10px -5px #f74009;
            box-shadow: -2px 4px 10px -5px #f74009;
    -webkit-animation: dung 0.3s 0.1s 2 linear;
            animation: dung 0.3s 0.1s 2 linear;
}
.butterBar .butterBar-message.success {
      background: #31c560;
      -webkit-box-shadow: -2px 4px 10px -5px #07600a;
              box-shadow: -2px 4px 10px -5px #07600a;
}
.butterBar .butterBar-message.danger {
      background: #e74b32;
      -webkit-box-shadow: -2px 4px 10px -5px #e10000;
              box-shadow: -2px 4px 10px -5px #e10000;
}

/*--------------------------------------------------------------
# Keyframes
--------------------------------------------------------------*/
@-webkit-keyframes main {
0% {
    opacity: 0;
    -webkit-transform: translateY(50px);
            transform: translateY(50px);
}
100% {
    opacity: 1;
    -webkit-transform: translateY(0);
            transform: translateY(0);
}
}
@keyframes main {
0% {
    opacity: 0;
    -webkit-transform: translateY(50px);
            transform: translateY(50px);
}
100% {
    opacity: 1;
    -webkit-transform: translateY(0);
            transform: translateY(0);
}
}
@-webkit-keyframes dung {
0% {
    -webkit-transform: translateY(0);
    transform: translateY(0);
}
30% {
    -webkit-transform: translateY(-3px);
    transform: translateY(-3px);
}
60% {
    -webkit-transform: translateY(2px);
    transform: translateY(2px);
}
80% {
    -webkit-transform: translateY(-1px);
    transform: translateY(-1px);
}
90% {
    -webkit-transform: translateY(1px);
    transform: translateY(1px);
}
100% {
    -webkit-transform: translateY(0);
    transform: translateY(0);
}
}
@keyframes dung {
0% {
    -webkit-transform: translateY(0);
    transform: translateY(0);
}
30% {
    -webkit-transform: translateY(-3px);
    transform: translateY(-3px);
}
60% {
    -webkit-transform: translateY(2px);
    transform: translateY(2px);
}
80% {
    -webkit-transform: translateY(-1px);
    transform: translateY(-1px);
}
90% {
    -webkit-transform: translateY(1px);
    transform: translateY(1px);
}
100% {
    -webkit-transform: translateY(0);
    transform: translateY(0);
}
}
@-webkit-keyframes bottom20 {
0% {
    opacity: 0;
    -webkit-transform: translateY(20px);
            transform: translateY(20px);
}
100% {
    opacity: 1;
    -webkit-transform: translateY(0);
            transform: translateY(0);
}
}
@keyframes bottom20 {
0% {
    opacity: 0;
    -webkit-transform: translateY(20px);
            transform: translateY(20px);
}
100% {
    opacity: 1;
    -webkit-transform: translateY(0);
            transform: translateY(0);
}
}
@-webkit-keyframes wave {
from {
    -webkit-transform: translateY(-100%);
            transform: translateY(-100%);
}
to {
    -webkit-transform: translateY(100%);
            transform: translateY(100%);
}
}
@keyframes wave {
from {
    -webkit-transform: translateY(-100%);
            transform: translateY(-100%);
}
to {
    -webkit-transform: translateY(100%);
            transform: translateY(100%);
}
}
@-webkit-keyframes im-emotion-step {
0% {
    -webkit-transform: translateY(0);
    transform: translateY(0);
}
to {
    -webkit-transform: translateY(-100%);
    transform: translateY(-100%);
}
}
@keyframes im-emotion-step {
0% {
    -webkit-transform: translateY(0);
    transform: translateY(0);
}
to {
    -webkit-transform: translateY(-100%);
    transform: translateY(-100%);
}
}
@-webkit-keyframes top20 {
0% {
    opacity: 0;
    -webkit-transform: translateY(-20px);
            transform: translateY(-20px);
}
100% {
    opacity: 1;
    -webkit-transform: translateY(0);
            transform: translateY(0);
}
}
@keyframes top20 {
0% {
    opacity: 0;
    -webkit-transform: translateY(-20px);
            transform: translateY(-20px);
}
100% {
    opacity: 1;
    -webkit-transform: translateY(0);
            transform: translateY(0);
}
}
</style><div id="halo-comment" class="halo-comment"><section id="respond-0" role="form" class="comment-editor bottom-comment"><form class="comment-form"><div class="comment-textarea"><textarea required="required" aria-required="true" tabindex="4" placeholder="你是我一生只会遇见一次的惊喜 ..." class="commentbody"></textarea><label class="input-label">你是我一生只会遇见一次的惊喜 ...</label></div><div id="upload-img-show"></div><p id="emotion-toggle" class="no-select"><span>戳我试试 OωO</span></p><!----><div class="author-info"><div class="commentator"><img src="https://sdn.geekzu.org/avatar/d41d8cd98f00b204e9800998ecf8427e?s=256&amp;d=mm" class="avatar"><div class="socila-check gravatar-check"><i aria-hidden="true" class="fa fa-google"></i></div></div><div class="popup cmt-popup cmt-author" id="author"><span class="popuptext" style="margin-left: -115px; display: none;"> 你的昵称是啥呢？ </span><input type="text" required="required" aria-required="true" placeholder="* 昵称"></div><div class="popup cmt-popup" id="email"><span class="popuptext" style="margin-left: -65px; display: none;"> 你将收到回复通知 </span><input type="text" required="required" aria-required="true" placeholder="* 邮箱"></div><div class="popup cmt-popup" id="url"><span class="popuptext" style="margin-left: -55px; display: none;"> 禁止小广告😀 </span><input type="text" required="required" aria-required="true" placeholder="个人站点"></div></div><ul class="comment-buttons"><!----><!----><li class="middle"><a href="javascript:;" tabindex="5" rel="nofollow noopener" class="button-submit">提交</a></li></ul></form></section><!----><div class="comment-loader-container" style="display: none;"><div class="comment-loader-default"><span></span><span></span><span></span><span></span></div></div><!----><div class="comment-empty"> 暂无评论 </div><!----></div></template>
  </halo-comment></div>
            </div>
        </div>
<aside class="joe_aside">
  <section class="joe_aside__item author">
  <img width="100%" height="120" class="image ls-is-cached lazyloaded" data-src="/themes/joe2.0/source/img/author_bg.jpg" src="./14、ConcurrentHashMap核心源码解析_files/author_bg.jpg" onerror="Joe.errorImg(this)" alt="博主栏壁纸">
  <div class="user">
    <div class="avatar_wrapper circle">
      <img class="avatar lazyloaded" data-src="/upload/2022/05/4.jpg" src="./14、ConcurrentHashMap核心源码解析_files/4.jpg" onerror="Joe.errorImg(this)" alt="博主头像">
    </div>
    <a class="link" href="http://blog.shangsw.com/" target="_blank" rel="noopener noreferrer nofollow">
      林雷<img class="level" src="./14、ConcurrentHashMap核心源码解析_files/level_4.svg" onerror="Joe.errorImg(this)" alt="博主等级">
    </a>
      <p class="motto joe_motto"> 斜月沉沉藏海雾，碣石潇湘无限路</p>
  </div>
  <div class="count">
        <div class="item" title="累计分类数 7">
          <span class="num">7</span>
          <span>分类数</span>
        </div>
        <div class="item" title="累计文章数 132">
          <span class="num">132</span>
          <span>文章数</span>
        </div>
        <div class="item" title="累计评论数 3">
          <span class="num">3</span>
          <span>评论数</span>
        </div>
  </div>
  <div class="social-account">
      <a class="github" href="https://github.com/linmeitianqing" target="_blank" title="Github" rel="noopener noreferrer nofollow">
        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M512 95.872a426.666667 426.666667 0 0 0-134.912 831.445333c21.333333 3.754667 29.312-9.045333 29.312-20.266666 0-10.112-0.512-43.733333-0.512-79.445334-107.221333 19.712-134.954667-26.154667-143.488-50.133333a155.136 155.136 0 0 0-43.733333-60.288c-14.933333-7.978667-36.266667-27.733333-0.554667-28.245333a85.376 85.376 0 0 1 65.621333 43.733333 91.178667 91.178667 0 0 0 124.245334 35.2 89.770667 89.770667 0 0 1 27.221333-57.088c-94.933333-10.666667-194.133333-47.445333-194.133333-210.645333a166.058667 166.058667 0 0 1 43.733333-114.688 153.344 153.344 0 0 1 4.266667-113.066667s35.712-11.178667 117.333333 43.733333a402.218667 402.218667 0 0 1 213.333333 0c81.578667-55.466667 117.333333-43.733333 117.333334-43.733333a153.301333 153.301333 0 0 1 4.266666 113.066667 165.077333 165.077333 0 0 1 43.733334 114.688c0 163.712-99.754667 199.978667-194.688 210.645333a101.034667 101.034667 0 0 1 28.8 78.933333c0 57.088-0.512 102.954667-0.512 117.333334 0 11.221333 7.978667 24.533333 29.312 20.266666A426.88 426.88 0 0 0 512 95.872z" fill="var(--title)"></path></svg>
      </a>
      <a class="juejin" href="https://juejin.cn/user/4248942900163198" target="_blank" title="掘金社区" rel="noopener noreferrer nofollow">
        <svg viewBox="0 0 32 24" version="1.1" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M15.0737 5.80396H15.0757L18.706 2.91722L15.0757 0.00406298L15.0717 0L11.4475 2.91112L15.0717 5.80193L15.0737 5.80396ZM15.0757 14.9111L15.0778 14.9091L24.4429 7.52057L21.9036 5.48096L15.0778 10.8664L15.0757 10.8685L15.0737 10.8705L8.2479 5.48502L5.71057 7.52463L15.0737 14.9132L15.0757 14.9111ZM15.0716 19.9614L15.0757 19.9593L27.614 10.066L30.1534 12.1056L24.449 16.6053L15.0757 24L0.243779 12.3047L0 12.1117L2.53936 10.0721L15.0716 19.9614Z" fill="#1E80FF"></path></svg>
      </a>
      <a class="qq" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1336706009&amp;site=qq&amp;menu=yes" target="_blank" title="QQ" rel="noopener noreferrer nofollow">
        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="20" height="22"><path d="M511.09761 957.257c-80.159 0-153.737-25.019-201.11-62.386-24.057 6.702-54.831 17.489-74.252 30.864-16.617 11.439-14.546 23.106-11.55 27.816 13.15 20.689 225.583 13.211 286.912 6.767v-3.061z" fill="#FAAD08"></path><path d="M496.65061 957.257c80.157 0 153.737-25.019 201.11-62.386 24.057 6.702 54.83 17.489 74.253 30.864 16.616 11.439 14.543 23.106 11.55 27.816-13.15 20.689-225.584 13.211-286.914 6.767v-3.061z" fill="#FAAD08"></path><path d="M497.12861 474.524c131.934-0.876 237.669-25.783 273.497-35.34 8.541-2.28 13.11-6.364 13.11-6.364 0.03-1.172 0.542-20.952 0.542-31.155C784.27761 229.833 701.12561 57.173 496.64061 57.162 292.15661 57.173 209.00061 229.832 209.00061 401.665c0 10.203 0.516 29.983 0.547 31.155 0 0 3.717 3.821 10.529 5.67 33.078 8.98 140.803 35.139 276.08 36.034h0.972z" fill="#000000"></path><path d="M860.28261 619.782c-8.12-26.086-19.204-56.506-30.427-85.72 0 0-6.456-0.795-9.718 0.148-100.71 29.205-222.773 47.818-315.792 46.695h-0.962C410.88561 582.017 289.65061 563.617 189.27961 534.698 185.44461 533.595 177.87261 534.063 177.87261 534.063 166.64961 563.276 155.56661 593.696 147.44761 619.782 108.72961 744.168 121.27261 795.644 130.82461 796.798c20.496 2.474 79.78-93.637 79.78-93.637 0 97.66 88.324 247.617 290.576 248.996a718.01 718.01 0 0 1 5.367 0C708.80161 950.778 797.12261 800.822 797.12261 703.162c0 0 59.284 96.111 79.783 93.637 9.55-1.154 22.093-52.63-16.623-177.017" fill="#000000"></path><path d="M434.38261 316.917c-27.9 1.24-51.745-30.106-53.24-69.956-1.518-39.877 19.858-73.207 47.764-74.454 27.875-1.224 51.703 30.109 53.218 69.974 1.527 39.877-19.853 73.2-47.742 74.436m206.67-69.956c-1.494 39.85-25.34 71.194-53.24 69.956-27.888-1.238-49.269-34.559-47.742-74.435 1.513-39.868 25.341-71.201 53.216-69.974 27.909 1.247 49.285 34.576 47.767 74.453" fill="#FFFFFF"></path><path d="M683.94261 368.627c-7.323-17.609-81.062-37.227-172.353-37.227h-0.98c-91.29 0-165.031 19.618-172.352 37.227a6.244 6.244 0 0 0-0.535 2.505c0 1.269 0.393 2.414 1.006 3.386 6.168 9.765 88.054 58.018 171.882 58.018h0.98c83.827 0 165.71-48.25 171.881-58.016a6.352 6.352 0 0 0 1.002-3.395c0-0.897-0.2-1.736-0.531-2.498" fill="#FAAD08"></path><path d="M467.63161 256.377c1.26 15.886-7.377 30-19.266 31.542-11.907 1.544-22.569-10.083-23.836-25.978-1.243-15.895 7.381-30.008 19.25-31.538 11.927-1.549 22.607 10.088 23.852 25.974m73.097 7.935c2.533-4.118 19.827-25.77 55.62-17.886 9.401 2.07 13.75 5.116 14.668 6.316 1.355 1.77 1.726 4.29 0.352 7.684-2.722 6.725-8.338 6.542-11.454 5.226-2.01-0.85-26.94-15.889-49.905 6.553-1.579 1.545-4.405 2.074-7.085 0.242-2.678-1.834-3.786-5.553-2.196-8.135" fill="#000000"></path><path d="M504.33261 584.495h-0.967c-63.568 0.752-140.646-7.504-215.286-21.92-6.391 36.262-10.25 81.838-6.936 136.196 8.37 137.384 91.62 223.736 220.118 224.996H506.48461c128.498-1.26 211.748-87.612 220.12-224.996 3.314-54.362-0.547-99.938-6.94-136.203-74.654 14.423-151.745 22.684-215.332 21.927" fill="#FFFFFF"></path><path d="M323.27461 577.016v137.468s64.957 12.705 130.031 3.91V591.59c-41.225-2.262-85.688-7.304-130.031-14.574" fill="#EB1C26"></path><path d="M788.09761 432.536s-121.98 40.387-283.743 41.539h-0.962c-161.497-1.147-283.328-41.401-283.744-41.539l-40.854 106.952c102.186 32.31 228.837 53.135 324.598 51.926l0.96-0.002c95.768 1.216 222.4-19.61 324.6-51.924l-40.855-106.952z" fill="#EB1C26"></path></svg>
      </a>
      <a class="email" href="mailto:linlixishang@163.com" target="_blank" title="邮箱" rel="noopener noreferrer nofollow">
        <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="21" height="22"><path d="M512 938.666667C276.352 938.666667 85.333333 747.648 85.333333 512S276.352 85.333333 512 85.333333s426.666667 191.018667 426.666667 426.666667-191.018667 426.666667-426.666667 426.666667z m341.333333-426.666667a341.333333 341.333333 0 1 0-169.301333 294.869333l-43.008-73.685333A256 256 0 1 1 768 512v42.666667a42.666667 42.666667 0 0 1-85.333333 0V384h-57.770667a170.666667 170.666667 0 1 0 2.816 253.44A128 128 0 0 0 853.333333 554.666667v-42.666667z m-341.333333-85.333333a85.333333 85.333333 0 1 1 0 170.666666 85.333333 85.333333 0 0 1 0-170.666666z" fill="#dc4835"></path></svg>
      </a>
  </div>
    <canvas id="canvas-strips" width="300" height="340"></canvas>
    <script src="./14、ConcurrentHashMap核心源码解析_files/strips.js.下载"></script>
</section>  <div class="joe_aside_post">
      <div class="toc-container is-position-fixed" style="display: block;">
        <h3 class="toc-header"><i class="joe-font joe-icon-xiaoxi" title="文章目录"></i>文章目录</h3>
        <div id="js-toc" class="toc"><ol class="toc-list "><li class="toc-list-item"><a title="一 ConcurrentHashMap核心源码解析" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#%E4%B8%80-concurrenthashmap%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90" class="toc-link node-name--H1 ">一 ConcurrentHashMap核心源码解析</a><ol class="toc-list "><li class="toc-list-item"><a title="1.1 ConcurrentHashMap概览" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.1-concurrenthashmap%E6%A6%82%E8%A7%88" class="toc-link node-name--H2 ">1.1 ConcurrentHashMap概览</a><ol class="toc-list "><li class="toc-list-item"><a title="1.1.1 Node对象" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.1.1-node%E5%AF%B9%E8%B1%A1" class="toc-link node-name--H3 ">1.1.1 Node对象</a></li><li class="toc-list-item"><a title="1.1.2 CAS和哈希函数" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.1.2-cas%E5%92%8C%E5%93%88%E5%B8%8C%E5%87%BD%E6%95%B0" class="toc-link node-name--H3 ">1.1.2 CAS和哈希函数</a></li><li class="toc-list-item"><a title="1.1.3 构造函数" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.1.3-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0" class="toc-link node-name--H3 ">1.1.3 构造函数</a></li></ol></li><li class="toc-list-item"><a title="1.2 get, 获取元素" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.2-get%2C-%E8%8E%B7%E5%8F%96%E5%85%83%E7%B4%A0" class="toc-link node-name--H2 ">1.2 get, 获取元素</a></li><li class="toc-list-item"><a title="1.3 put, 存放元素" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3-put%2C-%E5%AD%98%E6%94%BE%E5%85%83%E7%B4%A0" class="toc-link node-name--H2 ">1.3 put, 存放元素</a><ol class="toc-list "><li class="toc-list-item"><a title="1.3.1 初始化数组" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84" class="toc-link node-name--H3 ">1.3.1 初始化数组</a></li><li class="toc-list-item"><a title="1.3.2 存放数据" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.2-%E5%AD%98%E6%94%BE%E6%95%B0%E6%8D%AE" class="toc-link node-name--H3 ">1.3.2 存放数据</a></li><li class="toc-list-item"><a title="1.3.3 哈希碰撞的解决之道" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.3-%E5%93%88%E5%B8%8C%E7%A2%B0%E6%92%9E%E7%9A%84%E8%A7%A3%E5%86%B3%E4%B9%8B%E9%81%93" class="toc-link node-name--H3 ">1.3.3 哈希碰撞的解决之道</a><ol class="toc-list "><li class="toc-list-item"><a title="1.3.3.1 转换为红黑树" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.3.1-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E7%BA%A2%E9%BB%91%E6%A0%91" class="toc-link node-name--H4 ">1.3.3.1 转换为红黑树</a></li></ol></li><li class="toc-list-item is-active-li"><a title="1.3.4 数组移动" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.4-%E6%95%B0%E7%BB%84%E7%A7%BB%E5%8A%A8" class="toc-link node-name--H3  is-active-link">1.3.4 数组移动</a></li><li class="toc-list-item"><a title="1.3.5 容器计数" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.5-%E5%AE%B9%E5%99%A8%E8%AE%A1%E6%95%B0" class="toc-link node-name--H3 ">1.3.5 容器计数</a><ol class="toc-list "><li class="toc-list-item"><a title="1.3.5.1 统计计数" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.5.1-%E7%BB%9F%E8%AE%A1%E8%AE%A1%E6%95%B0" class="toc-link node-name--H4 ">1.3.5.1 统计计数</a></li><li class="toc-list-item"><a title="1.3.5.2 扩容" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.5.2-%E6%89%A9%E5%AE%B9" class="toc-link node-name--H4 ">1.3.5.2 扩容</a></li><li class="toc-list-item"><a title="1.3.5.3 多线程辅助数组移动" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.3.5.3-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E8%BE%85%E5%8A%A9%E6%95%B0%E7%BB%84%E7%A7%BB%E5%8A%A8" class="toc-link node-name--H4 ">1.3.5.3 多线程辅助数组移动</a></li></ol></li></ol></li><li class="toc-list-item"><a title="1.4 size, 获取元素数量" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.4-size%2C-%E8%8E%B7%E5%8F%96%E5%85%83%E7%B4%A0%E6%95%B0%E9%87%8F" class="toc-link node-name--H2 ">1.4 size, 获取元素数量</a></li><li class="toc-list-item"><a title="1.5 小结" href="http://blog.shangsw.com/archives/concurrenthashmaphtml#1.5-%E5%B0%8F%E7%BB%93" class="toc-link node-name--H2 ">1.5 小结</a></li></ol></li></ol></div>
      </div>
  <section class="joe_aside__item newest">
    <div class="joe_aside__item-title">
      <i class="joe-font joe-icon-huo"></i>
      <span class="text">相关文章</span>
    </div>
    <div class="joe_aside__item-contain"> 
        <ul class="list">       
              <li class="item">
                <a class="link" target="_blank" href="http://blog.shangsw.com/archives/scheduledthreadpoolexecutorhtml" title="11、ScheduledThreadPoolExecutor源码解析">11、ScheduledThreadPoolExecutor源码解析</a>
                <i class="joe-font joe-icon-link"></i>
              </li>
              <li class="item">
                <a class="link" target="_blank" href="http://blog.shangsw.com/archives/aqshtml" title="1、AbstractQueuedSynchronizer原理分析">1、AbstractQueuedSynchronizer原理分析</a>
                <i class="joe-font joe-icon-link"></i>
              </li>
              <li class="item">
                <a class="link" target="_blank" href="http://blog.shangsw.com/archives/reentrantlockhtml" title="2、ReentrantLock源码解析">2、ReentrantLock源码解析</a>
                <i class="joe-font joe-icon-link"></i>
              </li>
              <li class="item">
                <a class="link" target="_blank" href="http://blog.shangsw.com/archives/countdownlatchhtml" title="3、CountDownLatch源码解析">3、CountDownLatch源码解析</a>
                <i class="joe-font joe-icon-link"></i>
              </li>
        </ul>
    </div>
  </section>
  </div>
</aside>      </div>
        <div class="joe_progress_bar" style="width: 53.7955%;"></div>

  <div class="joe_action">
      <div class="joe_action_item toc">
        <i class="joe-font joe-icon-xiaoxi" title="文章目录"></i>
      </div>
      <div class="joe_action_item mode">
        <svg class="mode-light" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="25" height="25">
          <path d="M234.24 512a277.76 277.76 0 1 0 555.52 0 277.76 277.76 0 1 0-555.52 0zM512 187.733a42.667 42.667 0 0 1-42.667-42.666v-102.4a42.667 42.667 0 0 1 85.334 0v102.826A42.667 42.667 0 0 1 512 187.733zm-258.987 107.52a42.667 42.667 0 0 1-29.866-12.373l-72.96-73.387a42.667 42.667 0 0 1 59.306-59.306l73.387 72.96a42.667 42.667 0 0 1 0 59.733 42.667 42.667 0 0 1-29.867 12.373zm-107.52 259.414H42.667a42.667 42.667 0 0 1 0-85.334h102.826a42.667 42.667 0 0 1 0 85.334zm34.134 331.946a42.667 42.667 0 0 1-29.44-72.106l72.96-73.387a42.667 42.667 0 0 1 59.733 59.733l-73.387 73.387a42.667 42.667 0 0 1-29.866 12.373zM512 1024a42.667 42.667 0 0 1-42.667-42.667V878.507a42.667 42.667 0 0 1 85.334 0v102.826A42.667 42.667 0 0 1 512 1024zm332.373-137.387a42.667 42.667 0 0 1-29.866-12.373l-73.387-73.387a42.667 42.667 0 0 1 0-59.733 42.667 42.667 0 0 1 59.733 0l72.96 73.387a42.667 42.667 0 0 1-29.44 72.106zm136.96-331.946H878.507a42.667 42.667 0 1 1 0-85.334h102.826a42.667 42.667 0 0 1 0 85.334zM770.987 295.253a42.667 42.667 0 0 1-29.867-12.373 42.667 42.667 0 0 1 0-59.733l73.387-72.96a42.667 42.667 0 1 1 59.306 59.306l-72.96 73.387a42.667 42.667 0 0 1-29.866 12.373z"></path>
        </svg>
        <svg class="mode-dark active" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="25" height="25">
          <path d="M587.264 104.96c33.28 57.856 52.224 124.928 52.224 196.608 0 218.112-176.128 394.752-393.728 394.752-29.696 0-58.368-3.584-86.528-9.728C223.744 832.512 369.152 934.4 538.624 934.4c229.376 0 414.72-186.368 414.72-416.256 1.024-212.992-159.744-389.12-366.08-413.184z"></path>
          <path d="M340.48 567.808l-23.552-70.144-70.144-23.552 70.144-23.552 23.552-70.144 23.552 70.144 70.144 23.552-70.144 23.552-23.552 70.144zM168.96 361.472l-30.208-91.136-91.648-30.208 91.136-30.208 30.72-91.648 30.208 91.136 91.136 30.208-91.136 30.208-30.208 91.648z"></path>
        </svg>
      </div>
      <div class="joe_action_item back2top active">
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="25" height="25">
          <path d="M725.902 498.916c18.205-251.45-93.298-410.738-205.369-475.592l-6.257-3.982-6.258 3.414c-111.502 64.853-224.711 224.142-204.8 475.59-55.751 53.476-80.214 116.623-80.214 204.8v15.36l179.2-35.27c11.378 40.39 58.596 69.973 113.21 69.973 54.613 0 101.262-29.582 112.64-68.836l180.337 36.41v-15.36c-.569-89.885-25.031-153.6-82.489-206.507zM571.733 392.533c-33.564 31.29-87.04 28.445-118.329-5.12s-28.444-87.04 5.12-117.76c33.565-31.289 87.04-28.444 118.33 5.12s28.444 86.471-5.12 117.76zm-56.32 368.64c-35.84 0-64.284 29.014-64.284 64.285 0 35.84 54.044 182.613 64.284 182.613s64.285-146.773 64.285-182.613c0-35.271-29.014-64.285-64.285-64.285z"></path>
        </svg>
      </div>
  </div>
  <footer class="joe_footer">
      <div class="joe_container central">
        <div class="item">
          <p>
            2024 ©<a href="http://blog.shangsw.com/" target="_blank" rel="noopener noreferrer">林雷</a>
             - <a class="icp" href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer nofollow">京ICP备19045739号</a>
          </p>
          
        </div>
        <div class="side-col">
      </div>
      </div>
  </footer>
    </div>
  <script src="./14、ConcurrentHashMap核心源码解析_files/lazysizes.min.js.下载"></script>
  <script src="./14、ConcurrentHashMap核心源码解析_files/qmsg.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/marked.min.js.下载"></script>
  <script src="./14、ConcurrentHashMap核心源码解析_files/utils.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/tocbot.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/vue.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/halo-comment.min.js.下载"></script>
  <script src="./14、ConcurrentHashMap核心源码解析_files/jquery.fancybox.min.js.下载"></script>
  <script src="./14、ConcurrentHashMap核心源码解析_files/custom.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/clipboard.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/jquery.qrcode.min.js.下载"></script>

  <script src="./14、ConcurrentHashMap核心源码解析_files/common.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/prism.min.js.下载"></script>
    <script src="./14、ConcurrentHashMap核心源码解析_files/post.min.js.下载"></script>

    
  
</body><div style="all: initial;"><div id="__hcfy__" style="all: initial;"><template shadowrootmode="open"><style>#root{-webkit-text-size-adjust:100%;box-sizing:border-box;font-size:14px;font-weight:400;letter-spacing:0;line-height:1.28581;text-transform:none;color:#182026;font-family:-apple-system,"BlinkMacSystemFont","Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Open Sans","Helvetica Neue","Icons16",sans-serif;touch-action:manipulation}#root>.bp5-portal{z-index:9999999999}</style><link rel="stylesheet" href="chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/normalize.css"><link rel="stylesheet" href="chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/blueprint.css"><link rel="stylesheet" href="chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/blueprint-select.css"><link rel="stylesheet" href="chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/cropper.css"><style>#translate-panel{background-color:#f6f7f9;display:flex;flex-direction:column;padding-bottom:8px}.bp5-dark #translate-panel{background-color:#252a31}#translate-panel .fixed{flex-shrink:0;margin-bottom:10px}#translate-panel .body{flex-grow:1;overflow:auto;overscroll-behavior:contain}#translate-panel .body::-webkit-scrollbar{width:8px;background-color:rgba(0,0,0,0);-webkit-border-radius:100px}#translate-panel .body::-webkit-scrollbar:hover{background-color:rgba(0,0,0,.09)}#translate-panel .body::-webkit-scrollbar-thumb:vertical{background:rgba(0,0,0,.5);-webkit-border-radius:100px}#translate-panel .body::-webkit-scrollbar-thumb:vertical:active{background:rgba(0,0,0,.61);-webkit-border-radius:100px}#translate-panel.size-small,#translate-panel.size-small h6.bp5-heading,#translate-panel.size-small .bp5-control.bp5-large,#translate-panel.size-small textarea.bp5-input.bp5-small{font-size:14px}#translate-panel.size-small .phonetic-item,#translate-panel.size-small .quick-settings a{font-size:12px}#translate-panel.size-middle,#translate-panel.size-middle h6.bp5-heading,#translate-panel.size-middle .bp5-control.bp5-large,#translate-panel.size-middle textarea.bp5-input{font-size:18px}#translate-panel.size-middle .phonetic-item,#translate-panel.size-middle .quick-settings a{font-size:14px}#translate-panel.size-large,#translate-panel.size-large h6.bp5-heading,#translate-panel.size-large .bp5-control.bp5-large,#translate-panel.size-large textarea.bp5-input.bp5-large{font-size:22px}#translate-panel.size-large .source,#translate-panel.size-large .phonetic-item,#translate-panel.size-large .quick-settings a{font-size:18px}#translate-panel .bp5-button.bp5-small,#translate-panel .bp5-small .bp5-button{min-height:20px;min-width:20px}#translate-panel .header{display:flex;align-items:center;padding:4px 6px 4px 10px;border-bottom:1px solid #d1d1d1}.bp5-dark #translate-panel .header{border-bottom-color:rgba(17,20,24,.4)}#translate-panel .header .drag-block{min-width:5px;flex-shrink:0;flex-grow:1;align-self:stretch}#translate-panel .header .left{flex-shrink:0;display:flex}#translate-panel .header .right{flex-shrink:0;display:flex;align-items:center}#translate-panel .header .right .bp5-icon-arrow-right{flex-shrink:0;margin:0 5px}#translate-panel .header .right>.bp5-button{flex-shrink:0;margin:0 1px}#translate-panel .header .right>.bp5-button:last-child{margin-right:0}#translate-panel .quick-settings{padding:4px 9px;margin:0 1px}#translate-panel .quick-settings>div{margin-bottom:5px}#translate-panel .quick-settings .bp5-control{margin-bottom:0}#translate-panel .query-text{position:relative;padding:10px 10px 2px 10px}#translate-panel .query-text textarea.bp5-input{min-height:44px;font-family:system-ui,-apple-system,"Segoe UI","Roboto","Ubuntu","Cantarell","Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";overscroll-behavior:contain}#translate-panel .query-text .translate-btn{position:absolute;opacity:.6}#translate-panel .query-text .translate-btn:hover{opacity:1}#translate-panel .body{padding:0 10px}#translate-panel .body .bp5-card:first-child{margin-top:1px}#translate-panel .body .bp5-card:last-child{margin-bottom:1px}#translate-panel .body .no-api{margin:20px 0}.result-block{margin:8px 0;padding:2px 5px}.result-block .bp5-button{visibility:hidden}.result-block .error .bp5-button,.result-block:hover .bp5-button{visibility:visible}.result-block .legend{display:flex;align-items:center;justify-content:space-between}.result-block .legend .legend-left{display:flex;align-items:center}.result-block .legend .api-ico,.result-block .legend .bp5-heading{flex-shrink:0;white-space:nowrap}.result-block .legend .api-ico{display:inline-block;width:14px;height:14px;background-size:contain;margin-right:3px}.result-block .legend .bp5-heading{margin-bottom:0;margin-right:10px}.result-block .legend .source{cursor:pointer;font-size:12px;display:inline-flex;align-items:center}.result-block .legend .source .source-text{overflow:hidden}.result-block .legend .source .bp5-icon{position:relative;top:-1px;margin-left:1px}.result-block .phonetic{display:flex;flex-wrap:wrap}.result-block .phonetic .phonetic-item{display:flex;align-items:center;font-size:12px}.result-block .phonetic .phonetic-item:not(:last-child){margin-right:12px}.result-block .common-result p{line-height:1.3;margin:2px 0;overflow-wrap:break-word}.result-block .common-result .dict a{text-decoration:underline}.result-block .error{font-size:12px;padding:5px 10px}.result-block .dict-pos{margin-right:5px}.external-translators{margin-bottom:3px;padding:0;display:flex;flex-wrap:wrap}.external-translators>div{margin:0 5px 5px 0}.quick-links a{margin:0 5px 5px 0}#popper-container{width:250px;max-width:100%;position:absolute;left:0;top:0;z-index:9999999998;touch-action:none;transition:opacity .2s;background-color:#f6f7f9}.bp5-dark #popper-container{background-color:#252a31}#popper-container.show{opacity:1;pointer-events:auto;-moz-user-select:auto;user-select:auto}#popper-container,#popper-container[data-popper-reference-hidden=true]{opacity:0;pointer-events:none;-moz-user-select:none;user-select:none}#popper-container .drag-block{cursor:-webkit-grab;cursor:grab}#popper-container.pin{position:fixed}#popper-container.pin .arrow{display:none}#popper-container .arrow,#popper-container .arrow::before{position:absolute;width:8px;height:8px;z-index:-1}#popper-container .arrow::before{content:"";transform:rotate(45deg);background:#f6f7f9}.bp5-dark #popper-container .arrow::before{background-color:#252a31}#popper-container .arrow{display:none}#popper-container.show[data-popper-placement]:not([data-popper-reference-hidden=true]) .arrow{display:block}#popper-container[data-popper-placement^=top] .arrow{bottom:-5px}#popper-container[data-popper-placement^=top] .arrow::before{border-right:1px solid #d1d1d1;border-bottom:1px solid #d1d1d1}#popper-container[data-popper-placement^=bottom] .arrow{top:-5px}#popper-container[data-popper-placement^=bottom] .arrow::before{border-left:1px solid #d1d1d1;border-top:1px solid #d1d1d1}#popper-container[data-popper-placement^=left] .arrow{right:-5px}#popper-container[data-popper-placement^=left] .arrow::before{border-right:1px solid #d1d1d1;border-top:1px solid #d1d1d1}#popper-container[data-popper-placement^=right] .arrow{left:-5px}#popper-container[data-popper-placement^=right] .arrow::before{border-left:1px solid #d1d1d1;border-bottom:1px solid #d1d1d1}#translate-btn{display:none;position:absolute;z-index:9999999999;left:0;top:0}#translate-btn .bp5-button{padding:2px;min-width:0;min-height:0}#translate-btn .btn-icon{width:18px;height:18px;background-image:url(chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/logo.png);background-size:contain}.bp5-dark #translate-btn .btn-icon{background-image:url(chrome-extension://ikhdkkncnoglghljlkmcimlnlhkeamad/logowhite36.png)}#translate-btn.show{display:block}.translate-type-selector .bp5-label{display:inline}.translate-type-selector .bp5-radio{margin-bottom:0}#ocr-container{position:fixed;z-index:99999999999999;left:0;top:0;right:0;bottom:0}#ocr-container .toolbar{display:none;position:absolute;z-index:1}#ocr-container img{max-width:100%}#app{cursor:default}.switch-pin{flex-shrink:0;cursor:pointer}.switch-pin .bp5-icon-pin{transition:transform .2s,color .2s;transform:rotate(-45deg)}.pin .switch-pin .bp5-icon-pin{transform:rotate(-70deg)}.cut-btn{margin-left:2px}.app-toaster-container{position:fixed !important;z-index:9999999999 !important}.app-toaster-container .bp5-toast{min-width:auto}#web-trs-panel .app-toaster-container{padding-right:0;padding-left:0}#web-trs-panel .page-trs-form-group{margin:0 0 0 0;align-items:center}#web-trs-panel .page-trs-form-group>label{width:70px}</style><div id="root" dir="ltr"><div id="app"><div id="translate-btn" style=""><button type="button" class="bp5-button"><span class="btn-icon"></span></button></div><div id="popper-container" class="bp5-elevation-4" style="width: 1013.56px; transform: translate(0px, 0px);"><div id="translate-panel" class="size-small"><div class="fixed"><div class="header"><div class="left"><div class="switch-pin"><button type="button" class="bp5-button bp5-minimal bp5-small"><span aria-hidden="true" class="bp5-icon bp5-icon-pin"><svg data-icon="pin" height="14" role="img" viewBox="0 0 16 16" width="14"><path d="M9.41.92c-.51.51-.41 1.5.15 2.56L4.34 7.54C2.8 6.48 1.45 6.05.92 6.58l3.54 3.54-3.54 4.95 4.95-3.54 3.54 3.54c.53-.53.1-1.88-.96-3.42l4.06-5.22c1.06.56 2.04.66 2.55.15L9.41.92z" fill-rule="evenodd"></path></svg></span></button></div><button type="button" title="图片翻译" class="bp5-button bp5-minimal bp5-small"><span aria-hidden="true" class="bp5-icon bp5-icon-media"><svg data-icon="media" height="14" role="img" viewBox="0 0 16 16" width="14"><path d="M11.99 6.99c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm3-5h-14c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h14c.55 0 1-.45 1-1v-10c0-.55-.45-1-1-1zm-1 9l-5-3-1 2-3-4-3 5v-7h12v7z" fill-rule="evenodd"></path></svg></span></button><button type="button" title="语音翻译" class="bp5-button bp5-minimal bp5-small"><span class="bp5-icon"><svg version="1.1" id="Capa_1" width="14" height="14" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 490.9 490.9" xml:space="preserve"><g><g><path d="M245.5,322.9c53,0,96.2-43.2,96.2-96.2V96.2c0-53-43.2-96.2-96.2-96.2s-96.2,43.2-96.2,96.2v130.5 C149.3,279.8,192.5,322.9,245.5,322.9z M173.8,96.2c0-39.5,32.2-71.7,71.7-71.7s71.7,32.2,71.7,71.7v130.5 c0,39.5-32.2,71.7-71.7,71.7s-71.7-32.2-71.7-71.7V96.2z"></path><path d="M94.4,214.5c-6.8,0-12.3,5.5-12.3,12.3c0,85.9,66.7,156.6,151.1,162.8v76.7h-63.9c-6.8,0-12.3,5.5-12.3,12.3 s5.5,12.3,12.3,12.3h152.3c6.8,0,12.3-5.5,12.3-12.3s-5.5-12.3-12.3-12.3h-63.9v-76.7c84.4-6.3,151.1-76.9,151.1-162.8 c0-6.8-5.5-12.3-12.3-12.3s-12.3,5.5-12.3,12.3c0,76.6-62.3,138.9-138.9,138.9s-138.9-62.3-138.9-138.9 C106.6,220,101.2,214.5,94.4,214.5z"></path></g></g></svg></span></button></div><div class="drag-block" title="按住不放可以拖动"></div><div class="right"><div style="font-size: 0px; position: relative;"><button type="button" title="你有 2 条未读消息" class="bp5-button bp5-minimal bp5-small"><span aria-hidden="true" class="bp5-icon bp5-icon-notifications"><svg data-icon="notifications" height="14" role="img" viewBox="0 0 16 16" width="14"><path d="M8 16c1.1 0 2-.9 2-2H6c0 1.1.9 2 2 2zm6-5c-.55 0-1-.45-1-1V6c0-2.43-1.73-4.45-4.02-4.9 0-.04.02-.06.02-.1 0-.55-.45-1-1-1S7 .45 7 1c0 .04.02.06.02.1A4.992 4.992 0 003 6v4c0 .55-.45 1-1 1s-1 .45-1 1 .45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1z" fill-rule="evenodd"></path></svg></span></button><div style="position: absolute; background: rgb(243, 1, 1); width: 6px; height: 6px; border-radius: 3px; right: 3px; top: 1px;"></div></div><button type="button" disabled="" title="添加到收藏夹" class="bp5-button bp5-disabled bp5-minimal bp5-small" tabindex="-1"><span aria-hidden="true" class="bp5-icon bp5-icon-star-empty"><svg data-icon="star-empty" height="14" role="img" viewBox="0 0 16 16" width="14"><path d="M16 6.11l-5.53-.84L8 0 5.53 5.27 0 6.11l4 4.1L3.06 16 8 13.27 12.94 16 12 10.21l4-4.1zM4.91 13.2l.59-3.62L3 7.02l3.45-.53L8 3.2l1.55 3.29 3.45.53-2.5 2.56.59 3.62L8 11.49 4.91 13.2z" fill-rule="evenodd"></path></svg></span></button><button type="button" class="bp5-button bp5-minimal bp5-small settings" title="快捷设置"><span aria-hidden="true" class="bp5-icon bp5-icon-cog"><svg data-icon="cog" height="14" role="img" viewBox="0 0 16 16" width="14"><path d="M15.19 6.39h-1.85c-.11-.37-.27-.71-.45-1.04l1.36-1.36c.31-.31.31-.82 0-1.13l-1.13-1.13a.803.803 0 00-1.13 0l-1.36 1.36c-.33-.17-.67-.33-1.04-.44V.79c0-.44-.36-.8-.8-.8h-1.6c-.44 0-.8.36-.8.8v1.86c-.39.12-.75.28-1.1.47l-1.3-1.3c-.3-.3-.79-.3-1.09 0L1.82 2.91c-.3.3-.3.79 0 1.09l1.3 1.3c-.2.34-.36.7-.48 1.09H.79c-.44 0-.8.36-.8.8v1.6c0 .44.36.8.8.8h1.85c.11.37.27.71.45 1.04l-1.36 1.36c-.31.31-.31.82 0 1.13l1.13 1.13c.31.31.82.31 1.13 0l1.36-1.36c.33.18.67.33 1.04.44v1.86c0 .44.36.8.8.8h1.6c.44 0 .8-.36.8-.8v-1.86c.39-.12.75-.28 1.1-.47l1.3 1.3c.3.3.79.3 1.09 0l1.09-1.09c.3-.3.3-.79 0-1.09l-1.3-1.3c.19-.35.36-.71.48-1.1h1.85c.44 0 .8-.36.8-.8v-1.6a.816.816 0 00-.81-.79zm-7.2 4.6c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z" fill-rule="evenodd"></path></svg></span></button><button type="button" title="关闭(Esc)" class="bp5-button bp5-minimal bp5-small"><span aria-hidden="true" class="bp5-icon bp5-icon-cross"><svg data-icon="cross" height="18" role="img" viewBox="0 0 16 16" width="18"><path d="M9.41 8l3.29-3.29c.19-.18.3-.43.3-.71a1.003 1.003 0 00-1.71-.71L8 6.59l-3.29-3.3a1.003 1.003 0 00-1.42 1.42L6.59 8 3.3 11.29c-.19.18-.3.43-.3.71a1.003 1.003 0 001.71.71L8 9.41l3.29 3.29c.18.19.43.3.71.3a1.003 1.003 0 00.71-1.71L9.41 8z" fill-rule="evenodd"></path></svg></span></button></div></div><div class="bp5-collapse"><div class="bp5-collapse-body" aria-hidden="true"><div class="quick-settings bp5-card bp5-elevation-0"><div><span aria-controls="listbox-0" aria-expanded="false" aria-haspopup="listbox" class="lang-select bp5-popover-target" role="combobox"><button type="button" class="bp5-button bp5-small"><span class="bp5-button-text">自动检测</span><span aria-hidden="true" class="bp5-icon bp5-icon-caret-down"><svg data-icon="caret-down" height="16" role="img" viewBox="0 0 16 16" width="16"><path d="M12 6.5c0-.28-.22-.5-.5-.5h-7a.495.495 0 00-.37.83l3.5 4c.09.1.22.17.37.17s.28-.07.37-.17l3.5-4c.08-.09.13-.2.13-.33z" fill-rule="evenodd"></path></svg></span></button></span><span aria-hidden="true" class="bp5-icon bp5-icon-arrow-right" style="margin: 0px 10px;"><svg data-icon="arrow-right" height="12" role="img" viewBox="0 0 16 16" width="12"><path d="M14.7 7.29l-5-5a.965.965 0 00-.71-.3 1.003 1.003 0 00-.71 1.71l3.29 3.29H1.99c-.55 0-1 .45-1 1s.45 1 1 1h9.59l-3.29 3.29a1.003 1.003 0 001.42 1.42l5-5c.18-.18.29-.43.29-.71s-.12-.52-.3-.7z" fill-rule="evenodd"></path></svg></span><span aria-controls="listbox-1" aria-expanded="false" aria-haspopup="listbox" class="lang-select bp5-popover-target" role="combobox"><button type="button" class="bp5-button bp5-small"><span class="bp5-button-text">中文(简体)</span><span aria-hidden="true" class="bp5-icon bp5-icon-caret-down"><svg data-icon="caret-down" height="16" role="img" viewBox="0 0 16 16" width="16"><path d="M12 6.5c0-.28-.22-.5-.5-.5h-7a.495.495 0 00-.37.83l3.5 4c.09.1.22.17.37.17s.28-.07.37-.17l3.5-4c.08-.09.13-.2.13-.33z" fill-rule="evenodd"></path></svg></span></button></span></div><div><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox" checked=""><span class="bp5-control-indicator"></span>谷歌</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox" checked=""><span class="bp5-control-indicator"></span>DeepL</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>ChatGPT</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>Yandex</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>百度</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>百度(专业版)</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>腾讯</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>彩云</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>阿里</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>阿里(专业版)</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>有道</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>火山</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>必应词典</label><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>搜狗</label></div><div><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>自动朗读</label><span aria-expanded="false" aria-haspopup="true" class="bp5-popover-target"><label class="bp5-control bp5-checkbox bp5-disabled bp5-inline"><input disabled="" tabindex="0" type="checkbox"><span class="bp5-control-indicator"></span>自动复制</label></span></div><div class="bp5-radio-group"><label class="bp5-control bp5-radio bp5-inline"><input name="Blueprint5.RadioGroup-0" type="radio" value="small" checked=""><span class="bp5-control-indicator"></span>小</label><label class="bp5-control bp5-radio bp5-inline"><input name="Blueprint5.RadioGroup-0" type="radio" value="middle"><span class="bp5-control-indicator"></span>中</label><label class="bp5-control bp5-radio bp5-inline"><input name="Blueprint5.RadioGroup-0" type="radio" value="large"><span class="bp5-control-indicator"></span>大</label></div><div><label class="bp5-control bp5-checkbox bp5-inline"><input type="checkbox"><span class="bp5-control-indicator"></span>显示文本框</label><label class="bp5-control bp5-checkbox bp5-inline" style="margin-right: 0px;"><input type="checkbox"><span class="bp5-control-indicator"></span>鼠标悬浮取词</label></div><a class="bp5-text-small">打开完整设置</a><a class="bp5-text-small" style="margin-left: 15px;"><span aria-hidden="true" class="bp5-icon bp5-icon-crown" style="position: relative; top: -1px;"><svg data-icon="crown" height="14" role="img" viewBox="0 0 16 16" width="14"><path d="M2 6l3 2 3-4 3 4 3-2-1 6H3L2 6zm6-5a1 1 0 110 2 1 1 0 010-2zM1 3a1 1 0 110 2 1 1 0 010-2zm14 0a1 1 0 110 2 1 1 0 010-2zM3 13h10v2H3v-2z" fill-rule="evenodd"></path></svg></span> 开通会员</a></div></div></div></div><div class="body"><p>请输入需要翻译的文本。</p></div></div><div class="arrow"></div></div><div id="web-trs-panel"></div></div></div></template></div></div></html>